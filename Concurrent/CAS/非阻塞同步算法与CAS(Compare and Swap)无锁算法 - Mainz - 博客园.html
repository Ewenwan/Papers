<!DOCTYPE html>
<!-- saved from url=(0044)https://www.cnblogs.com/Mainz/p/3546347.html -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="referrer" content="origin">
    <title>非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园</title>
<meta property="og:description" content="锁（lock）的代价锁是用来做并发最简单的方式，当然其代价也是最高的。内核态的锁的时候需要操作系统进行一次上下文切换，加锁、释放锁会导致比较多的上下文切换和调度延时，等待锁的线程会被挂起直至锁释放。在">
    <link type="text/css" rel="stylesheet" href="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/blog-common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/bundle-ClearGertrude.css">
<link type="text/css" rel="stylesheet" href="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/31859.css">
<link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/bundle-ClearGertrude-mobile.css">
    <link title="RSS" type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/Mainz/rss">
    <link title="RSD" type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/Mainz/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/Mainz/wlwmanifest.xml">
    <script async="" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/analytics.js.下载"></script><script src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/jquery-2.2.0.min.js.下载"></script>
    <script>var currentBlogId=31859;var currentBlogApp='Mainz',cb_enable_mathjax=false;var isLogined=false;</script>
    <script src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/blog-common.js.下载" type="text/javascript"></script>
<link rel="preload" href="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/f.txt" as="script"><script type="text/javascript" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/f.txt"></script><script src="https://securepubads.g.doubleclick.net/gpt/pubads_impl_291.js" async=""></script></head>
<body class="vsc-initialized" style="">
<a name="top"></a>

<div id="page_begin_html"><script type="text/javascript">window['__document_write_ajax_callbacks__']['4']();</script><script type="text/javascript">window['__document_write_ajax_callbacks__']['1']();</script>
<script type="text/javascript">window['__document_write_ajax_callbacks__']['5']();</script><script type="text/javascript">window['__document_write_ajax_callbacks__']['2']();</script>
<script type="text/javascript">window['__document_write_ajax_callbacks__']['6']();</script><script type="text/javascript">window['__document_write_ajax_callbacks__']['3']();</script></div><script>load_page_begin_html();</script>

<div id="header">
<h1><a id="Header1_HeaderTitle" class="headermaintitle" href="https://www.cnblogs.com/Mainz/">{var x NullPointerException}</a></h1>
<ul id="custom_nav"><li><a href="http://www.cnblogs.com/Mainz/">list</a></li><li><a href="http://www.cnblogs.com/Mainz/archive/2008/02/21/1076178.html"> about</a></li><li><a href="http://space.cnblogs.com/msg/send/Mainz">contact</a></li></ul><p id="tagline" style=""><font size="1">mainz's blog</font></p></div>
<div id="main">
	
        <div id="post_detail">
	<div class="post">
		<h2>
			<a id="cb_post_title_url" href="https://www.cnblogs.com/Mainz/p/3546347.html">非阻塞同步算法与CAS(Compare and Swap)无锁算法</a>
		</h2>
		<div class="postText"><div id="cnblogs_post_body" class="blogpost-body"><h4>锁（lock）的代价</h4>
<p>锁是用来做并发最简单的方式，当然其代价也是最高的。内核态的锁的时候需要操作系统进行一次上下文切换，加锁、释放锁会导致比较多的上下文切换和调度延时，等待锁的线程会被挂起直至锁释放。在上下文切换的时候，cpu之前缓存的指令和数据都将失效，对性能有很大的损失。操作系统对多线程的锁进行判断就像两姐妹在为一个玩具在争吵，然后操作系统就是能决定他们谁能拿到玩具的父母，这是很慢的。用户态的锁虽然避免了这些问题，但是其实它们只是在没有真实的竞争时才有效。</p>
<p>Java在JDK1.5之前都是靠synchronized关键字保证同步的，这种通过使用一致的锁定协议来协调对共享状态的访问，可以确保无论哪个线程持有守护变量的锁，都采用独占的方式来访问这些变量，如果出现多个线程同时访问锁，那第一些线线程将被挂起，当线程恢复执行时，必须等待其它线程执行完他们的时间片以后才能被调度执行，在挂起和恢复执行过程中存在着很大的开销。锁还存在着其它一些缺点，当一个线程正在等待锁时，它不能做任何事。如果一个线程在持有锁的情况下被延迟执行，那么所有需要这个锁的线程都无法执行下去。如果被阻塞的线程优先级高，而持有锁的线程优先级低，将会导致优先级反转(Priority Inversion)。</p>
<h4>乐观锁与悲观锁</h4>
<p>独占锁是一种悲观锁，synchronized就是一种独占锁，它假设最坏的情况，并且只有在确保其它线程不会造成干扰的情况下执行，会导致其它所有需要锁的线程挂起，等待持有锁的线程释放锁。而另一个更加有效的锁就是乐观锁。所谓乐观锁就是，每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。</p>
<h4>volatile的问题</h4>
<p>与锁相比，volatile变量是一和更轻量级的同步机制，因为在使用这些变量时不会发生上下文切换和线程调度等操作，但是volatile变量也存在一些局限：不能用于构建原子的复合操作，因此当一个变量依赖旧值时就不能使用volatile变量。（参考：<a href="http://www.cnblogs.com/lucifer1982/archive/2008/03/23/1116981.html" target="_blank">谈谈volatiile</a>）</p>
<p><strong>volatile只能保证变量对各个线程的可见性，但不能保证原子性</strong>。为什么？见我的另外一篇文章：《<a href="http://www.cnblogs.com/Mainz/p/3556430.html" target="_blank">为什么volatile不能保证原子性而Atomic可以？</a>》</p>
<h4>Java中的原子操作( atomic operations)</h4>
<p>原子操作指的是在一步之内就完成而且不能被中断。原子操作在多线程环境中是线程安全的，无需考虑同步的问题。在java中，下列操作是原子操作：</p>
<ul>
<li>all assignments of primitive types except for long and double</li>
<li>all assignments of references</li>
<li>all operations of java.concurrent.Atomic* classes</li>
<li>all assignments to volatile longs and doubles</li>
</ul>
<p>问题来了，为什么long型赋值不是原子操作呢？例如：</p>
<div><div id="highlighter_402031" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">long</code> <code class="java plain">foo = 65465498L;</code></div></div></td></tr></tbody></table></div></div>
<p>实时上java会分两步写入这个long变量，先写32位，再写后32位。这样就线程不安全了。如果改成下面的就线程安全了：</p>
<div><div id="highlighter_285580" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">private</code> <code class="java keyword">volatile</code> <code class="java keyword">long</code> <code class="java plain">foo;</code></div></div></td></tr></tbody></table></div></div>
<p>因为volatile内部已经做了synchronized.</p>
<h4>CAS无锁算法</h4>
<p>要实现无锁（lock-free）的非阻塞算法有多种实现方法，其中<a href="http://en.wikipedia.org/wiki/Compare-and-swap" target="_blank">CAS（比较与交换，Compare and swap）</a>是一种有名的无锁算法。CAS, CPU指令，在大多数处理器架构，包括IA32、Space中采用的都是CAS指令，CAS的语义是“我认为V的值应该为A，如果是，那么将V的值更新为B，否则不修改并告诉V的值实际为多少”，CAS是项<strong>乐观锁</strong>技术，当多个线程尝试使用CAS同时更新同一个变量时，只有其中一个线程能更新变量的值，而其它线程都失败，失败的线程并不会被挂起，而是被告知这次竞争中失败，并可以再次尝试。CAS有3个操作数，内存值V，旧的预期值A，要修改的新值B。当且仅当预期值A和内存值V相同时，将内存值V修改为B，否则什么都不做。CAS无锁算法的C实现如下：</p>
<div><div id="highlighter_999210" class="syntaxhighlighter  csharp"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="csharp keyword">int</code> <code class="csharp plain">compare_and_swap (</code><code class="csharp keyword">int</code><code class="csharp plain">* reg, </code><code class="csharp keyword">int</code> <code class="csharp plain">oldval, </code><code class="csharp keyword">int</code> <code class="csharp plain">newval) </code></div><div class="line number2 index1 alt1"><code class="csharp plain">{</code></div><div class="line number3 index2 alt2"><code class="csharp spaces">&nbsp;&nbsp;</code><code class="csharp plain">ATOMIC();</code></div><div class="line number4 index3 alt1"><code class="csharp spaces">&nbsp;&nbsp;</code><code class="csharp keyword">int</code> <code class="csharp plain">old_reg_val = *reg;</code></div><div class="line number5 index4 alt2"><code class="csharp spaces">&nbsp;&nbsp;</code><code class="csharp keyword">if</code> <code class="csharp plain">(old_reg_val == oldval) </code></div><div class="line number6 index5 alt1"><code class="csharp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="csharp plain">*reg = newval;</code></div><div class="line number7 index6 alt2"><code class="csharp spaces">&nbsp;&nbsp;</code><code class="csharp plain">END_ATOMIC();</code></div><div class="line number8 index7 alt1"><code class="csharp spaces">&nbsp;&nbsp;</code><code class="csharp keyword">return</code> <code class="csharp plain">old_reg_val;</code></div><div class="line number9 index8 alt2"><code class="csharp plain">}</code></div></div></td></tr></tbody></table></div></div>
<h4>CAS（乐观锁算法）的基本假设前提</h4>
<p>CAS比较与交换的伪代码可以表示为：</p>
<p>do{&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 备份旧数据；&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 基于旧数据构造新数据；&nbsp; <br>}while(!CAS( 内存地址，备份的旧数据，新数据 ))&nbsp;&nbsp; </p>
<p><a href="https://images0.cnblogs.com/blog/28306/201402/191145372245230.png"><img style="display: inline; border-width: 0px;" title="ConcurrencyCAS" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/191145387966044.png" alt="ConcurrencyCAS" width="320" height="171" border="0"></a>&nbsp; </p>
<p>（上图的解释：CPU去更新一个值，但如果想改的值不再是原来的值，操作就失败，因为很明显，有其它操作先改变了这个值。）</p>
<p>就是指当两者进行比较时，如果相等，则证明共享数据没有被修改，替换成新值，然后继续往下运行；如果不相等，说明共享数据已经被修改，放弃已经所做的操作，然后重新执行刚才的操作。容易看出 CAS 操作是基于共享数据不会被修改的假设，采用了类似于数据库的 commit-retry 的模式。当同步冲突出现的机会很少时，这种假设能带来较大的性能提升。</p>
<h4>CAS的开销（CPU Cache Miss problem）</h4>
<p>前面说过了，CAS（比较并交换）是CPU指令级的操作，只有一步原子操作，所以非常快。而且CAS避免了请求操作系统来裁定锁的问题，不用麻烦操作系统，直接在CPU内部就搞定了。但CAS就没有开销了吗？不！有cache miss的情况。这个问题比较复杂，首先需要了解CPU的硬件体系结构：</p>
<p><a href="https://images0.cnblogs.com/blog/28306/201402/191145402051274.png"><img style="display: inline; border-width: 0px;" title="2014-02-19_11h35_45" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/191145414444218.png" alt="2014-02-19_11h35_45" width="562" height="480" border="0"></a> </p>
<p>上图可以看到一个8核CPU计算机系统，每个CPU有cache（CPU内部的高速缓存，寄存器），管芯内还带有一个互联模块，使管芯内的两个核可以互相通信。在图中央的系统互联模块可以让四个管芯相互通信，并且将管芯与主存连接起来。数据以“缓存线”为单位在系统中传输，“缓存线”对应于内存中一个 2 的幂大小的字节块，大小通常为 32 到 256 字节之间。当 CPU 从内存中读取一个变量到它的寄存器中时，必须首先将包含了该变量的缓存线读取到 CPU 高速缓存。同样地，CPU 将寄存器中的一个值存储到内存时，不仅必须将包含了该值的缓存线读到 CPU 高速缓存，还必须确保没有其他 CPU 拥有该缓存线的拷贝。</p>
<p>比如，如果 CPU0 在对一个变量执行“比较并交换”（CAS）操作，而该变量所在的缓存线在 CPU7 的高速缓存中，就会发生以下经过简化的事件序列：</p>
<ul>
<li>CPU0 检查本地高速缓存，没有找到缓存线。 </li>
<li>请求被转发到 CPU0 和 CPU1 的互联模块，检查 CPU1 的本地高速缓存，没有找到缓存线。 </li>
<li>请求被转发到系统互联模块，检查其他三个管芯，得知缓存线被 CPU6和 CPU7 所在的管芯持有。 </li>
<li>请求被转发到 CPU6 和 CPU7 的互联模块，检查这两个 CPU 的高速缓存，在 CPU7 的高速缓存中找到缓存线。 </li>
<li>CPU7 将缓存线发送给所属的互联模块，并且刷新自己高速缓存中的缓存线。 </li>
<li>CPU6 和 CPU7 的互联模块将缓存线发送给系统互联模块。 </li>
<li>系统互联模块将缓存线发送给 CPU0 和 CPU1 的互联模块。 </li>
<li>CPU0 和 CPU1 的互联模块将缓存线发送给 CPU0 的高速缓存。 </li>
<li>CPU0 现在可以对高速缓存中的变量执行 CAS 操作了 </li>

</ul>
<p>以上是刷新不同CPU缓存的开销。最好情况下的 CAS 操作消耗大概 40 纳秒，超过 60 个时钟周期。这里的“最好情况”是指对某一个变量执行 CAS 操作的 CPU 正好是最后一个操作该变量的CPU，所以对应的缓存线已经在 CPU 的高速缓存中了，类似地，最好情况下的锁操作（一个“round trip 对”包括获取锁和随后的释放锁）消耗超过 60 纳秒，超过 100 个时钟周期。这里的“最好情况”意味着用于表示锁的数据结构已经在获取和释放锁的 CPU 所属的高速缓存中了。锁操作比 CAS 操作更加耗时，是因深入理解并行编程 
  <br>为锁操作的数据结构中需要两个原子操作。缓存未命中消耗大概 140 纳秒，超过 200 个时钟周期。需要在存储新值时查询变量的旧值的 CAS 操作，消耗大概 300 纳秒，超过 500 个时钟周期。想想这个，在执行一次 CAS 操作的时间里，CPU 可以执行 500 条普通指令。这表明了细粒度锁的局限性。</p>
<p>以下是cache miss cas 和lock的性能对比： </p>
<p><a href="https://images0.cnblogs.com/blog/28306/201402/191145426722461.png"><img style="display: inline; border-width: 0px;" title="2014-02-19_11h43_23" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/191145436475092.png" alt="2014-02-19_11h43_23" width="320" height="224" border="0"></a> </p>
<h4>JVM对CAS的支持：AtomicInt, AtomicLong.incrementAndGet()</h4>
<p>在JDK1.5之前，如果不编写明确的代码就无法执行CAS操作，在JDK1.5中引入了底层的支持，在int、long和对象的引用等类型上都公开了CAS的操作，并且JVM把它们编译为底层硬件提供的最有效的方法，在运行CAS的平台上，运行时把它们编译为相应的机器指令，如果处理器/CPU不支持CAS指令，那么JVM将使用自旋锁。因此，值得注意的是，<strong>CAS解决方案与平台/编译器紧密相关（比如x86架构下其对应的汇编指令是lock cmpxchg，如果想要64Bit的交换，则应使用lock cmpxchg8b。在.NET中我们可以使用Interlocked.CompareExchange函数）</strong>。</p>
<p>在原子类变量中，如java.util.concurrent.atomic中的AtomicXXX，都使用了这些底层的JVM支持为数字类型的引用类型提供一种高效的CAS操作，而在java.util.concurrent中的大多数类在实现时都直接或间接的使用了这些原子变量类。</p>
<p>Java 1.6中AtomicLong.incrementAndGet()的实现源码为：</p>
<div><div id="highlighter_122304" class="syntaxhighlighter   java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_expandSource expandSource">+ View Code</a></span><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div><div class="line number166 index165 alt1">166</div><div class="line number167 index166 alt2">167</div><div class="line number168 index167 alt1">168</div><div class="line number169 index168 alt2">169</div><div class="line number170 index169 alt1">170</div><div class="line number171 index170 alt2">171</div><div class="line number172 index171 alt1">172</div><div class="line number173 index172 alt2">173</div><div class="line number174 index173 alt1">174</div><div class="line number175 index174 alt2">175</div><div class="line number176 index175 alt1">176</div><div class="line number177 index176 alt2">177</div><div class="line number178 index177 alt1">178</div><div class="line number179 index178 alt2">179</div><div class="line number180 index179 alt1">180</div><div class="line number181 index180 alt2">181</div><div class="line number182 index181 alt1">182</div><div class="line number183 index182 alt2">183</div><div class="line number184 index183 alt1">184</div><div class="line number185 index184 alt2">185</div><div class="line number186 index185 alt1">186</div><div class="line number187 index186 alt2">187</div><div class="line number188 index187 alt1">188</div><div class="line number189 index188 alt2">189</div><div class="line number190 index189 alt1">190</div><div class="line number191 index190 alt2">191</div><div class="line number192 index191 alt1">192</div><div class="line number193 index192 alt2">193</div><div class="line number194 index193 alt1">194</div><div class="line number195 index194 alt2">195</div><div class="line number196 index195 alt1">196</div><div class="line number197 index196 alt2">197</div><div class="line number198 index197 alt1">198</div><div class="line number199 index198 alt2">199</div><div class="line number200 index199 alt1">200</div><div class="line number201 index200 alt2">201</div><div class="line number202 index201 alt1">202</div><div class="line number203 index202 alt2">203</div><div class="line number204 index203 alt1">204</div><div class="line number205 index204 alt2">205</div><div class="line number206 index205 alt1">206</div><div class="line number207 index206 alt2">207</div><div class="line number208 index207 alt1">208</div><div class="line number209 index208 alt2">209</div><div class="line number210 index209 alt1">210</div><div class="line number211 index210 alt2">211</div><div class="line number212 index211 alt1">212</div><div class="line number213 index212 alt2">213</div><div class="line number214 index213 alt1">214</div><div class="line number215 index214 alt2">215</div><div class="line number216 index215 alt1">216</div><div class="line number217 index216 alt2">217</div><div class="line number218 index217 alt1">218</div><div class="line number219 index218 alt2">219</div><div class="line number220 index219 alt1">220</div><div class="line number221 index220 alt2">221</div><div class="line number222 index221 alt1">222</div><div class="line number223 index222 alt2">223</div><div class="line number224 index223 alt1">224</div><div class="line number225 index224 alt2">225</div><div class="line number226 index225 alt1">226</div><div class="line number227 index226 alt2">227</div><div class="line number228 index227 alt1">228</div><div class="line number229 index228 alt2">229</div><div class="line number230 index229 alt1">230</div><div class="line number231 index230 alt2">231</div><div class="line number232 index231 alt1">232</div><div class="line number233 index232 alt2">233</div><div class="line number234 index233 alt1">234</div><div class="line number235 index234 alt2">235</div><div class="line number236 index235 alt1">236</div><div class="line number237 index236 alt2">237</div><div class="line number238 index237 alt1">238</div><div class="line number239 index238 alt2">239</div><div class="line number240 index239 alt1">240</div><div class="line number241 index240 alt2">241</div><div class="line number242 index241 alt1">242</div><div class="line number243 index242 alt2">243</div><div class="line number244 index243 alt1">244</div><div class="line number245 index244 alt2">245</div><div class="line number246 index245 alt1">246</div><div class="line number247 index246 alt2">247</div><div class="line number248 index247 alt1">248</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java value">1</code><code class="java plain">: </code><code class="java comments">/*</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java comments">2:&nbsp; * Written by Doug Lea with assistance from members of JCP JSR-166</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java comments">3:&nbsp; * Expert Group and released to the public domain, as explained at</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java comments">4:&nbsp; * <a href="http://creativecommons.org/licenses/publicdomain">http://creativecommons.org/licenses/publicdomain</a></code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java comments">5:&nbsp; */</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java value">6</code><code class="java plain">: </code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java value">7</code><code class="java plain">: </code><code class="java keyword">package</code> <code class="java plain">java.util.concurrent.atomic;</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java value">8</code><code class="java plain">: </code><code class="java keyword">import</code> <code class="java plain">sun.misc.Unsafe;</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java value">9</code><code class="java plain">: </code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">10</code><code class="java plain">: </code><code class="java preprocessor">/**</code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">11:&nbsp; * A &lt;tt&gt;long&lt;/tt&gt; value that may be updated atomically.&nbsp; See the</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">12:&nbsp; * {@link java.util.concurrent.atomic} package specification for</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">13:&nbsp; * description of the properties of atomic variables. An</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">14:&nbsp; * &lt;tt&gt;AtomicLong&lt;/tt&gt; is used in applications such as atomically</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">15:&nbsp; * incremented sequence numbers, and cannot be used as a replacement</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">16:&nbsp; * for a {@link java.lang.Long}. However, this class does extend</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">17:&nbsp; * &lt;tt&gt;Number&lt;/tt&gt; to allow uniform access by tools and utilities that</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">18:&nbsp; * deal with numerically-based classes.</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">19:&nbsp; *</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">20:&nbsp; * @since 1.5</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">21:&nbsp; * @author Doug Lea</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">22:&nbsp; */</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">23</code><code class="java plain">: </code><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">AtomicLong </code><code class="java keyword">extends</code> <code class="java plain">Number </code><code class="java keyword">implements</code> <code class="java plain">java.io.Serializable {</code></div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">24</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">serialVersionUID = 1927816293512124184L;</code></div><div class="line number25 index24 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">25</code><code class="java plain">: </code></div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">26</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java comments">// setup to use Unsafe.compareAndSwapLong for updates</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">27</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java plain">Unsafe unsafe = Unsafe.getUnsafe();</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">28</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">valueOffset;</code></div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">29</code><code class="java plain">: </code></div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">30</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">31:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Records whether the underlying JVM supports lockless</code></div><div class="line number32 index31 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">32:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * CompareAndSet for longs. While the unsafe.CompareAndSetLong</code></div><div class="line number33 index32 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">33:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * method works in either case, some constructions should be</code></div><div class="line number34 index33 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">34:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * handled at Java level to avoid locking user-visible locks.</code></div><div class="line number35 index34 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">35:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number36 index35 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">36</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">boolean</code> <code class="java plain">VM_SUPPORTS_LONG_CAS = VMSupportsCS8();</code></div><div class="line number37 index36 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">37</code><code class="java plain">: </code></div><div class="line number38 index37 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">38</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number39 index38 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">39:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Returns whether underlying JVM supports lockless CompareAndSet</code></div><div class="line number40 index39 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">40:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * for longs. Called only once and cached in VM_SUPPORTS_LONG_CAS.</code></div><div class="line number41 index40 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">41:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number42 index41 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">42</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">native</code> <code class="java keyword">boolean</code> <code class="java plain">VMSupportsCS8();</code></div><div class="line number43 index42 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">43</code><code class="java plain">: </code></div><div class="line number44 index43 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">44</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">static</code> <code class="java plain">{</code></div><div class="line number45 index44 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">45</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number46 index45 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">46</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; valueOffset = unsafe.objectFieldOffset</code></div><div class="line number47 index46 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">47</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (AtomicLong.</code><code class="java keyword">class</code><code class="java plain">.getDeclaredField(</code><code class="java string">"value"</code><code class="java plain">));</code></div><div class="line number48 index47 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">48</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } </code><code class="java keyword">catch</code> <code class="java plain">(Exception ex) { </code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">Error(ex); }</code></div><div class="line number49 index48 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">49</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number50 index49 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">50</code><code class="java plain">: </code></div><div class="line number51 index50 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">51</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">private</code> <code class="java keyword">volatile</code> <code class="java keyword">long</code> <code class="java plain">value;</code></div><div class="line number52 index51 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">52</code><code class="java plain">: </code></div><div class="line number53 index52 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">53</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number54 index53 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">54:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Creates a new AtomicLong with the given initial value.</code></div><div class="line number55 index54 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">55:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number56 index55 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">56:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param initialValue the initial value</code></div><div class="line number57 index56 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">57:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number58 index57 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">58</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java plain">AtomicLong(</code><code class="java keyword">long</code> <code class="java plain">initialValue) {</code></div><div class="line number59 index58 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">59</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value = initialValue;</code></div><div class="line number60 index59 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">60</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number61 index60 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">61</code><code class="java plain">: </code></div><div class="line number62 index61 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">62</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number63 index62 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">63:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Creates a new AtomicLong with initial value &lt;tt&gt;0&lt;/tt&gt;.</code></div><div class="line number64 index63 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">64:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number65 index64 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">65</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java plain">AtomicLong() {</code></div><div class="line number66 index65 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">66</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number67 index66 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">67</code><code class="java plain">: </code></div><div class="line number68 index67 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">68</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number69 index68 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">69:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Gets the current value.</code></div><div class="line number70 index69 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">70:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number71 index70 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">71:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the current value</code></div><div class="line number72 index71 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">72:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number73 index72 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">73</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">get() {</code></div><div class="line number74 index73 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">74</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">value;</code></div><div class="line number75 index74 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">75</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number76 index75 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">76</code><code class="java plain">: </code></div><div class="line number77 index76 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">77</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number78 index77 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">78:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Sets to the given value.</code></div><div class="line number79 index78 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">79:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number80 index79 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">80:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param newValue the new value</code></div><div class="line number81 index80 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">81:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number82 index81 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">82</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">void</code> <code class="java plain">set(</code><code class="java keyword">long</code> <code class="java plain">newValue) {</code></div><div class="line number83 index82 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">83</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value = newValue;</code></div><div class="line number84 index83 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">84</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number85 index84 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">85</code><code class="java plain">: </code></div><div class="line number86 index85 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">86</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number87 index86 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">87:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Eventually sets to the given value.</code></div><div class="line number88 index87 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">88:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number89 index88 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">89:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param newValue the new value</code></div><div class="line number90 index89 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">90:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @since 1.6</code></div><div class="line number91 index90 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">91:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number92 index91 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">92</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">void</code> <code class="java plain">lazySet(</code><code class="java keyword">long</code> <code class="java plain">newValue) {</code></div><div class="line number93 index92 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">93</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsafe.putOrderedLong(</code><code class="java keyword">this</code><code class="java plain">, valueOffset, newValue);</code></div><div class="line number94 index93 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">94</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number95 index94 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">95</code><code class="java plain">: </code></div><div class="line number96 index95 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java value">96</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number97 index96 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">97:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically sets to the given value and returns the old value.</code></div><div class="line number98 index97 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">98:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number99 index98 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java preprocessor">99:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param newValue the new value</code></div><div class="line number100 index99 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">100:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the previous value</code></div><div class="line number101 index100 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">101:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number102 index101 alt1"><code class="java spaces">&nbsp;</code><code class="java value">102</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">getAndSet(</code><code class="java keyword">long</code> <code class="java plain">newValue) {</code></div><div class="line number103 index102 alt2"><code class="java spaces">&nbsp;</code><code class="java value">103</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">while</code> <code class="java plain">(</code><code class="java keyword">true</code><code class="java plain">) {</code></div><div class="line number104 index103 alt1"><code class="java spaces">&nbsp;</code><code class="java value">104</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">current = get();</code></div><div class="line number105 index104 alt2"><code class="java spaces">&nbsp;</code><code class="java value">105</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">if</code> <code class="java plain">(compareAndSet(current, newValue))</code></div><div class="line number106 index105 alt1"><code class="java spaces">&nbsp;</code><code class="java value">106</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">current;</code></div><div class="line number107 index106 alt2"><code class="java spaces">&nbsp;</code><code class="java value">107</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number108 index107 alt1"><code class="java spaces">&nbsp;</code><code class="java value">108</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number109 index108 alt2"><code class="java spaces">&nbsp;</code><code class="java value">109</code><code class="java plain">: </code></div><div class="line number110 index109 alt1"><code class="java spaces">&nbsp;</code><code class="java value">110</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number111 index110 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">111:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically sets the value to the given updated value</code></div><div class="line number112 index111 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">112:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * if the current value &lt;tt&gt;==&lt;/tt&gt; the expected value.</code></div><div class="line number113 index112 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">113:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number114 index113 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">114:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param expect the expected value</code></div><div class="line number115 index114 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">115:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param update the new value</code></div><div class="line number116 index115 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">116:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return true if successful. False return indicates that</code></div><div class="line number117 index116 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">117:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * the actual value was not equal to the expected value.</code></div><div class="line number118 index117 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">118:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number119 index118 alt2"><code class="java spaces">&nbsp;</code><code class="java value">119</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">boolean</code> <code class="java plain">compareAndSet(</code><code class="java keyword">long</code> <code class="java plain">expect, </code><code class="java keyword">long</code> <code class="java plain">update) {</code></div><div class="line number120 index119 alt1"><code class="java spaces">&nbsp;</code><code class="java value">120</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">unsafe.compareAndSwapLong(</code><code class="java keyword">this</code><code class="java plain">, valueOffset, expect, update);</code></div><div class="line number121 index120 alt2"><code class="java spaces">&nbsp;</code><code class="java value">121</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number122 index121 alt1"><code class="java spaces">&nbsp;</code><code class="java value">122</code><code class="java plain">: </code></div><div class="line number123 index122 alt2"><code class="java spaces">&nbsp;</code><code class="java value">123</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number124 index123 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">124:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically sets the value to the given updated value</code></div><div class="line number125 index124 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">125:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * if the current value &lt;tt&gt;==&lt;/tt&gt; the expected value.</code></div><div class="line number126 index125 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">126:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * May fail spuriously and does not provide ordering guarantees,</code></div><div class="line number127 index126 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">127:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * so is only rarely an appropriate alternative to &lt;tt&gt;compareAndSet&lt;/tt&gt;.</code></div><div class="line number128 index127 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">128:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number129 index128 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">129:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param expect the expected value</code></div><div class="line number130 index129 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">130:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param update the new value</code></div><div class="line number131 index130 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">131:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return true if successful.</code></div><div class="line number132 index131 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">132:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number133 index132 alt2"><code class="java spaces">&nbsp;</code><code class="java value">133</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">boolean</code> <code class="java plain">weakCompareAndSet(</code><code class="java keyword">long</code> <code class="java plain">expect, </code><code class="java keyword">long</code> <code class="java plain">update) {</code></div><div class="line number134 index133 alt1"><code class="java spaces">&nbsp;</code><code class="java value">134</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">unsafe.compareAndSwapLong(</code><code class="java keyword">this</code><code class="java plain">, valueOffset, expect, update);</code></div><div class="line number135 index134 alt2"><code class="java spaces">&nbsp;</code><code class="java value">135</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number136 index135 alt1"><code class="java spaces">&nbsp;</code><code class="java value">136</code><code class="java plain">: </code></div><div class="line number137 index136 alt2"><code class="java spaces">&nbsp;</code><code class="java value">137</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number138 index137 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">138:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically increments by one the current value.</code></div><div class="line number139 index138 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">139:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number140 index139 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">140:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the previous value</code></div><div class="line number141 index140 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">141:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number142 index141 alt1"><code class="java spaces">&nbsp;</code><code class="java value">142</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">getAndIncrement() {</code></div><div class="line number143 index142 alt2"><code class="java spaces">&nbsp;</code><code class="java value">143</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">while</code> <code class="java plain">(</code><code class="java keyword">true</code><code class="java plain">) {</code></div><div class="line number144 index143 alt1"><code class="java spaces">&nbsp;</code><code class="java value">144</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">current = get();</code></div><div class="line number145 index144 alt2"><code class="java spaces">&nbsp;</code><code class="java value">145</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">next = current + </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number146 index145 alt1"><code class="java spaces">&nbsp;</code><code class="java value">146</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">if</code> <code class="java plain">(compareAndSet(current, next))</code></div><div class="line number147 index146 alt2"><code class="java spaces">&nbsp;</code><code class="java value">147</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">current;</code></div><div class="line number148 index147 alt1"><code class="java spaces">&nbsp;</code><code class="java value">148</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number149 index148 alt2"><code class="java spaces">&nbsp;</code><code class="java value">149</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number150 index149 alt1"><code class="java spaces">&nbsp;</code><code class="java value">150</code><code class="java plain">: </code></div><div class="line number151 index150 alt2"><code class="java spaces">&nbsp;</code><code class="java value">151</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number152 index151 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">152:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically decrements by one the current value.</code></div><div class="line number153 index152 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">153:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number154 index153 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">154:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the previous value</code></div><div class="line number155 index154 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">155:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number156 index155 alt1"><code class="java spaces">&nbsp;</code><code class="java value">156</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">getAndDecrement() {</code></div><div class="line number157 index156 alt2"><code class="java spaces">&nbsp;</code><code class="java value">157</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">while</code> <code class="java plain">(</code><code class="java keyword">true</code><code class="java plain">) {</code></div><div class="line number158 index157 alt1"><code class="java spaces">&nbsp;</code><code class="java value">158</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">current = get();</code></div><div class="line number159 index158 alt2"><code class="java spaces">&nbsp;</code><code class="java value">159</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">next = current - </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number160 index159 alt1"><code class="java spaces">&nbsp;</code><code class="java value">160</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">if</code> <code class="java plain">(compareAndSet(current, next))</code></div><div class="line number161 index160 alt2"><code class="java spaces">&nbsp;</code><code class="java value">161</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">current;</code></div><div class="line number162 index161 alt1"><code class="java spaces">&nbsp;</code><code class="java value">162</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number163 index162 alt2"><code class="java spaces">&nbsp;</code><code class="java value">163</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number164 index163 alt1"><code class="java spaces">&nbsp;</code><code class="java value">164</code><code class="java plain">: </code></div><div class="line number165 index164 alt2"><code class="java spaces">&nbsp;</code><code class="java value">165</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number166 index165 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">166:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically adds the given value to the current value.</code></div><div class="line number167 index166 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">167:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number168 index167 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">168:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param delta the value to add</code></div><div class="line number169 index168 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">169:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the previous value</code></div><div class="line number170 index169 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">170:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number171 index170 alt2"><code class="java spaces">&nbsp;</code><code class="java value">171</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">getAndAdd(</code><code class="java keyword">long</code> <code class="java plain">delta) {</code></div><div class="line number172 index171 alt1"><code class="java spaces">&nbsp;</code><code class="java value">172</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">while</code> <code class="java plain">(</code><code class="java keyword">true</code><code class="java plain">) {</code></div><div class="line number173 index172 alt2"><code class="java spaces">&nbsp;</code><code class="java value">173</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">current = get();</code></div><div class="line number174 index173 alt1"><code class="java spaces">&nbsp;</code><code class="java value">174</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">next = current + delta;</code></div><div class="line number175 index174 alt2"><code class="java spaces">&nbsp;</code><code class="java value">175</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">if</code> <code class="java plain">(compareAndSet(current, next))</code></div><div class="line number176 index175 alt1"><code class="java spaces">&nbsp;</code><code class="java value">176</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">current;</code></div><div class="line number177 index176 alt2"><code class="java spaces">&nbsp;</code><code class="java value">177</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number178 index177 alt1"><code class="java spaces">&nbsp;</code><code class="java value">178</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number179 index178 alt2"><code class="java spaces">&nbsp;</code><code class="java value">179</code><code class="java plain">: </code></div><div class="line number180 index179 alt1"><code class="java spaces">&nbsp;</code><code class="java value">180</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number181 index180 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">181:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically increments by one the current value.</code></div><div class="line number182 index181 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">182:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number183 index182 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">183:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the updated value</code></div><div class="line number184 index183 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">184:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number185 index184 alt2"><code class="java spaces">&nbsp;</code><code class="java value">185</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">incrementAndGet() {</code></div><div class="line number186 index185 alt1"><code class="java spaces">&nbsp;</code><code class="java value">186</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number187 index186 alt2"><code class="java spaces">&nbsp;</code><code class="java value">187</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">current = get();</code></div><div class="line number188 index187 alt1"><code class="java spaces">&nbsp;</code><code class="java value">188</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">next = current + </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number189 index188 alt2"><code class="java spaces">&nbsp;</code><code class="java value">189</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">if</code> <code class="java plain">(compareAndSet(current, next))</code></div><div class="line number190 index189 alt1"><code class="java spaces">&nbsp;</code><code class="java value">190</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">next;</code></div><div class="line number191 index190 alt2"><code class="java spaces">&nbsp;</code><code class="java value">191</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number192 index191 alt1"><code class="java spaces">&nbsp;</code><code class="java value">192</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number193 index192 alt2"><code class="java spaces">&nbsp;</code><code class="java value">193</code><code class="java plain">: </code></div><div class="line number194 index193 alt1"><code class="java spaces">&nbsp;</code><code class="java value">194</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number195 index194 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">195:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically decrements by one the current value.</code></div><div class="line number196 index195 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">196:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number197 index196 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">197:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the updated value</code></div><div class="line number198 index197 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">198:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number199 index198 alt2"><code class="java spaces">&nbsp;</code><code class="java value">199</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">decrementAndGet() {</code></div><div class="line number200 index199 alt1"><code class="java spaces">&nbsp;</code><code class="java value">200</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number201 index200 alt2"><code class="java spaces">&nbsp;</code><code class="java value">201</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">current = get();</code></div><div class="line number202 index201 alt1"><code class="java spaces">&nbsp;</code><code class="java value">202</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">next = current - </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number203 index202 alt2"><code class="java spaces">&nbsp;</code><code class="java value">203</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">if</code> <code class="java plain">(compareAndSet(current, next))</code></div><div class="line number204 index203 alt1"><code class="java spaces">&nbsp;</code><code class="java value">204</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">next;</code></div><div class="line number205 index204 alt2"><code class="java spaces">&nbsp;</code><code class="java value">205</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number206 index205 alt1"><code class="java spaces">&nbsp;</code><code class="java value">206</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number207 index206 alt2"><code class="java spaces">&nbsp;</code><code class="java value">207</code><code class="java plain">: </code></div><div class="line number208 index207 alt1"><code class="java spaces">&nbsp;</code><code class="java value">208</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number209 index208 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">209:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Atomically adds the given value to the current value.</code></div><div class="line number210 index209 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">210:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></div><div class="line number211 index210 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">211:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @param delta the value to add</code></div><div class="line number212 index211 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">212:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the updated value</code></div><div class="line number213 index212 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">213:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number214 index213 alt1"><code class="java spaces">&nbsp;</code><code class="java value">214</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">addAndGet(</code><code class="java keyword">long</code> <code class="java plain">delta) {</code></div><div class="line number215 index214 alt2"><code class="java spaces">&nbsp;</code><code class="java value">215</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number216 index215 alt1"><code class="java spaces">&nbsp;</code><code class="java value">216</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">current = get();</code></div><div class="line number217 index216 alt2"><code class="java spaces">&nbsp;</code><code class="java value">217</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">long</code> <code class="java plain">next = current + delta;</code></div><div class="line number218 index217 alt1"><code class="java spaces">&nbsp;</code><code class="java value">218</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">if</code> <code class="java plain">(compareAndSet(current, next))</code></div><div class="line number219 index218 alt2"><code class="java spaces">&nbsp;</code><code class="java value">219</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">next;</code></div><div class="line number220 index219 alt1"><code class="java spaces">&nbsp;</code><code class="java value">220</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number221 index220 alt2"><code class="java spaces">&nbsp;</code><code class="java value">221</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number222 index221 alt1"><code class="java spaces">&nbsp;</code><code class="java value">222</code><code class="java plain">: </code></div><div class="line number223 index222 alt2"><code class="java spaces">&nbsp;</code><code class="java value">223</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java preprocessor">/**</code></div><div class="line number224 index223 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">224:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * Returns the String representation of the current value.</code></div><div class="line number225 index224 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">225:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * @return the String representation of the current value.</code></div><div class="line number226 index225 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">226:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</code></div><div class="line number227 index226 alt2"><code class="java spaces">&nbsp;</code><code class="java value">227</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java plain">String toString() {</code></div><div class="line number228 index227 alt1"><code class="java spaces">&nbsp;</code><code class="java value">228</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">Long.toString(get());</code></div><div class="line number229 index228 alt2"><code class="java spaces">&nbsp;</code><code class="java value">229</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number230 index229 alt1"><code class="java spaces">&nbsp;</code><code class="java value">230</code><code class="java plain">: </code></div><div class="line number231 index230 alt2"><code class="java spaces">&nbsp;</code><code class="java value">231</code><code class="java plain">: </code></div><div class="line number232 index231 alt1"><code class="java spaces">&nbsp;</code><code class="java value">232</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">int</code> <code class="java plain">intValue() {</code></div><div class="line number233 index232 alt2"><code class="java spaces">&nbsp;</code><code class="java value">233</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">(</code><code class="java keyword">int</code><code class="java plain">)get();</code></div><div class="line number234 index233 alt1"><code class="java spaces">&nbsp;</code><code class="java value">234</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number235 index234 alt2"><code class="java spaces">&nbsp;</code><code class="java value">235</code><code class="java plain">: </code></div><div class="line number236 index235 alt1"><code class="java spaces">&nbsp;</code><code class="java value">236</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">long</code> <code class="java plain">longValue() {</code></div><div class="line number237 index236 alt2"><code class="java spaces">&nbsp;</code><code class="java value">237</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">(</code><code class="java keyword">long</code><code class="java plain">)get();</code></div><div class="line number238 index237 alt1"><code class="java spaces">&nbsp;</code><code class="java value">238</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number239 index238 alt2"><code class="java spaces">&nbsp;</code><code class="java value">239</code><code class="java plain">: </code></div><div class="line number240 index239 alt1"><code class="java spaces">&nbsp;</code><code class="java value">240</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">float</code> <code class="java plain">floatValue() {</code></div><div class="line number241 index240 alt2"><code class="java spaces">&nbsp;</code><code class="java value">241</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">(</code><code class="java keyword">float</code><code class="java plain">)get();</code></div><div class="line number242 index241 alt1"><code class="java spaces">&nbsp;</code><code class="java value">242</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number243 index242 alt2"><code class="java spaces">&nbsp;</code><code class="java value">243</code><code class="java plain">: </code></div><div class="line number244 index243 alt1"><code class="java spaces">&nbsp;</code><code class="java value">244</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">public</code> <code class="java keyword">double</code> <code class="java plain">doubleValue() {</code></div><div class="line number245 index244 alt2"><code class="java spaces">&nbsp;</code><code class="java value">245</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java keyword">return</code> <code class="java plain">(</code><code class="java keyword">double</code><code class="java plain">)get();</code></div><div class="line number246 index245 alt1"><code class="java spaces">&nbsp;</code><code class="java value">246</code><code class="java plain">:&nbsp;&nbsp;&nbsp;&nbsp; }</code></div><div class="line number247 index246 alt2"><code class="java spaces">&nbsp;</code><code class="java value">247</code><code class="java plain">: </code></div><div class="line number248 index247 alt1"><code class="java spaces">&nbsp;</code><code class="java value">248</code><code class="java plain">: }</code></div></div></td></tr></tbody></table></div></div>
<p>由此可见，AtomicLong.incrementAndGet的实现用了乐观锁技术，调用了<a href="http://stackoverflow.com/questions/5574241/interesting-uses-of-sun-misc-unsafe" target="_blank">sun.misc.Unsafe</a>类库里面的 CAS算法，用CPU指令来实现无锁自增。所以，AtomicLong.incrementAndGet的自增比用synchronized的锁效率倍增。</p>
<div><div id="highlighter_913372" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">getAndIncrement() {&nbsp; </code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {&nbsp; </code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">current = get();&nbsp; </code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">next = current + </code><code class="java value">1</code><code class="java plain">;&nbsp; </code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(compareAndSet(current, next))&nbsp; </code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">current;&nbsp; </code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}&nbsp; </code></div><div class="line number8 index7 alt1"><code class="java plain">}&nbsp; </code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;</code>&nbsp;</div><div class="line number10 index9 alt1"><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">boolean</code> <code class="java plain">compareAndSet(</code><code class="java keyword">int</code> <code class="java plain">expect, </code><code class="java keyword">int</code> <code class="java plain">update) {&nbsp; </code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">unsafe.compareAndSwapInt(</code><code class="java keyword">this</code><code class="java plain">, valueOffset, expect, update);&nbsp; </code></div><div class="line number12 index11 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>
<p>下面是测试代码：可以看到用AtomicLong.incrementAndGet的性能比用synchronized高出几倍。</p>
<p><a href="https://images0.cnblogs.com/blog/28306/201402/121727088765464.png"><img style="display: inline; border-width: 0px;" title="2014-02-12_14h56_39" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/121727125108810.png" alt="2014-02-12_14h56_39" width="348" height="178" border="0"></a></p>
<div><div id="highlighter_514046" class="syntaxhighlighter collapsed  java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_expandSource expandSource">+ View Code</a></span><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div><div class="line number166 index165 alt1">166</div><div class="line number167 index166 alt2">167</div><div class="line number168 index167 alt1">168</div><div class="line number169 index168 alt2">169</div><div class="line number170 index169 alt1">170</div><div class="line number171 index170 alt2">171</div><div class="line number172 index171 alt1">172</div><div class="line number173 index172 alt2">173</div><div class="line number174 index173 alt1">174</div><div class="line number175 index174 alt2">175</div><div class="line number176 index175 alt1">176</div><div class="line number177 index176 alt2">177</div><div class="line number178 index177 alt1">178</div><div class="line number179 index178 alt2">179</div><div class="line number180 index179 alt1">180</div><div class="line number181 index180 alt2">181</div><div class="line number182 index181 alt1">182</div><div class="line number183 index182 alt2">183</div><div class="line number184 index183 alt1">184</div><div class="line number185 index184 alt2">185</div><div class="line number186 index185 alt1">186</div><div class="line number187 index186 alt2">187</div><div class="line number188 index187 alt1">188</div><div class="line number189 index188 alt2">189</div><div class="line number190 index189 alt1">190</div><div class="line number191 index190 alt2">191</div><div class="line number192 index191 alt1">192</div><div class="line number193 index192 alt2">193</div><div class="line number194 index193 alt1">194</div><div class="line number195 index194 alt2">195</div><div class="line number196 index195 alt1">196</div><div class="line number197 index196 alt2">197</div><div class="line number198 index197 alt1">198</div><div class="line number199 index198 alt2">199</div><div class="line number200 index199 alt1">200</div><div class="line number201 index200 alt2">201</div><div class="line number202 index201 alt1">202</div><div class="line number203 index202 alt2">203</div><div class="line number204 index203 alt1">204</div><div class="line number205 index204 alt2">205</div><div class="line number206 index205 alt1">206</div><div class="line number207 index206 alt2">207</div><div class="line number208 index207 alt1">208</div><div class="line number209 index208 alt2">209</div><div class="line number210 index209 alt1">210</div><div class="line number211 index210 alt2">211</div><div class="line number212 index211 alt1">212</div><div class="line number213 index212 alt2">213</div><div class="line number214 index213 alt1">214</div><div class="line number215 index214 alt2">215</div><div class="line number216 index215 alt1">216</div><div class="line number217 index216 alt2">217</div><div class="line number218 index217 alt1">218</div><div class="line number219 index218 alt2">219</div><div class="line number220 index219 alt1">220</div><div class="line number221 index220 alt2">221</div><div class="line number222 index221 alt1">222</div><div class="line number223 index222 alt2">223</div><div class="line number224 index223 alt1">224</div><div class="line number225 index224 alt2">225</div><div class="line number226 index225 alt1">226</div><div class="line number227 index226 alt2">227</div><div class="line number228 index227 alt1">228</div><div class="line number229 index228 alt2">229</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">package</code> <code class="java plain">console;</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="java keyword">import</code> <code class="java plain">java.util.concurrent.atomic.AtomicLong;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">main {</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param args</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">main(String[] args) {</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">"START -- "</code><code class="java plain">);</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">calc();</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">calcSynchro();</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">calcAtomic();</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">testThreadsSync();</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">testThreadsAtomic();</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">testThreadsSync2();</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">testThreadsAtomic2();</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">"-- FINISHED "</code><code class="java plain">);</code></div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">calc() {</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">stopwatch sw = </code><code class="java keyword">new</code> <code class="java plain">stopwatch();</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.start();</code></div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">val = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(val &lt; 10000000L) {</code></div><div class="line number32 index31 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">val++;</code></div><div class="line number33 index32 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number34 index33 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.stop();</code></div><div class="line number35 index34 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">milSecds = sw.getElapsedTime();</code></div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">" calc() elapsed (ms): "</code> <code class="java plain">+ milSecds);</code></div><div class="line number38 index37 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number39 index38 alt2">&nbsp;</div><div class="line number40 index39 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">calcSynchro() {</code></div><div class="line number41 index40 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">stopwatch sw = </code><code class="java keyword">new</code> <code class="java plain">stopwatch();</code></div><div class="line number42 index41 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.start();</code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">val = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number45 index44 alt2">&nbsp;</div><div class="line number46 index45 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(val &lt; 10000000L) {</code></div><div class="line number47 index46 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">synchronized</code> <code class="java plain">(main.</code><code class="java keyword">class</code><code class="java plain">) {</code></div><div class="line number48 index47 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">val++;</code></div><div class="line number49 index48 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number50 index49 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number51 index50 alt2">&nbsp;</div><div class="line number52 index51 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.stop();</code></div><div class="line number53 index52 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">milSecds = sw.getElapsedTime();</code></div><div class="line number54 index53 alt1">&nbsp;</div><div class="line number55 index54 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">" calcSynchro() elapsed (ms): "</code> <code class="java plain">+ milSecds);</code></div><div class="line number56 index55 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number57 index56 alt2">&nbsp;</div><div class="line number58 index57 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">calcAtomic() {</code></div><div class="line number59 index58 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">stopwatch sw = </code><code class="java keyword">new</code> <code class="java plain">stopwatch();</code></div><div class="line number60 index59 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.start();</code></div><div class="line number61 index60 alt2">&nbsp;</div><div class="line number62 index61 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicLong val = </code><code class="java keyword">new</code> <code class="java plain">AtomicLong(</code><code class="java value">0</code><code class="java plain">);</code></div><div class="line number63 index62 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(val.incrementAndGet() &lt; 10000000L) {</code></div><div class="line number64 index63 alt1">&nbsp;</div><div class="line number65 index64 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number66 index65 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.stop();</code></div><div class="line number67 index66 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">milSecds = sw.getElapsedTime();</code></div><div class="line number68 index67 alt1">&nbsp;</div><div class="line number69 index68 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">" calcAtomic() elapsed (ms): "</code> <code class="java plain">+ milSecds);</code></div><div class="line number70 index69 alt1">&nbsp;</div><div class="line number71 index70 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number72 index71 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number73 index72 alt2">&nbsp;</div><div class="line number74 index73 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">testThreadsSync(){</code></div><div class="line number75 index74 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number76 index75 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">stopwatch sw = </code><code class="java keyword">new</code> <code class="java plain">stopwatch();</code></div><div class="line number77 index76 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.start();</code></div><div class="line number78 index77 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number79 index78 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread t1 = </code><code class="java keyword">new</code> <code class="java plain">Thread(</code><code class="java keyword">new</code> <code class="java plain">LoopSync());</code></div><div class="line number80 index79 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">t1.start();</code></div><div class="line number81 index80 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number82 index81 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread t2 = </code><code class="java keyword">new</code> <code class="java plain">Thread(</code><code class="java keyword">new</code> <code class="java plain">LoopSync());</code></div><div class="line number83 index82 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">t2.start();</code></div><div class="line number84 index83 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number85 index84 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(t1.isAlive() || t2.isAlive()) {</code></div><div class="line number86 index85 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number87 index86 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number88 index87 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number89 index88 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.stop();</code></div><div class="line number90 index89 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">milSecds = sw.getElapsedTime();</code></div><div class="line number91 index90 alt2">&nbsp;</div><div class="line number92 index91 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">" testThreadsSync() 1 thread elapsed (ms): "</code> <code class="java plain">+ milSecds);</code></div><div class="line number93 index92 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number94 index93 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number95 index94 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number96 index95 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">testThreadsAtomic(){</code></div><div class="line number97 index96 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number98 index97 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">stopwatch sw = </code><code class="java keyword">new</code> <code class="java plain">stopwatch();</code></div><div class="line number99 index98 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.start();</code></div><div class="line number100 index99 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number101 index100 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread t1 = </code><code class="java keyword">new</code> <code class="java plain">Thread(</code><code class="java keyword">new</code> <code class="java plain">LoopAtomic());</code></div><div class="line number102 index101 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">t1.start();</code></div><div class="line number103 index102 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number104 index103 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread t2 = </code><code class="java keyword">new</code> <code class="java plain">Thread(</code><code class="java keyword">new</code> <code class="java plain">LoopAtomic());</code></div><div class="line number105 index104 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">t2.start();</code></div><div class="line number106 index105 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number107 index106 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(t1.isAlive() || t2.isAlive()) {</code></div><div class="line number108 index107 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number109 index108 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number110 index109 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number111 index110 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.stop();</code></div><div class="line number112 index111 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">milSecds = sw.getElapsedTime();</code></div><div class="line number113 index112 alt2">&nbsp;</div><div class="line number114 index113 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">" testThreadsAtomic() 1 thread elapsed (ms): "</code> <code class="java plain">+ milSecds);</code></div><div class="line number115 index114 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number116 index115 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number117 index116 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number118 index117 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">testThreadsSync2(){</code></div><div class="line number119 index118 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number120 index119 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">stopwatch sw = </code><code class="java keyword">new</code> <code class="java plain">stopwatch();</code></div><div class="line number121 index120 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.start();</code></div><div class="line number122 index121 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number123 index122 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread t1 = </code><code class="java keyword">new</code> <code class="java plain">Thread(</code><code class="java keyword">new</code> <code class="java plain">LoopSync());</code></div><div class="line number124 index123 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">t1.start();</code></div><div class="line number125 index124 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number126 index125 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread t2 = </code><code class="java keyword">new</code> <code class="java plain">Thread(</code><code class="java keyword">new</code> <code class="java plain">LoopSync());</code></div><div class="line number127 index126 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">t2.start();</code></div><div class="line number128 index127 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number129 index128 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(t1.isAlive() || t2.isAlive()) {</code></div><div class="line number130 index129 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number131 index130 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number132 index131 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number133 index132 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.stop();</code></div><div class="line number134 index133 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">milSecds = sw.getElapsedTime();</code></div><div class="line number135 index134 alt2">&nbsp;</div><div class="line number136 index135 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">" testThreadsSync() 2 threads elapsed (ms): "</code> <code class="java plain">+ milSecds);</code></div><div class="line number137 index136 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number138 index137 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number139 index138 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number140 index139 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">testThreadsAtomic2(){</code></div><div class="line number141 index140 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number142 index141 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">stopwatch sw = </code><code class="java keyword">new</code> <code class="java plain">stopwatch();</code></div><div class="line number143 index142 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.start();</code></div><div class="line number144 index143 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number145 index144 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread t1 = </code><code class="java keyword">new</code> <code class="java plain">Thread(</code><code class="java keyword">new</code> <code class="java plain">LoopAtomic());</code></div><div class="line number146 index145 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">t1.start();</code></div><div class="line number147 index146 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number148 index147 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread t2 = </code><code class="java keyword">new</code> <code class="java plain">Thread(</code><code class="java keyword">new</code> <code class="java plain">LoopAtomic());</code></div><div class="line number149 index148 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">t2.start();</code></div><div class="line number150 index149 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number151 index150 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(t1.isAlive() || t2.isAlive()) {</code></div><div class="line number152 index151 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number153 index152 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number154 index153 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number155 index154 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sw.stop();</code></div><div class="line number156 index155 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">milSecds = sw.getElapsedTime();</code></div><div class="line number157 index156 alt2">&nbsp;</div><div class="line number158 index157 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">System.out.println(</code><code class="java string">" testThreadsAtomic() 2 threads elapsed (ms): "</code> <code class="java plain">+ milSecds);</code></div><div class="line number159 index158 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number160 index159 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number161 index160 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</div><div class="line number162 index161 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">class</code> <code class="java plain">LoopAtomic </code><code class="java keyword">implements</code> <code class="java plain">Runnable {</code></div><div class="line number163 index162 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">run() {</code></div><div class="line number164 index163 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicLong val = </code><code class="java keyword">new</code> <code class="java plain">AtomicLong(</code><code class="java value">0</code><code class="java plain">);</code></div><div class="line number165 index164 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(val.incrementAndGet() &lt; 10000000L) {</code></div><div class="line number166 index165 alt1">&nbsp;</div><div class="line number167 index166 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number168 index167 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number169 index168 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number170 index169 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">class</code> <code class="java plain">LoopSync </code><code class="java keyword">implements</code> <code class="java plain">Runnable {</code></div><div class="line number171 index170 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">run() {</code></div><div class="line number172 index171 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">val = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number173 index172 alt2">&nbsp;</div><div class="line number174 index173 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(val &lt; 10000000L) {</code></div><div class="line number175 index174 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">synchronized</code> <code class="java plain">(main.</code><code class="java keyword">class</code><code class="java plain">) {</code></div><div class="line number176 index175 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">val++;</code></div><div class="line number177 index176 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number178 index177 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number179 index178 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number180 index179 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number181 index180 alt2"><code class="java plain">}</code></div><div class="line number182 index181 alt1">&nbsp;</div><div class="line number183 index182 alt2">&nbsp;</div><div class="line number184 index183 alt1"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">stopwatch {</code></div><div class="line number185 index184 alt2">&nbsp;</div><div class="line number186 index185 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">long</code> <code class="java plain">startTime = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number187 index186 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">long</code> <code class="java plain">stopTime = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number188 index187 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">boolean</code> <code class="java plain">running = </code><code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number189 index188 alt2">&nbsp;</div><div class="line number190 index189 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">start() {</code></div><div class="line number191 index190 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.startTime = System.currentTimeMillis();</code></div><div class="line number192 index191 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.running = </code><code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number193 index192 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number194 index193 alt1">&nbsp;</div><div class="line number195 index194 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">stop() {</code></div><div class="line number196 index195 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.stopTime = System.currentTimeMillis();</code></div><div class="line number197 index196 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.running = </code><code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number198 index197 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number199 index198 alt2">&nbsp;</div><div class="line number200 index199 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">long</code> <code class="java plain">getElapsedTime() {</code></div><div class="line number201 index200 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">elapsed;</code></div><div class="line number202 index201 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(running) {</code></div><div class="line number203 index202 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">elapsed = (System.currentTimeMillis() - startTime);</code></div><div class="line number204 index203 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">else</code> <code class="java plain">{</code></div><div class="line number205 index204 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">elapsed = (stopTime - startTime);</code></div><div class="line number206 index205 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number207 index206 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">elapsed;</code></div><div class="line number208 index207 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number209 index208 alt2">&nbsp;</div><div class="line number210 index209 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">long</code> <code class="java plain">getElapsedTimeSecs() {</code></div><div class="line number211 index210 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">elapsed;</code></div><div class="line number212 index211 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(running) {</code></div><div class="line number213 index212 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">elapsed = ((System.currentTimeMillis() - startTime) / </code><code class="java value">1000</code><code class="java plain">);</code></div><div class="line number214 index213 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">else</code> <code class="java plain">{</code></div><div class="line number215 index214 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">elapsed = ((stopTime - startTime) / </code><code class="java value">1000</code><code class="java plain">);</code></div><div class="line number216 index215 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number217 index216 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">elapsed;</code></div><div class="line number218 index217 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number219 index218 alt2">&nbsp;</div><div class="line number220 index219 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// sample usage</code></div><div class="line number221 index220 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// public static void main(String[] args) {</code></div><div class="line number222 index221 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// StopWatch s = new StopWatch();</code></div><div class="line number223 index222 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// s.start();</code></div><div class="line number224 index223 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// //code you want to time goes here</code></div><div class="line number225 index224 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// s.stop();</code></div><div class="line number226 index225 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// System.out.println("elapsed time in milliseconds: " +</code></div><div class="line number227 index226 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// s.getElapsedTime());</code></div><div class="line number228 index227 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// }</code></div><div class="line number229 index228 alt2"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>
<h4>CAS的例子：非阻塞堆栈</h4>
<p>下面是比非阻塞自增稍微复杂一点的CAS的例子：非阻塞堆栈/<code>ConcurrentStack</code> 。<code>ConcurrentStack</code> 中的 <code>push()</code> 和 <code>pop()</code> 操作在结构上与<code>NonblockingCounter</code> 上相似，只是做的工作有些冒险，希望在 “提交” 工作的时候，底层假设没有失效。<code>push()</code> 方法观察当前最顶的节点，构建一个新节点放在堆栈上，然后，如果最顶端的节点在初始观察之后没有变化，那么就安装新节点。如果 CAS 失败，意味着另一个线程已经修改了堆栈，那么过程就会重新开始。</p>
<div><div id="highlighter_60327" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">ConcurrentStack&lt;E&gt; {</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReference&lt;Node&lt;E&gt;&gt; head = </code><code class="java keyword">new</code> <code class="java plain">AtomicReference&lt;Node&lt;E&gt;&gt;();</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">push(E item) {</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; newHead = </code><code class="java keyword">new</code> <code class="java plain">Node&lt;E&gt;(item);</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; oldHead;</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">do</code> <code class="java plain">{</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">oldHead = head.get();</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">newHead.next = oldHead;</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">while</code> <code class="java plain">(!head.compareAndSet(oldHead, newHead));</code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">E pop() {</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; oldHead;</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; newHead;</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">do</code> <code class="java plain">{</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">oldHead = head.get();</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(oldHead == </code><code class="java keyword">null</code><code class="java plain">) </code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">newHead = oldHead.next;</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">while</code> <code class="java plain">(!head.compareAndSet(oldHead,newHead));</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">oldHead.item;</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">class</code> <code class="java plain">Node&lt;E&gt; {</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">E item;</code></div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; next;</code></div><div class="line number25 index24 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Node(E item) { </code><code class="java keyword">this</code><code class="java plain">.item = item; }</code></div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number27 index26 alt2"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>
<p>在轻度到中度的争用情况下，非阻塞算法的性能会超越阻塞算法，因为 CAS 的多数时间都在第一次尝试时就成功，而发生争用时的开销也不涉及线程挂起和上下文切换，只多了几个循环迭代。没有争用的 CAS 要比没有争用的锁便宜得多（这句话肯定是真的，因为没有争用的锁涉及 CAS 加上额外的处理），而争用的 CAS 比争用的锁获取涉及更短的延迟。</p>
<p>在高度争用的情况下（即有多个线程不断争用一个内存位置的时候），基于锁的算法开始提供比非阻塞算法更好的吞吐率，因为当线程阻塞时，它就会停止争用，耐心地等候轮到自己，从而避免了进一步争用。但是，这么高的争用程度并不常见，因为多数时候，线程会把线程本地的计算与争用共享数据的操作分开，从而给其他线程使用共享数据的机会。</p>
<h4>CAS的例子3：非阻塞链表</h4>
<p>以上的示例（自增计数器和堆栈）都是非常简单的非阻塞算法，一旦掌握了在循环中使用 CAS，就可以容易地模仿它们。对于更复杂的数据结构，非阻塞算法要比这些简单示例复杂得多，因为修改链表、树或哈希表可能涉及对多个指针的更新。CAS 支持对单一指针的原子性条件更新，但是不支持两个以上的指针。所以，要构建一个非阻塞的链表、树或哈希表，需要找到一种方式，可以用 CAS 更新多个指针，同时不会让数据结构处于不一致的状态。</p>
<p>在链表的尾部插入元素，通常涉及对两个指针的更新：“尾” 指针总是指向列表中的最后一个元素，“下一个” 指针从过去的最后一个元素指向新插入的元素。因为需要更新两个指针，所以需要两个 CAS。在独立的 CAS 中更新两个指针带来了两个需要考虑的潜在问题：如果第一个 CAS 成功，而第二个 CAS 失败，会发生什么？如果其他线程在第一个和第二个 CAS 之间企图访问链表，会发生什么？</p>
<p>对于非复杂数据结构，构建非阻塞算法的 “技巧” 是确保数据结构总处于一致的状态（甚至包括在线程开始修改数据结构和它完成修改之间），还要确保其他线程不仅能够判断出第一个线程已经完成了更新还是处在更新的中途，还能够判断出如果第一个线程走向 AWOL，完成更新还需要什么操作。如果线程发现了处在更新中途的数据结构，它就可以 “帮助” 正在执行更新的线程完成更新，然后再进行自己的操作。当第一个线程回来试图完成自己的更新时，会发现不再需要了，返回即可，因为 CAS 会检测到帮助线程的干预（在这种情况下，是建设性的干预）。</p>
<p>这种 “帮助邻居” 的要求，对于让数据结构免受单个线程失败的影响，是必需的。如果线程发现数据结构正处在被其他线程更新的中途，然后就等候其他线程完成更新，那么如果其他线程在操作中途失败，这个线程就可能永远等候下去。即使不出现故障，这种方式也会提供糟糕的性能，因为新到达的线程必须放弃处理器，导致上下文切换，或者等到自己的时间片过期（而这更糟）。</p>
<div><div id="highlighter_995314" class="syntaxhighlighter  java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">LinkedQueue &lt;E&gt; {</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">class</code> <code class="java plain">Node &lt;E&gt; {</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">E item;</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">AtomicReference&lt;Node&lt;E&gt;&gt; next;</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node(E item, Node&lt;E&gt; next) {</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.item = item;</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.next = </code><code class="java keyword">new</code> <code class="java plain">AtomicReference&lt;Node&lt;E&gt;&gt;(next);</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">AtomicReference&lt;Node&lt;E&gt;&gt; head</code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">= </code><code class="java keyword">new</code> <code class="java plain">AtomicReference&lt;Node&lt;E&gt;&gt;(</code><code class="java keyword">new</code> <code class="java plain">Node&lt;E&gt;(</code><code class="java keyword">null</code><code class="java plain">, </code><code class="java keyword">null</code><code class="java plain">));</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">AtomicReference&lt;Node&lt;E&gt;&gt; tail = head;</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">put(E item) {</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; newNode = </code><code class="java keyword">new</code> <code class="java plain">Node&lt;E&gt;(item, </code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(</code><code class="java keyword">true</code><code class="java plain">) {</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; curTail = tail.get();</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; residue = curTail.next.get();</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(curTail == tail.get()) {</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(residue == </code><code class="java keyword">null</code><code class="java plain">) </code><code class="java comments">/* A */</code> <code class="java plain">{</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(curTail.next.compareAndSet(</code><code class="java keyword">null</code><code class="java plain">, newNode)) </code><code class="java comments">/* C */</code> <code class="java plain">{</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">tail.compareAndSet(curTail, newNode) </code><code class="java comments">/* D */</code> <code class="java plain">;</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">else</code> <code class="java plain">{</code></div><div class="line number25 index24 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">tail.compareAndSet(curTail, residue) </code><code class="java comments">/* B */</code><code class="java plain">;</code></div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number30 index29 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>
<p>具体算法相见<a href="http://www.ibm.com/developerworks/cn/java/j-jtp04186/" target="_blank">IBM Developerworks</a></p>
<h4>Java的ConcurrentHashMap的实现原理</h4>
<p>Java5中的ConcurrentHashMap，线程安全，设计巧妙，用桶粒度的锁，避免了put和get中对整个map的锁定，尤其在get中，只对一个HashEntry做锁定操作，性能提升是显而易见的。</p>
<p><a href="https://images0.cnblogs.com/blog/28306/201402/121727157448397.png"><img style="display: inline; border-width: 0px;" title="8aea11a8-4184-3f1f-aba7-169aa5e0797a" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/121727197879329.png" alt="8aea11a8-4184-3f1f-aba7-169aa5e0797a" width="502" height="360" border="0"></a></p>
<p>具体实现中使用了锁分离机制，在<a href="http://www.iteye.com/topic/344876" target="_blank">这个帖子</a>中有非常详细的讨论。<a href="https://www.ibm.com/developerworks/java/library/j-jtp08223/" target="_blank">这里</a>有关于Java内存模型结合ConcurrentHashMap的分析。以下是JDK6的ConcurrentHashMap的源码：</p>
<div><div id="highlighter_981000" class="syntaxhighlighter   java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_expandSource expandSource">+ View Code</a></span><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div><div class="line number166 index165 alt1">166</div><div class="line number167 index166 alt2">167</div><div class="line number168 index167 alt1">168</div><div class="line number169 index168 alt2">169</div><div class="line number170 index169 alt1">170</div><div class="line number171 index170 alt2">171</div><div class="line number172 index171 alt1">172</div><div class="line number173 index172 alt2">173</div><div class="line number174 index173 alt1">174</div><div class="line number175 index174 alt2">175</div><div class="line number176 index175 alt1">176</div><div class="line number177 index176 alt2">177</div><div class="line number178 index177 alt1">178</div><div class="line number179 index178 alt2">179</div><div class="line number180 index179 alt1">180</div><div class="line number181 index180 alt2">181</div><div class="line number182 index181 alt1">182</div><div class="line number183 index182 alt2">183</div><div class="line number184 index183 alt1">184</div><div class="line number185 index184 alt2">185</div><div class="line number186 index185 alt1">186</div><div class="line number187 index186 alt2">187</div><div class="line number188 index187 alt1">188</div><div class="line number189 index188 alt2">189</div><div class="line number190 index189 alt1">190</div><div class="line number191 index190 alt2">191</div><div class="line number192 index191 alt1">192</div><div class="line number193 index192 alt2">193</div><div class="line number194 index193 alt1">194</div><div class="line number195 index194 alt2">195</div><div class="line number196 index195 alt1">196</div><div class="line number197 index196 alt2">197</div><div class="line number198 index197 alt1">198</div><div class="line number199 index198 alt2">199</div><div class="line number200 index199 alt1">200</div><div class="line number201 index200 alt2">201</div><div class="line number202 index201 alt1">202</div><div class="line number203 index202 alt2">203</div><div class="line number204 index203 alt1">204</div><div class="line number205 index204 alt2">205</div><div class="line number206 index205 alt1">206</div><div class="line number207 index206 alt2">207</div><div class="line number208 index207 alt1">208</div><div class="line number209 index208 alt2">209</div><div class="line number210 index209 alt1">210</div><div class="line number211 index210 alt2">211</div><div class="line number212 index211 alt1">212</div><div class="line number213 index212 alt2">213</div><div class="line number214 index213 alt1">214</div><div class="line number215 index214 alt2">215</div><div class="line number216 index215 alt1">216</div><div class="line number217 index216 alt2">217</div><div class="line number218 index217 alt1">218</div><div class="line number219 index218 alt2">219</div><div class="line number220 index219 alt1">220</div><div class="line number221 index220 alt2">221</div><div class="line number222 index221 alt1">222</div><div class="line number223 index222 alt2">223</div><div class="line number224 index223 alt1">224</div><div class="line number225 index224 alt2">225</div><div class="line number226 index225 alt1">226</div><div class="line number227 index226 alt2">227</div><div class="line number228 index227 alt1">228</div><div class="line number229 index228 alt2">229</div><div class="line number230 index229 alt1">230</div><div class="line number231 index230 alt2">231</div><div class="line number232 index231 alt1">232</div><div class="line number233 index232 alt2">233</div><div class="line number234 index233 alt1">234</div><div class="line number235 index234 alt2">235</div><div class="line number236 index235 alt1">236</div><div class="line number237 index236 alt2">237</div><div class="line number238 index237 alt1">238</div><div class="line number239 index238 alt2">239</div><div class="line number240 index239 alt1">240</div><div class="line number241 index240 alt2">241</div><div class="line number242 index241 alt1">242</div><div class="line number243 index242 alt2">243</div><div class="line number244 index243 alt1">244</div><div class="line number245 index244 alt2">245</div><div class="line number246 index245 alt1">246</div><div class="line number247 index246 alt2">247</div><div class="line number248 index247 alt1">248</div><div class="line number249 index248 alt2">249</div><div class="line number250 index249 alt1">250</div><div class="line number251 index250 alt2">251</div><div class="line number252 index251 alt1">252</div><div class="line number253 index252 alt2">253</div><div class="line number254 index253 alt1">254</div><div class="line number255 index254 alt2">255</div><div class="line number256 index255 alt1">256</div><div class="line number257 index256 alt2">257</div><div class="line number258 index257 alt1">258</div><div class="line number259 index258 alt2">259</div><div class="line number260 index259 alt1">260</div><div class="line number261 index260 alt2">261</div><div class="line number262 index261 alt1">262</div><div class="line number263 index262 alt2">263</div><div class="line number264 index263 alt1">264</div><div class="line number265 index264 alt2">265</div><div class="line number266 index265 alt1">266</div><div class="line number267 index266 alt2">267</div><div class="line number268 index267 alt1">268</div><div class="line number269 index268 alt2">269</div><div class="line number270 index269 alt1">270</div><div class="line number271 index270 alt2">271</div><div class="line number272 index271 alt1">272</div><div class="line number273 index272 alt2">273</div><div class="line number274 index273 alt1">274</div><div class="line number275 index274 alt2">275</div><div class="line number276 index275 alt1">276</div><div class="line number277 index276 alt2">277</div><div class="line number278 index277 alt1">278</div><div class="line number279 index278 alt2">279</div><div class="line number280 index279 alt1">280</div><div class="line number281 index280 alt2">281</div><div class="line number282 index281 alt1">282</div><div class="line number283 index282 alt2">283</div><div class="line number284 index283 alt1">284</div><div class="line number285 index284 alt2">285</div><div class="line number286 index285 alt1">286</div><div class="line number287 index286 alt2">287</div><div class="line number288 index287 alt1">288</div><div class="line number289 index288 alt2">289</div><div class="line number290 index289 alt1">290</div><div class="line number291 index290 alt2">291</div><div class="line number292 index291 alt1">292</div><div class="line number293 index292 alt2">293</div><div class="line number294 index293 alt1">294</div><div class="line number295 index294 alt2">295</div><div class="line number296 index295 alt1">296</div><div class="line number297 index296 alt2">297</div><div class="line number298 index297 alt1">298</div><div class="line number299 index298 alt2">299</div><div class="line number300 index299 alt1">300</div><div class="line number301 index300 alt2">301</div><div class="line number302 index301 alt1">302</div><div class="line number303 index302 alt2">303</div><div class="line number304 index303 alt1">304</div><div class="line number305 index304 alt2">305</div><div class="line number306 index305 alt1">306</div><div class="line number307 index306 alt2">307</div><div class="line number308 index307 alt1">308</div><div class="line number309 index308 alt2">309</div><div class="line number310 index309 alt1">310</div><div class="line number311 index310 alt2">311</div><div class="line number312 index311 alt1">312</div><div class="line number313 index312 alt2">313</div><div class="line number314 index313 alt1">314</div><div class="line number315 index314 alt2">315</div><div class="line number316 index315 alt1">316</div><div class="line number317 index316 alt2">317</div><div class="line number318 index317 alt1">318</div><div class="line number319 index318 alt2">319</div><div class="line number320 index319 alt1">320</div><div class="line number321 index320 alt2">321</div><div class="line number322 index321 alt1">322</div><div class="line number323 index322 alt2">323</div><div class="line number324 index323 alt1">324</div><div class="line number325 index324 alt2">325</div><div class="line number326 index325 alt1">326</div><div class="line number327 index326 alt2">327</div><div class="line number328 index327 alt1">328</div><div class="line number329 index328 alt2">329</div><div class="line number330 index329 alt1">330</div><div class="line number331 index330 alt2">331</div><div class="line number332 index331 alt1">332</div><div class="line number333 index332 alt2">333</div><div class="line number334 index333 alt1">334</div><div class="line number335 index334 alt2">335</div><div class="line number336 index335 alt1">336</div><div class="line number337 index336 alt2">337</div><div class="line number338 index337 alt1">338</div><div class="line number339 index338 alt2">339</div><div class="line number340 index339 alt1">340</div><div class="line number341 index340 alt2">341</div><div class="line number342 index341 alt1">342</div><div class="line number343 index342 alt2">343</div><div class="line number344 index343 alt1">344</div><div class="line number345 index344 alt2">345</div><div class="line number346 index345 alt1">346</div><div class="line number347 index346 alt2">347</div><div class="line number348 index347 alt1">348</div><div class="line number349 index348 alt2">349</div><div class="line number350 index349 alt1">350</div><div class="line number351 index350 alt2">351</div><div class="line number352 index351 alt1">352</div><div class="line number353 index352 alt2">353</div><div class="line number354 index353 alt1">354</div><div class="line number355 index354 alt2">355</div><div class="line number356 index355 alt1">356</div><div class="line number357 index356 alt2">357</div><div class="line number358 index357 alt1">358</div><div class="line number359 index358 alt2">359</div><div class="line number360 index359 alt1">360</div><div class="line number361 index360 alt2">361</div><div class="line number362 index361 alt1">362</div><div class="line number363 index362 alt2">363</div><div class="line number364 index363 alt1">364</div><div class="line number365 index364 alt2">365</div><div class="line number366 index365 alt1">366</div><div class="line number367 index366 alt2">367</div><div class="line number368 index367 alt1">368</div><div class="line number369 index368 alt2">369</div><div class="line number370 index369 alt1">370</div><div class="line number371 index370 alt2">371</div><div class="line number372 index371 alt1">372</div><div class="line number373 index372 alt2">373</div><div class="line number374 index373 alt1">374</div><div class="line number375 index374 alt2">375</div><div class="line number376 index375 alt1">376</div><div class="line number377 index376 alt2">377</div><div class="line number378 index377 alt1">378</div><div class="line number379 index378 alt2">379</div><div class="line number380 index379 alt1">380</div><div class="line number381 index380 alt2">381</div><div class="line number382 index381 alt1">382</div><div class="line number383 index382 alt2">383</div><div class="line number384 index383 alt1">384</div><div class="line number385 index384 alt2">385</div><div class="line number386 index385 alt1">386</div><div class="line number387 index386 alt2">387</div><div class="line number388 index387 alt1">388</div><div class="line number389 index388 alt2">389</div><div class="line number390 index389 alt1">390</div><div class="line number391 index390 alt2">391</div><div class="line number392 index391 alt1">392</div><div class="line number393 index392 alt2">393</div><div class="line number394 index393 alt1">394</div><div class="line number395 index394 alt2">395</div><div class="line number396 index395 alt1">396</div><div class="line number397 index396 alt2">397</div><div class="line number398 index397 alt1">398</div><div class="line number399 index398 alt2">399</div><div class="line number400 index399 alt1">400</div><div class="line number401 index400 alt2">401</div><div class="line number402 index401 alt1">402</div><div class="line number403 index402 alt2">403</div><div class="line number404 index403 alt1">404</div><div class="line number405 index404 alt2">405</div><div class="line number406 index405 alt1">406</div><div class="line number407 index406 alt2">407</div><div class="line number408 index407 alt1">408</div><div class="line number409 index408 alt2">409</div><div class="line number410 index409 alt1">410</div><div class="line number411 index410 alt2">411</div><div class="line number412 index411 alt1">412</div><div class="line number413 index412 alt2">413</div><div class="line number414 index413 alt1">414</div><div class="line number415 index414 alt2">415</div><div class="line number416 index415 alt1">416</div><div class="line number417 index416 alt2">417</div><div class="line number418 index417 alt1">418</div><div class="line number419 index418 alt2">419</div><div class="line number420 index419 alt1">420</div><div class="line number421 index420 alt2">421</div><div class="line number422 index421 alt1">422</div><div class="line number423 index422 alt2">423</div><div class="line number424 index423 alt1">424</div><div class="line number425 index424 alt2">425</div><div class="line number426 index425 alt1">426</div><div class="line number427 index426 alt2">427</div><div class="line number428 index427 alt1">428</div><div class="line number429 index428 alt2">429</div><div class="line number430 index429 alt1">430</div><div class="line number431 index430 alt2">431</div><div class="line number432 index431 alt1">432</div><div class="line number433 index432 alt2">433</div><div class="line number434 index433 alt1">434</div><div class="line number435 index434 alt2">435</div><div class="line number436 index435 alt1">436</div><div class="line number437 index436 alt2">437</div><div class="line number438 index437 alt1">438</div><div class="line number439 index438 alt2">439</div><div class="line number440 index439 alt1">440</div><div class="line number441 index440 alt2">441</div><div class="line number442 index441 alt1">442</div><div class="line number443 index442 alt2">443</div><div class="line number444 index443 alt1">444</div><div class="line number445 index444 alt2">445</div><div class="line number446 index445 alt1">446</div><div class="line number447 index446 alt2">447</div><div class="line number448 index447 alt1">448</div><div class="line number449 index448 alt2">449</div><div class="line number450 index449 alt1">450</div><div class="line number451 index450 alt2">451</div><div class="line number452 index451 alt1">452</div><div class="line number453 index452 alt2">453</div><div class="line number454 index453 alt1">454</div><div class="line number455 index454 alt2">455</div><div class="line number456 index455 alt1">456</div><div class="line number457 index456 alt2">457</div><div class="line number458 index457 alt1">458</div><div class="line number459 index458 alt2">459</div><div class="line number460 index459 alt1">460</div><div class="line number461 index460 alt2">461</div><div class="line number462 index461 alt1">462</div><div class="line number463 index462 alt2">463</div><div class="line number464 index463 alt1">464</div><div class="line number465 index464 alt2">465</div><div class="line number466 index465 alt1">466</div><div class="line number467 index466 alt2">467</div><div class="line number468 index467 alt1">468</div><div class="line number469 index468 alt2">469</div><div class="line number470 index469 alt1">470</div><div class="line number471 index470 alt2">471</div><div class="line number472 index471 alt1">472</div><div class="line number473 index472 alt2">473</div><div class="line number474 index473 alt1">474</div><div class="line number475 index474 alt2">475</div><div class="line number476 index475 alt1">476</div><div class="line number477 index476 alt2">477</div><div class="line number478 index477 alt1">478</div><div class="line number479 index478 alt2">479</div><div class="line number480 index479 alt1">480</div><div class="line number481 index480 alt2">481</div><div class="line number482 index481 alt1">482</div><div class="line number483 index482 alt2">483</div><div class="line number484 index483 alt1">484</div><div class="line number485 index484 alt2">485</div><div class="line number486 index485 alt1">486</div><div class="line number487 index486 alt2">487</div><div class="line number488 index487 alt1">488</div><div class="line number489 index488 alt2">489</div><div class="line number490 index489 alt1">490</div><div class="line number491 index490 alt2">491</div><div class="line number492 index491 alt1">492</div><div class="line number493 index492 alt2">493</div><div class="line number494 index493 alt1">494</div><div class="line number495 index494 alt2">495</div><div class="line number496 index495 alt1">496</div><div class="line number497 index496 alt2">497</div><div class="line number498 index497 alt1">498</div><div class="line number499 index498 alt2">499</div><div class="line number500 index499 alt1">500</div><div class="line number501 index500 alt2">501</div><div class="line number502 index501 alt1">502</div><div class="line number503 index502 alt2">503</div><div class="line number504 index503 alt1">504</div><div class="line number505 index504 alt2">505</div><div class="line number506 index505 alt1">506</div><div class="line number507 index506 alt2">507</div><div class="line number508 index507 alt1">508</div><div class="line number509 index508 alt2">509</div><div class="line number510 index509 alt1">510</div><div class="line number511 index510 alt2">511</div><div class="line number512 index511 alt1">512</div><div class="line number513 index512 alt2">513</div><div class="line number514 index513 alt1">514</div><div class="line number515 index514 alt2">515</div><div class="line number516 index515 alt1">516</div><div class="line number517 index516 alt2">517</div><div class="line number518 index517 alt1">518</div><div class="line number519 index518 alt2">519</div><div class="line number520 index519 alt1">520</div><div class="line number521 index520 alt2">521</div><div class="line number522 index521 alt1">522</div><div class="line number523 index522 alt2">523</div><div class="line number524 index523 alt1">524</div><div class="line number525 index524 alt2">525</div><div class="line number526 index525 alt1">526</div><div class="line number527 index526 alt2">527</div><div class="line number528 index527 alt1">528</div><div class="line number529 index528 alt2">529</div><div class="line number530 index529 alt1">530</div><div class="line number531 index530 alt2">531</div><div class="line number532 index531 alt1">532</div><div class="line number533 index532 alt2">533</div><div class="line number534 index533 alt1">534</div><div class="line number535 index534 alt2">535</div><div class="line number536 index535 alt1">536</div><div class="line number537 index536 alt2">537</div><div class="line number538 index537 alt1">538</div><div class="line number539 index538 alt2">539</div><div class="line number540 index539 alt1">540</div><div class="line number541 index540 alt2">541</div><div class="line number542 index541 alt1">542</div><div class="line number543 index542 alt2">543</div><div class="line number544 index543 alt1">544</div><div class="line number545 index544 alt2">545</div><div class="line number546 index545 alt1">546</div><div class="line number547 index546 alt2">547</div><div class="line number548 index547 alt1">548</div><div class="line number549 index548 alt2">549</div><div class="line number550 index549 alt1">550</div><div class="line number551 index550 alt2">551</div><div class="line number552 index551 alt1">552</div><div class="line number553 index552 alt2">553</div><div class="line number554 index553 alt1">554</div><div class="line number555 index554 alt2">555</div><div class="line number556 index555 alt1">556</div><div class="line number557 index556 alt2">557</div><div class="line number558 index557 alt1">558</div><div class="line number559 index558 alt2">559</div><div class="line number560 index559 alt1">560</div><div class="line number561 index560 alt2">561</div><div class="line number562 index561 alt1">562</div><div class="line number563 index562 alt2">563</div><div class="line number564 index563 alt1">564</div><div class="line number565 index564 alt2">565</div><div class="line number566 index565 alt1">566</div><div class="line number567 index566 alt2">567</div><div class="line number568 index567 alt1">568</div><div class="line number569 index568 alt2">569</div><div class="line number570 index569 alt1">570</div><div class="line number571 index570 alt2">571</div><div class="line number572 index571 alt1">572</div><div class="line number573 index572 alt2">573</div><div class="line number574 index573 alt1">574</div><div class="line number575 index574 alt2">575</div><div class="line number576 index575 alt1">576</div><div class="line number577 index576 alt2">577</div><div class="line number578 index577 alt1">578</div><div class="line number579 index578 alt2">579</div><div class="line number580 index579 alt1">580</div><div class="line number581 index580 alt2">581</div><div class="line number582 index581 alt1">582</div><div class="line number583 index582 alt2">583</div><div class="line number584 index583 alt1">584</div><div class="line number585 index584 alt2">585</div><div class="line number586 index585 alt1">586</div><div class="line number587 index586 alt2">587</div><div class="line number588 index587 alt1">588</div><div class="line number589 index588 alt2">589</div><div class="line number590 index589 alt1">590</div><div class="line number591 index590 alt2">591</div><div class="line number592 index591 alt1">592</div><div class="line number593 index592 alt2">593</div><div class="line number594 index593 alt1">594</div><div class="line number595 index594 alt2">595</div><div class="line number596 index595 alt1">596</div><div class="line number597 index596 alt2">597</div><div class="line number598 index597 alt1">598</div><div class="line number599 index598 alt2">599</div><div class="line number600 index599 alt1">600</div><div class="line number601 index600 alt2">601</div><div class="line number602 index601 alt1">602</div><div class="line number603 index602 alt2">603</div><div class="line number604 index603 alt1">604</div><div class="line number605 index604 alt2">605</div><div class="line number606 index605 alt1">606</div><div class="line number607 index606 alt2">607</div><div class="line number608 index607 alt1">608</div><div class="line number609 index608 alt2">609</div><div class="line number610 index609 alt1">610</div><div class="line number611 index610 alt2">611</div><div class="line number612 index611 alt1">612</div><div class="line number613 index612 alt2">613</div><div class="line number614 index613 alt1">614</div><div class="line number615 index614 alt2">615</div><div class="line number616 index615 alt1">616</div><div class="line number617 index616 alt2">617</div><div class="line number618 index617 alt1">618</div><div class="line number619 index618 alt2">619</div><div class="line number620 index619 alt1">620</div><div class="line number621 index620 alt2">621</div><div class="line number622 index621 alt1">622</div><div class="line number623 index622 alt2">623</div><div class="line number624 index623 alt1">624</div><div class="line number625 index624 alt2">625</div><div class="line number626 index625 alt1">626</div><div class="line number627 index626 alt2">627</div><div class="line number628 index627 alt1">628</div><div class="line number629 index628 alt2">629</div><div class="line number630 index629 alt1">630</div><div class="line number631 index630 alt2">631</div><div class="line number632 index631 alt1">632</div><div class="line number633 index632 alt2">633</div><div class="line number634 index633 alt1">634</div><div class="line number635 index634 alt2">635</div><div class="line number636 index635 alt1">636</div><div class="line number637 index636 alt2">637</div><div class="line number638 index637 alt1">638</div><div class="line number639 index638 alt2">639</div><div class="line number640 index639 alt1">640</div><div class="line number641 index640 alt2">641</div><div class="line number642 index641 alt1">642</div><div class="line number643 index642 alt2">643</div><div class="line number644 index643 alt1">644</div><div class="line number645 index644 alt2">645</div><div class="line number646 index645 alt1">646</div><div class="line number647 index646 alt2">647</div><div class="line number648 index647 alt1">648</div><div class="line number649 index648 alt2">649</div><div class="line number650 index649 alt1">650</div><div class="line number651 index650 alt2">651</div><div class="line number652 index651 alt1">652</div><div class="line number653 index652 alt2">653</div><div class="line number654 index653 alt1">654</div><div class="line number655 index654 alt2">655</div><div class="line number656 index655 alt1">656</div><div class="line number657 index656 alt2">657</div><div class="line number658 index657 alt1">658</div><div class="line number659 index658 alt2">659</div><div class="line number660 index659 alt1">660</div><div class="line number661 index660 alt2">661</div><div class="line number662 index661 alt1">662</div><div class="line number663 index662 alt2">663</div><div class="line number664 index663 alt1">664</div><div class="line number665 index664 alt2">665</div><div class="line number666 index665 alt1">666</div><div class="line number667 index666 alt2">667</div><div class="line number668 index667 alt1">668</div><div class="line number669 index668 alt2">669</div><div class="line number670 index669 alt1">670</div><div class="line number671 index670 alt2">671</div><div class="line number672 index671 alt1">672</div><div class="line number673 index672 alt2">673</div><div class="line number674 index673 alt1">674</div><div class="line number675 index674 alt2">675</div><div class="line number676 index675 alt1">676</div><div class="line number677 index676 alt2">677</div><div class="line number678 index677 alt1">678</div><div class="line number679 index678 alt2">679</div><div class="line number680 index679 alt1">680</div><div class="line number681 index680 alt2">681</div><div class="line number682 index681 alt1">682</div><div class="line number683 index682 alt2">683</div><div class="line number684 index683 alt1">684</div><div class="line number685 index684 alt2">685</div><div class="line number686 index685 alt1">686</div><div class="line number687 index686 alt2">687</div><div class="line number688 index687 alt1">688</div><div class="line number689 index688 alt2">689</div><div class="line number690 index689 alt1">690</div><div class="line number691 index690 alt2">691</div><div class="line number692 index691 alt1">692</div><div class="line number693 index692 alt2">693</div><div class="line number694 index693 alt1">694</div><div class="line number695 index694 alt2">695</div><div class="line number696 index695 alt1">696</div><div class="line number697 index696 alt2">697</div><div class="line number698 index697 alt1">698</div><div class="line number699 index698 alt2">699</div><div class="line number700 index699 alt1">700</div><div class="line number701 index700 alt2">701</div><div class="line number702 index701 alt1">702</div><div class="line number703 index702 alt2">703</div><div class="line number704 index703 alt1">704</div><div class="line number705 index704 alt2">705</div><div class="line number706 index705 alt1">706</div><div class="line number707 index706 alt2">707</div><div class="line number708 index707 alt1">708</div><div class="line number709 index708 alt2">709</div><div class="line number710 index709 alt1">710</div><div class="line number711 index710 alt2">711</div><div class="line number712 index711 alt1">712</div><div class="line number713 index712 alt2">713</div><div class="line number714 index713 alt1">714</div><div class="line number715 index714 alt2">715</div><div class="line number716 index715 alt1">716</div><div class="line number717 index716 alt2">717</div><div class="line number718 index717 alt1">718</div><div class="line number719 index718 alt2">719</div><div class="line number720 index719 alt1">720</div><div class="line number721 index720 alt2">721</div><div class="line number722 index721 alt1">722</div><div class="line number723 index722 alt2">723</div><div class="line number724 index723 alt1">724</div><div class="line number725 index724 alt2">725</div><div class="line number726 index725 alt1">726</div><div class="line number727 index726 alt2">727</div><div class="line number728 index727 alt1">728</div><div class="line number729 index728 alt2">729</div><div class="line number730 index729 alt1">730</div><div class="line number731 index730 alt2">731</div><div class="line number732 index731 alt1">732</div><div class="line number733 index732 alt2">733</div><div class="line number734 index733 alt1">734</div><div class="line number735 index734 alt2">735</div><div class="line number736 index735 alt1">736</div><div class="line number737 index736 alt2">737</div><div class="line number738 index737 alt1">738</div><div class="line number739 index738 alt2">739</div><div class="line number740 index739 alt1">740</div><div class="line number741 index740 alt2">741</div><div class="line number742 index741 alt1">742</div><div class="line number743 index742 alt2">743</div><div class="line number744 index743 alt1">744</div><div class="line number745 index744 alt2">745</div><div class="line number746 index745 alt1">746</div><div class="line number747 index746 alt2">747</div><div class="line number748 index747 alt1">748</div><div class="line number749 index748 alt2">749</div><div class="line number750 index749 alt1">750</div><div class="line number751 index750 alt2">751</div><div class="line number752 index751 alt1">752</div><div class="line number753 index752 alt2">753</div><div class="line number754 index753 alt1">754</div><div class="line number755 index754 alt2">755</div><div class="line number756 index755 alt1">756</div><div class="line number757 index756 alt2">757</div><div class="line number758 index757 alt1">758</div><div class="line number759 index758 alt2">759</div><div class="line number760 index759 alt1">760</div><div class="line number761 index760 alt2">761</div><div class="line number762 index761 alt1">762</div><div class="line number763 index762 alt2">763</div><div class="line number764 index763 alt1">764</div><div class="line number765 index764 alt2">765</div><div class="line number766 index765 alt1">766</div><div class="line number767 index766 alt2">767</div><div class="line number768 index767 alt1">768</div><div class="line number769 index768 alt2">769</div><div class="line number770 index769 alt1">770</div><div class="line number771 index770 alt2">771</div><div class="line number772 index771 alt1">772</div><div class="line number773 index772 alt2">773</div><div class="line number774 index773 alt1">774</div><div class="line number775 index774 alt2">775</div><div class="line number776 index775 alt1">776</div><div class="line number777 index776 alt2">777</div><div class="line number778 index777 alt1">778</div><div class="line number779 index778 alt2">779</div><div class="line number780 index779 alt1">780</div><div class="line number781 index780 alt2">781</div><div class="line number782 index781 alt1">782</div><div class="line number783 index782 alt2">783</div><div class="line number784 index783 alt1">784</div><div class="line number785 index784 alt2">785</div><div class="line number786 index785 alt1">786</div><div class="line number787 index786 alt2">787</div><div class="line number788 index787 alt1">788</div><div class="line number789 index788 alt2">789</div><div class="line number790 index789 alt1">790</div><div class="line number791 index790 alt2">791</div><div class="line number792 index791 alt1">792</div><div class="line number793 index792 alt2">793</div><div class="line number794 index793 alt1">794</div><div class="line number795 index794 alt2">795</div><div class="line number796 index795 alt1">796</div><div class="line number797 index796 alt2">797</div><div class="line number798 index797 alt1">798</div><div class="line number799 index798 alt2">799</div><div class="line number800 index799 alt1">800</div><div class="line number801 index800 alt2">801</div><div class="line number802 index801 alt1">802</div><div class="line number803 index802 alt2">803</div><div class="line number804 index803 alt1">804</div><div class="line number805 index804 alt2">805</div><div class="line number806 index805 alt1">806</div><div class="line number807 index806 alt2">807</div><div class="line number808 index807 alt1">808</div><div class="line number809 index808 alt2">809</div><div class="line number810 index809 alt1">810</div><div class="line number811 index810 alt2">811</div><div class="line number812 index811 alt1">812</div><div class="line number813 index812 alt2">813</div><div class="line number814 index813 alt1">814</div><div class="line number815 index814 alt2">815</div><div class="line number816 index815 alt1">816</div><div class="line number817 index816 alt2">817</div><div class="line number818 index817 alt1">818</div><div class="line number819 index818 alt2">819</div><div class="line number820 index819 alt1">820</div><div class="line number821 index820 alt2">821</div><div class="line number822 index821 alt1">822</div><div class="line number823 index822 alt2">823</div><div class="line number824 index823 alt1">824</div><div class="line number825 index824 alt2">825</div><div class="line number826 index825 alt1">826</div><div class="line number827 index826 alt2">827</div><div class="line number828 index827 alt1">828</div><div class="line number829 index828 alt2">829</div><div class="line number830 index829 alt1">830</div><div class="line number831 index830 alt2">831</div><div class="line number832 index831 alt1">832</div><div class="line number833 index832 alt2">833</div><div class="line number834 index833 alt1">834</div><div class="line number835 index834 alt2">835</div><div class="line number836 index835 alt1">836</div><div class="line number837 index836 alt2">837</div><div class="line number838 index837 alt1">838</div><div class="line number839 index838 alt2">839</div><div class="line number840 index839 alt1">840</div><div class="line number841 index840 alt2">841</div><div class="line number842 index841 alt1">842</div><div class="line number843 index842 alt2">843</div><div class="line number844 index843 alt1">844</div><div class="line number845 index844 alt2">845</div><div class="line number846 index845 alt1">846</div><div class="line number847 index846 alt2">847</div><div class="line number848 index847 alt1">848</div><div class="line number849 index848 alt2">849</div><div class="line number850 index849 alt1">850</div><div class="line number851 index850 alt2">851</div><div class="line number852 index851 alt1">852</div><div class="line number853 index852 alt2">853</div><div class="line number854 index853 alt1">854</div><div class="line number855 index854 alt2">855</div><div class="line number856 index855 alt1">856</div><div class="line number857 index856 alt2">857</div><div class="line number858 index857 alt1">858</div><div class="line number859 index858 alt2">859</div><div class="line number860 index859 alt1">860</div><div class="line number861 index860 alt2">861</div><div class="line number862 index861 alt1">862</div><div class="line number863 index862 alt2">863</div><div class="line number864 index863 alt1">864</div><div class="line number865 index864 alt2">865</div><div class="line number866 index865 alt1">866</div><div class="line number867 index866 alt2">867</div><div class="line number868 index867 alt1">868</div><div class="line number869 index868 alt2">869</div><div class="line number870 index869 alt1">870</div><div class="line number871 index870 alt2">871</div><div class="line number872 index871 alt1">872</div><div class="line number873 index872 alt2">873</div><div class="line number874 index873 alt1">874</div><div class="line number875 index874 alt2">875</div><div class="line number876 index875 alt1">876</div><div class="line number877 index876 alt2">877</div><div class="line number878 index877 alt1">878</div><div class="line number879 index878 alt2">879</div><div class="line number880 index879 alt1">880</div><div class="line number881 index880 alt2">881</div><div class="line number882 index881 alt1">882</div><div class="line number883 index882 alt2">883</div><div class="line number884 index883 alt1">884</div><div class="line number885 index884 alt2">885</div><div class="line number886 index885 alt1">886</div><div class="line number887 index886 alt2">887</div><div class="line number888 index887 alt1">888</div><div class="line number889 index888 alt2">889</div><div class="line number890 index889 alt1">890</div><div class="line number891 index890 alt2">891</div><div class="line number892 index891 alt1">892</div><div class="line number893 index892 alt2">893</div><div class="line number894 index893 alt1">894</div><div class="line number895 index894 alt2">895</div><div class="line number896 index895 alt1">896</div><div class="line number897 index896 alt2">897</div><div class="line number898 index897 alt1">898</div><div class="line number899 index898 alt2">899</div><div class="line number900 index899 alt1">900</div><div class="line number901 index900 alt2">901</div><div class="line number902 index901 alt1">902</div><div class="line number903 index902 alt2">903</div><div class="line number904 index903 alt1">904</div><div class="line number905 index904 alt2">905</div><div class="line number906 index905 alt1">906</div><div class="line number907 index906 alt2">907</div><div class="line number908 index907 alt1">908</div><div class="line number909 index908 alt2">909</div><div class="line number910 index909 alt1">910</div><div class="line number911 index910 alt2">911</div><div class="line number912 index911 alt1">912</div><div class="line number913 index912 alt2">913</div><div class="line number914 index913 alt1">914</div><div class="line number915 index914 alt2">915</div><div class="line number916 index915 alt1">916</div><div class="line number917 index916 alt2">917</div><div class="line number918 index917 alt1">918</div><div class="line number919 index918 alt2">919</div><div class="line number920 index919 alt1">920</div><div class="line number921 index920 alt2">921</div><div class="line number922 index921 alt1">922</div><div class="line number923 index922 alt2">923</div><div class="line number924 index923 alt1">924</div><div class="line number925 index924 alt2">925</div><div class="line number926 index925 alt1">926</div><div class="line number927 index926 alt2">927</div><div class="line number928 index927 alt1">928</div><div class="line number929 index928 alt2">929</div><div class="line number930 index929 alt1">930</div><div class="line number931 index930 alt2">931</div><div class="line number932 index931 alt1">932</div><div class="line number933 index932 alt2">933</div><div class="line number934 index933 alt1">934</div><div class="line number935 index934 alt2">935</div><div class="line number936 index935 alt1">936</div><div class="line number937 index936 alt2">937</div><div class="line number938 index937 alt1">938</div><div class="line number939 index938 alt2">939</div><div class="line number940 index939 alt1">940</div><div class="line number941 index940 alt2">941</div><div class="line number942 index941 alt1">942</div><div class="line number943 index942 alt2">943</div><div class="line number944 index943 alt1">944</div><div class="line number945 index944 alt2">945</div><div class="line number946 index945 alt1">946</div><div class="line number947 index946 alt2">947</div><div class="line number948 index947 alt1">948</div><div class="line number949 index948 alt2">949</div><div class="line number950 index949 alt1">950</div><div class="line number951 index950 alt2">951</div><div class="line number952 index951 alt1">952</div><div class="line number953 index952 alt2">953</div><div class="line number954 index953 alt1">954</div><div class="line number955 index954 alt2">955</div><div class="line number956 index955 alt1">956</div><div class="line number957 index956 alt2">957</div><div class="line number958 index957 alt1">958</div><div class="line number959 index958 alt2">959</div><div class="line number960 index959 alt1">960</div><div class="line number961 index960 alt2">961</div><div class="line number962 index961 alt1">962</div><div class="line number963 index962 alt2">963</div><div class="line number964 index963 alt1">964</div><div class="line number965 index964 alt2">965</div><div class="line number966 index965 alt1">966</div><div class="line number967 index966 alt2">967</div><div class="line number968 index967 alt1">968</div><div class="line number969 index968 alt2">969</div><div class="line number970 index969 alt1">970</div><div class="line number971 index970 alt2">971</div><div class="line number972 index971 alt1">972</div><div class="line number973 index972 alt2">973</div><div class="line number974 index973 alt1">974</div><div class="line number975 index974 alt2">975</div><div class="line number976 index975 alt1">976</div><div class="line number977 index976 alt2">977</div><div class="line number978 index977 alt1">978</div><div class="line number979 index978 alt2">979</div><div class="line number980 index979 alt1">980</div><div class="line number981 index980 alt2">981</div><div class="line number982 index981 alt1">982</div><div class="line number983 index982 alt2">983</div><div class="line number984 index983 alt1">984</div><div class="line number985 index984 alt2">985</div><div class="line number986 index985 alt1">986</div><div class="line number987 index986 alt2">987</div><div class="line number988 index987 alt1">988</div><div class="line number989 index988 alt2">989</div><div class="line number990 index989 alt1">990</div><div class="line number991 index990 alt2">991</div><div class="line number992 index991 alt1">992</div><div class="line number993 index992 alt2">993</div><div class="line number994 index993 alt1">994</div><div class="line number995 index994 alt2">995</div><div class="line number996 index995 alt1">996</div><div class="line number997 index996 alt2">997</div><div class="line number998 index997 alt1">998</div><div class="line number999 index998 alt2">999</div><div class="line number1000 index999 alt1">1000</div><div class="line number1001 index1000 alt2">1001</div><div class="line number1002 index1001 alt1">1002</div><div class="line number1003 index1002 alt2">1003</div><div class="line number1004 index1003 alt1">1004</div><div class="line number1005 index1004 alt2">1005</div><div class="line number1006 index1005 alt1">1006</div><div class="line number1007 index1006 alt2">1007</div><div class="line number1008 index1007 alt1">1008</div><div class="line number1009 index1008 alt2">1009</div><div class="line number1010 index1009 alt1">1010</div><div class="line number1011 index1010 alt2">1011</div><div class="line number1012 index1011 alt1">1012</div><div class="line number1013 index1012 alt2">1013</div><div class="line number1014 index1013 alt1">1014</div><div class="line number1015 index1014 alt2">1015</div><div class="line number1016 index1015 alt1">1016</div><div class="line number1017 index1016 alt2">1017</div><div class="line number1018 index1017 alt1">1018</div><div class="line number1019 index1018 alt2">1019</div><div class="line number1020 index1019 alt1">1020</div><div class="line number1021 index1020 alt2">1021</div><div class="line number1022 index1021 alt1">1022</div><div class="line number1023 index1022 alt2">1023</div><div class="line number1024 index1023 alt1">1024</div><div class="line number1025 index1024 alt2">1025</div><div class="line number1026 index1025 alt1">1026</div><div class="line number1027 index1026 alt2">1027</div><div class="line number1028 index1027 alt1">1028</div><div class="line number1029 index1028 alt2">1029</div><div class="line number1030 index1029 alt1">1030</div><div class="line number1031 index1030 alt2">1031</div><div class="line number1032 index1031 alt1">1032</div><div class="line number1033 index1032 alt2">1033</div><div class="line number1034 index1033 alt1">1034</div><div class="line number1035 index1034 alt2">1035</div><div class="line number1036 index1035 alt1">1036</div><div class="line number1037 index1036 alt2">1037</div><div class="line number1038 index1037 alt1">1038</div><div class="line number1039 index1038 alt2">1039</div><div class="line number1040 index1039 alt1">1040</div><div class="line number1041 index1040 alt2">1041</div><div class="line number1042 index1041 alt1">1042</div><div class="line number1043 index1042 alt2">1043</div><div class="line number1044 index1043 alt1">1044</div><div class="line number1045 index1044 alt2">1045</div><div class="line number1046 index1045 alt1">1046</div><div class="line number1047 index1046 alt2">1047</div><div class="line number1048 index1047 alt1">1048</div><div class="line number1049 index1048 alt2">1049</div><div class="line number1050 index1049 alt1">1050</div><div class="line number1051 index1050 alt2">1051</div><div class="line number1052 index1051 alt1">1052</div><div class="line number1053 index1052 alt2">1053</div><div class="line number1054 index1053 alt1">1054</div><div class="line number1055 index1054 alt2">1055</div><div class="line number1056 index1055 alt1">1056</div><div class="line number1057 index1056 alt2">1057</div><div class="line number1058 index1057 alt1">1058</div><div class="line number1059 index1058 alt2">1059</div><div class="line number1060 index1059 alt1">1060</div><div class="line number1061 index1060 alt2">1061</div><div class="line number1062 index1061 alt1">1062</div><div class="line number1063 index1062 alt2">1063</div><div class="line number1064 index1063 alt1">1064</div><div class="line number1065 index1064 alt2">1065</div><div class="line number1066 index1065 alt1">1066</div><div class="line number1067 index1066 alt2">1067</div><div class="line number1068 index1067 alt1">1068</div><div class="line number1069 index1068 alt2">1069</div><div class="line number1070 index1069 alt1">1070</div><div class="line number1071 index1070 alt2">1071</div><div class="line number1072 index1071 alt1">1072</div><div class="line number1073 index1072 alt2">1073</div><div class="line number1074 index1073 alt1">1074</div><div class="line number1075 index1074 alt2">1075</div><div class="line number1076 index1075 alt1">1076</div><div class="line number1077 index1076 alt2">1077</div><div class="line number1078 index1077 alt1">1078</div><div class="line number1079 index1078 alt2">1079</div><div class="line number1080 index1079 alt1">1080</div><div class="line number1081 index1080 alt2">1081</div><div class="line number1082 index1081 alt1">1082</div><div class="line number1083 index1082 alt2">1083</div><div class="line number1084 index1083 alt1">1084</div><div class="line number1085 index1084 alt2">1085</div><div class="line number1086 index1085 alt1">1086</div><div class="line number1087 index1086 alt2">1087</div><div class="line number1088 index1087 alt1">1088</div><div class="line number1089 index1088 alt2">1089</div><div class="line number1090 index1089 alt1">1090</div><div class="line number1091 index1090 alt2">1091</div><div class="line number1092 index1091 alt1">1092</div><div class="line number1093 index1092 alt2">1093</div><div class="line number1094 index1093 alt1">1094</div><div class="line number1095 index1094 alt2">1095</div><div class="line number1096 index1095 alt1">1096</div><div class="line number1097 index1096 alt2">1097</div><div class="line number1098 index1097 alt1">1098</div><div class="line number1099 index1098 alt2">1099</div><div class="line number1100 index1099 alt1">1100</div><div class="line number1101 index1100 alt2">1101</div><div class="line number1102 index1101 alt1">1102</div><div class="line number1103 index1102 alt2">1103</div><div class="line number1104 index1103 alt1">1104</div><div class="line number1105 index1104 alt2">1105</div><div class="line number1106 index1105 alt1">1106</div><div class="line number1107 index1106 alt2">1107</div><div class="line number1108 index1107 alt1">1108</div><div class="line number1109 index1108 alt2">1109</div><div class="line number1110 index1109 alt1">1110</div><div class="line number1111 index1110 alt2">1111</div><div class="line number1112 index1111 alt1">1112</div><div class="line number1113 index1112 alt2">1113</div><div class="line number1114 index1113 alt1">1114</div><div class="line number1115 index1114 alt2">1115</div><div class="line number1116 index1115 alt1">1116</div><div class="line number1117 index1116 alt2">1117</div><div class="line number1118 index1117 alt1">1118</div><div class="line number1119 index1118 alt2">1119</div><div class="line number1120 index1119 alt1">1120</div><div class="line number1121 index1120 alt2">1121</div><div class="line number1122 index1121 alt1">1122</div><div class="line number1123 index1122 alt2">1123</div><div class="line number1124 index1123 alt1">1124</div><div class="line number1125 index1124 alt2">1125</div><div class="line number1126 index1125 alt1">1126</div><div class="line number1127 index1126 alt2">1127</div><div class="line number1128 index1127 alt1">1128</div><div class="line number1129 index1128 alt2">1129</div><div class="line number1130 index1129 alt1">1130</div><div class="line number1131 index1130 alt2">1131</div><div class="line number1132 index1131 alt1">1132</div><div class="line number1133 index1132 alt2">1133</div><div class="line number1134 index1133 alt1">1134</div><div class="line number1135 index1134 alt2">1135</div><div class="line number1136 index1135 alt1">1136</div><div class="line number1137 index1136 alt2">1137</div><div class="line number1138 index1137 alt1">1138</div><div class="line number1139 index1138 alt2">1139</div><div class="line number1140 index1139 alt1">1140</div><div class="line number1141 index1140 alt2">1141</div><div class="line number1142 index1141 alt1">1142</div><div class="line number1143 index1142 alt2">1143</div><div class="line number1144 index1143 alt1">1144</div><div class="line number1145 index1144 alt2">1145</div><div class="line number1146 index1145 alt1">1146</div><div class="line number1147 index1146 alt2">1147</div><div class="line number1148 index1147 alt1">1148</div><div class="line number1149 index1148 alt2">1149</div><div class="line number1150 index1149 alt1">1150</div><div class="line number1151 index1150 alt2">1151</div><div class="line number1152 index1151 alt1">1152</div><div class="line number1153 index1152 alt2">1153</div><div class="line number1154 index1153 alt1">1154</div><div class="line number1155 index1154 alt2">1155</div><div class="line number1156 index1155 alt1">1156</div><div class="line number1157 index1156 alt2">1157</div><div class="line number1158 index1157 alt1">1158</div><div class="line number1159 index1158 alt2">1159</div><div class="line number1160 index1159 alt1">1160</div><div class="line number1161 index1160 alt2">1161</div><div class="line number1162 index1161 alt1">1162</div><div class="line number1163 index1162 alt2">1163</div><div class="line number1164 index1163 alt1">1164</div><div class="line number1165 index1164 alt2">1165</div><div class="line number1166 index1165 alt1">1166</div><div class="line number1167 index1166 alt2">1167</div><div class="line number1168 index1167 alt1">1168</div><div class="line number1169 index1168 alt2">1169</div><div class="line number1170 index1169 alt1">1170</div><div class="line number1171 index1170 alt2">1171</div><div class="line number1172 index1171 alt1">1172</div><div class="line number1173 index1172 alt2">1173</div><div class="line number1174 index1173 alt1">1174</div><div class="line number1175 index1174 alt2">1175</div><div class="line number1176 index1175 alt1">1176</div><div class="line number1177 index1176 alt2">1177</div><div class="line number1178 index1177 alt1">1178</div><div class="line number1179 index1178 alt2">1179</div><div class="line number1180 index1179 alt1">1180</div><div class="line number1181 index1180 alt2">1181</div><div class="line number1182 index1181 alt1">1182</div><div class="line number1183 index1182 alt2">1183</div><div class="line number1184 index1183 alt1">1184</div><div class="line number1185 index1184 alt2">1185</div><div class="line number1186 index1185 alt1">1186</div><div class="line number1187 index1186 alt2">1187</div><div class="line number1188 index1187 alt1">1188</div><div class="line number1189 index1188 alt2">1189</div><div class="line number1190 index1189 alt1">1190</div><div class="line number1191 index1190 alt2">1191</div><div class="line number1192 index1191 alt1">1192</div><div class="line number1193 index1192 alt2">1193</div><div class="line number1194 index1193 alt1">1194</div><div class="line number1195 index1194 alt2">1195</div><div class="line number1196 index1195 alt1">1196</div><div class="line number1197 index1196 alt2">1197</div><div class="line number1198 index1197 alt1">1198</div><div class="line number1199 index1198 alt2">1199</div><div class="line number1200 index1199 alt1">1200</div><div class="line number1201 index1200 alt2">1201</div><div class="line number1202 index1201 alt1">1202</div><div class="line number1203 index1202 alt2">1203</div><div class="line number1204 index1203 alt1">1204</div><div class="line number1205 index1204 alt2">1205</div><div class="line number1206 index1205 alt1">1206</div><div class="line number1207 index1206 alt2">1207</div><div class="line number1208 index1207 alt1">1208</div><div class="line number1209 index1208 alt2">1209</div><div class="line number1210 index1209 alt1">1210</div><div class="line number1211 index1210 alt2">1211</div><div class="line number1212 index1211 alt1">1212</div><div class="line number1213 index1212 alt2">1213</div><div class="line number1214 index1213 alt1">1214</div><div class="line number1215 index1214 alt2">1215</div><div class="line number1216 index1215 alt1">1216</div><div class="line number1217 index1216 alt2">1217</div><div class="line number1218 index1217 alt1">1218</div><div class="line number1219 index1218 alt2">1219</div><div class="line number1220 index1219 alt1">1220</div><div class="line number1221 index1220 alt2">1221</div><div class="line number1222 index1221 alt1">1222</div><div class="line number1223 index1222 alt2">1223</div><div class="line number1224 index1223 alt1">1224</div><div class="line number1225 index1224 alt2">1225</div><div class="line number1226 index1225 alt1">1226</div><div class="line number1227 index1226 alt2">1227</div><div class="line number1228 index1227 alt1">1228</div><div class="line number1229 index1228 alt2">1229</div><div class="line number1230 index1229 alt1">1230</div><div class="line number1231 index1230 alt2">1231</div><div class="line number1232 index1231 alt1">1232</div><div class="line number1233 index1232 alt2">1233</div><div class="line number1234 index1233 alt1">1234</div><div class="line number1235 index1234 alt2">1235</div><div class="line number1236 index1235 alt1">1236</div><div class="line number1237 index1236 alt2">1237</div><div class="line number1238 index1237 alt1">1238</div><div class="line number1239 index1238 alt2">1239</div><div class="line number1240 index1239 alt1">1240</div><div class="line number1241 index1240 alt2">1241</div><div class="line number1242 index1241 alt1">1242</div><div class="line number1243 index1242 alt2">1243</div><div class="line number1244 index1243 alt1">1244</div><div class="line number1245 index1244 alt2">1245</div><div class="line number1246 index1245 alt1">1246</div><div class="line number1247 index1246 alt2">1247</div><div class="line number1248 index1247 alt1">1248</div><div class="line number1249 index1248 alt2">1249</div><div class="line number1250 index1249 alt1">1250</div><div class="line number1251 index1250 alt2">1251</div><div class="line number1252 index1251 alt1">1252</div><div class="line number1253 index1252 alt2">1253</div><div class="line number1254 index1253 alt1">1254</div><div class="line number1255 index1254 alt2">1255</div><div class="line number1256 index1255 alt1">1256</div><div class="line number1257 index1256 alt2">1257</div><div class="line number1258 index1257 alt1">1258</div><div class="line number1259 index1258 alt2">1259</div><div class="line number1260 index1259 alt1">1260</div><div class="line number1261 index1260 alt2">1261</div><div class="line number1262 index1261 alt1">1262</div><div class="line number1263 index1262 alt2">1263</div><div class="line number1264 index1263 alt1">1264</div><div class="line number1265 index1264 alt2">1265</div><div class="line number1266 index1265 alt1">1266</div><div class="line number1267 index1266 alt2">1267</div><div class="line number1268 index1267 alt1">1268</div><div class="line number1269 index1268 alt2">1269</div><div class="line number1270 index1269 alt1">1270</div><div class="line number1271 index1270 alt2">1271</div><div class="line number1272 index1271 alt1">1272</div><div class="line number1273 index1272 alt2">1273</div><div class="line number1274 index1273 alt1">1274</div><div class="line number1275 index1274 alt2">1275</div><div class="line number1276 index1275 alt1">1276</div><div class="line number1277 index1276 alt2">1277</div><div class="line number1278 index1277 alt1">1278</div><div class="line number1279 index1278 alt2">1279</div><div class="line number1280 index1279 alt1">1280</div><div class="line number1281 index1280 alt2">1281</div><div class="line number1282 index1281 alt1">1282</div><div class="line number1283 index1282 alt2">1283</div><div class="line number1284 index1283 alt1">1284</div><div class="line number1285 index1284 alt2">1285</div><div class="line number1286 index1285 alt1">1286</div><div class="line number1287 index1286 alt2">1287</div><div class="line number1288 index1287 alt1">1288</div><div class="line number1289 index1288 alt2">1289</div><div class="line number1290 index1289 alt1">1290</div><div class="line number1291 index1290 alt2">1291</div><div class="line number1292 index1291 alt1">1292</div><div class="line number1293 index1292 alt2">1293</div><div class="line number1294 index1293 alt1">1294</div><div class="line number1295 index1294 alt2">1295</div><div class="line number1296 index1295 alt1">1296</div><div class="line number1297 index1296 alt2">1297</div><div class="line number1298 index1297 alt1">1298</div><div class="line number1299 index1298 alt2">1299</div><div class="line number1300 index1299 alt1">1300</div><div class="line number1301 index1300 alt2">1301</div><div class="line number1302 index1301 alt1">1302</div><div class="line number1303 index1302 alt2">1303</div><div class="line number1304 index1303 alt1">1304</div><div class="line number1305 index1304 alt2">1305</div><div class="line number1306 index1305 alt1">1306</div><div class="line number1307 index1306 alt2">1307</div><div class="line number1308 index1307 alt1">1308</div><div class="line number1309 index1308 alt2">1309</div><div class="line number1310 index1309 alt1">1310</div><div class="line number1311 index1310 alt2">1311</div><div class="line number1312 index1311 alt1">1312</div><div class="line number1313 index1312 alt2">1313</div><div class="line number1314 index1313 alt1">1314</div><div class="line number1315 index1314 alt2">1315</div><div class="line number1316 index1315 alt1">1316</div><div class="line number1317 index1316 alt2">1317</div><div class="line number1318 index1317 alt1">1318</div><div class="line number1319 index1318 alt2">1319</div><div class="line number1320 index1319 alt1">1320</div><div class="line number1321 index1320 alt2">1321</div><div class="line number1322 index1321 alt1">1322</div><div class="line number1323 index1322 alt2">1323</div><div class="line number1324 index1323 alt1">1324</div><div class="line number1325 index1324 alt2">1325</div><div class="line number1326 index1325 alt1">1326</div><div class="line number1327 index1326 alt2">1327</div><div class="line number1328 index1327 alt1">1328</div><div class="line number1329 index1328 alt2">1329</div><div class="line number1330 index1329 alt1">1330</div><div class="line number1331 index1330 alt2">1331</div><div class="line number1332 index1331 alt1">1332</div><div class="line number1333 index1332 alt2">1333</div><div class="line number1334 index1333 alt1">1334</div><div class="line number1335 index1334 alt2">1335</div><div class="line number1336 index1335 alt1">1336</div><div class="line number1337 index1336 alt2">1337</div><div class="line number1338 index1337 alt1">1338</div><div class="line number1339 index1338 alt2">1339</div><div class="line number1340 index1339 alt1">1340</div><div class="line number1341 index1340 alt2">1341</div><div class="line number1342 index1341 alt1">1342</div><div class="line number1343 index1342 alt2">1343</div><div class="line number1344 index1343 alt1">1344</div><div class="line number1345 index1344 alt2">1345</div><div class="line number1346 index1345 alt1">1346</div><div class="line number1347 index1346 alt2">1347</div><div class="line number1348 index1347 alt1">1348</div><div class="line number1349 index1348 alt2">1349</div><div class="line number1350 index1349 alt1">1350</div><div class="line number1351 index1350 alt2">1351</div><div class="line number1352 index1351 alt1">1352</div><div class="line number1353 index1352 alt2">1353</div><div class="line number1354 index1353 alt1">1354</div><div class="line number1355 index1354 alt2">1355</div><div class="line number1356 index1355 alt1">1356</div><div class="line number1357 index1356 alt2">1357</div><div class="line number1358 index1357 alt1">1358</div><div class="line number1359 index1358 alt2">1359</div><div class="line number1360 index1359 alt1">1360</div><div class="line number1361 index1360 alt2">1361</div><div class="line number1362 index1361 alt1">1362</div><div class="line number1363 index1362 alt2">1363</div><div class="line number1364 index1363 alt1">1364</div><div class="line number1365 index1364 alt2">1365</div><div class="line number1366 index1365 alt1">1366</div><div class="line number1367 index1366 alt2">1367</div><div class="line number1368 index1367 alt1">1368</div><div class="line number1369 index1368 alt2">1369</div><div class="line number1370 index1369 alt1">1370</div><div class="line number1371 index1370 alt2">1371</div><div class="line number1372 index1371 alt1">1372</div><div class="line number1373 index1372 alt2">1373</div><div class="line number1374 index1373 alt1">1374</div><div class="line number1375 index1374 alt2">1375</div><div class="line number1376 index1375 alt1">1376</div><div class="line number1377 index1376 alt2">1377</div><div class="line number1378 index1377 alt1">1378</div><div class="line number1379 index1378 alt2">1379</div><div class="line number1380 index1379 alt1">1380</div><div class="line number1381 index1380 alt2">1381</div><div class="line number1382 index1381 alt1">1382</div><div class="line number1383 index1382 alt2">1383</div><div class="line number1384 index1383 alt1">1384</div><div class="line number1385 index1384 alt2">1385</div><div class="line number1386 index1385 alt1">1386</div><div class="line number1387 index1386 alt2">1387</div><div class="line number1388 index1387 alt1">1388</div><div class="line number1389 index1388 alt2">1389</div><div class="line number1390 index1389 alt1">1390</div><div class="line number1391 index1390 alt2">1391</div><div class="line number1392 index1391 alt1">1392</div><div class="line number1393 index1392 alt2">1393</div><div class="line number1394 index1393 alt1">1394</div><div class="line number1395 index1394 alt2">1395</div><div class="line number1396 index1395 alt1">1396</div><div class="line number1397 index1396 alt2">1397</div><div class="line number1398 index1397 alt1">1398</div><div class="line number1399 index1398 alt2">1399</div><div class="line number1400 index1399 alt1">1400</div><div class="line number1401 index1400 alt2">1401</div><div class="line number1402 index1401 alt1">1402</div><div class="line number1403 index1402 alt2">1403</div><div class="line number1404 index1403 alt1">1404</div><div class="line number1405 index1404 alt2">1405</div><div class="line number1406 index1405 alt1">1406</div><div class="line number1407 index1406 alt2">1407</div><div class="line number1408 index1407 alt1">1408</div><div class="line number1409 index1408 alt2">1409</div><div class="line number1410 index1409 alt1">1410</div><div class="line number1411 index1410 alt2">1411</div><div class="line number1412 index1411 alt1">1412</div><div class="line number1413 index1412 alt2">1413</div><div class="line number1414 index1413 alt1">1414</div><div class="line number1415 index1414 alt2">1415</div><div class="line number1416 index1415 alt1">1416</div><div class="line number1417 index1416 alt2">1417</div><div class="line number1418 index1417 alt1">1418</div><div class="line number1419 index1418 alt2">1419</div><div class="line number1420 index1419 alt1">1420</div><div class="line number1421 index1420 alt2">1421</div><div class="line number1422 index1421 alt1">1422</div><div class="line number1423 index1422 alt2">1423</div><div class="line number1424 index1423 alt1">1424</div><div class="line number1425 index1424 alt2">1425</div><div class="line number1426 index1425 alt1">1426</div><div class="line number1427 index1426 alt2">1427</div><div class="line number1428 index1427 alt1">1428</div><div class="line number1429 index1428 alt2">1429</div><div class="line number1430 index1429 alt1">1430</div><div class="line number1431 index1430 alt2">1431</div><div class="line number1432 index1431 alt1">1432</div><div class="line number1433 index1432 alt2">1433</div><div class="line number1434 index1433 alt1">1434</div><div class="line number1435 index1434 alt2">1435</div><div class="line number1436 index1435 alt1">1436</div><div class="line number1437 index1436 alt2">1437</div><div class="line number1438 index1437 alt1">1438</div><div class="line number1439 index1438 alt2">1439</div><div class="line number1440 index1439 alt1">1440</div><div class="line number1441 index1440 alt2">1441</div><div class="line number1442 index1441 alt1">1442</div><div class="line number1443 index1442 alt2">1443</div><div class="line number1444 index1443 alt1">1444</div><div class="line number1445 index1444 alt2">1445</div><div class="line number1446 index1445 alt1">1446</div><div class="line number1447 index1446 alt2">1447</div><div class="line number1448 index1447 alt1">1448</div><div class="line number1449 index1448 alt2">1449</div><div class="line number1450 index1449 alt1">1450</div><div class="line number1451 index1450 alt2">1451</div><div class="line number1452 index1451 alt1">1452</div><div class="line number1453 index1452 alt2">1453</div><div class="line number1454 index1453 alt1">1454</div><div class="line number1455 index1454 alt2">1455</div><div class="line number1456 index1455 alt1">1456</div><div class="line number1457 index1456 alt2">1457</div><div class="line number1458 index1457 alt1">1458</div><div class="line number1459 index1458 alt2">1459</div><div class="line number1460 index1459 alt1">1460</div><div class="line number1461 index1460 alt2">1461</div><div class="line number1462 index1461 alt1">1462</div><div class="line number1463 index1462 alt2">1463</div><div class="line number1464 index1463 alt1">1464</div><div class="line number1465 index1464 alt2">1465</div><div class="line number1466 index1465 alt1">1466</div><div class="line number1467 index1466 alt2">1467</div><div class="line number1468 index1467 alt1">1468</div><div class="line number1469 index1468 alt2">1469</div><div class="line number1470 index1469 alt1">1470</div><div class="line number1471 index1470 alt2">1471</div><div class="line number1472 index1471 alt1">1472</div><div class="line number1473 index1472 alt2">1473</div><div class="line number1474 index1473 alt1">1474</div><div class="line number1475 index1474 alt2">1475</div><div class="line number1476 index1475 alt1">1476</div><div class="line number1477 index1476 alt2">1477</div><div class="line number1478 index1477 alt1">1478</div><div class="line number1479 index1478 alt2">1479</div><div class="line number1480 index1479 alt1">1480</div><div class="line number1481 index1480 alt2">1481</div><div class="line number1482 index1481 alt1">1482</div><div class="line number1483 index1482 alt2">1483</div><div class="line number1484 index1483 alt1">1484</div><div class="line number1485 index1484 alt2">1485</div><div class="line number1486 index1485 alt1">1486</div><div class="line number1487 index1486 alt2">1487</div><div class="line number1488 index1487 alt1">1488</div><div class="line number1489 index1488 alt2">1489</div><div class="line number1490 index1489 alt1">1490</div><div class="line number1491 index1490 alt2">1491</div><div class="line number1492 index1491 alt1">1492</div><div class="line number1493 index1492 alt2">1493</div><div class="line number1494 index1493 alt1">1494</div><div class="line number1495 index1494 alt2">1495</div><div class="line number1496 index1495 alt1">1496</div><div class="line number1497 index1496 alt2">1497</div><div class="line number1498 index1497 alt1">1498</div><div class="line number1499 index1498 alt2">1499</div><div class="line number1500 index1499 alt1">1500</div><div class="line number1501 index1500 alt2">1501</div><div class="line number1502 index1501 alt1">1502</div><div class="line number1503 index1502 alt2">1503</div><div class="line number1504 index1503 alt1">1504</div><div class="line number1505 index1504 alt2">1505</div><div class="line number1506 index1505 alt1">1506</div><div class="line number1507 index1506 alt2">1507</div><div class="line number1508 index1507 alt1">1508</div><div class="line number1509 index1508 alt2">1509</div><div class="line number1510 index1509 alt1">1510</div><div class="line number1511 index1510 alt2">1511</div><div class="line number1512 index1511 alt1">1512</div><div class="line number1513 index1512 alt2">1513</div><div class="line number1514 index1513 alt1">1514</div><div class="line number1515 index1514 alt2">1515</div><div class="line number1516 index1515 alt1">1516</div><div class="line number1517 index1516 alt2">1517</div><div class="line number1518 index1517 alt1">1518</div><div class="line number1519 index1518 alt2">1519</div><div class="line number1520 index1519 alt1">1520</div><div class="line number1521 index1520 alt2">1521</div><div class="line number1522 index1521 alt1">1522</div><div class="line number1523 index1522 alt2">1523</div><div class="line number1524 index1523 alt1">1524</div><div class="line number1525 index1524 alt2">1525</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java comments">/*</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* This code is free software; you can redistribute it and/or modify it</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* under the terms of the GNU General Public License version 2 only, as</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* published by the Free Software Foundation.&nbsp; Oracle designates this</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* particular file as subject to the "Classpath" exception as provided</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* by Oracle in the LICENSE file that accompanied this code.</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* This code is distributed in the hope that it will be useful, but WITHOUT</code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* FITNESS FOR A PARTICULAR PURPOSE.&nbsp; See the GNU General Public License</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* version 2 for more details (a copy is included in the LICENSE file that</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* accompanied this code).</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* You should have received a copy of the GNU General Public License version</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* 2 along with this work; if not, write to the Free Software Foundation,</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* or visit www.oracle.com if you need additional information or have any</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* questions.</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*/</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="java comments">/*</code></div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* This file is available under and governed by the GNU General Public</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* License version 2 only, as published by the Free Software Foundation.</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* However, the following notice accompanied the original version of this</code></div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* file:</code></div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* Written by Doug Lea with assistance from members of JCP JSR-166</code></div><div class="line number32 index31 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* Expert Group and released to the public domain, as explained at</code></div><div class="line number33 index32 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* <a href="http://creativecommons.org/licenses/publicdomain">http://creativecommons.org/licenses/publicdomain</a></code></div><div class="line number34 index33 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">*/</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="java keyword">package</code> <code class="java plain">java.util.concurrent;</code></div><div class="line number37 index36 alt2"><code class="java keyword">import</code> <code class="java plain">java.util.concurrent.locks.*;</code></div><div class="line number38 index37 alt1"><code class="java keyword">import</code> <code class="java plain">java.util.*;</code></div><div class="line number39 index38 alt2"><code class="java keyword">import</code> <code class="java plain">java.io.Serializable;</code></div><div class="line number40 index39 alt1"><code class="java keyword">import</code> <code class="java plain">java.io.IOException;</code></div><div class="line number41 index40 alt2"><code class="java keyword">import</code> <code class="java plain">java.io.ObjectInputStream;</code></div><div class="line number42 index41 alt1"><code class="java keyword">import</code> <code class="java plain">java.io.ObjectOutputStream;</code></div><div class="line number43 index42 alt2"><code class="java keyword">import</code> <code class="java plain">java.io.ObjectStreamField;</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="java preprocessor">/**</code></div><div class="line number46 index45 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* A hash table supporting full concurrency of retrievals and</code></div><div class="line number47 index46 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* adjustable expected concurrency for updates. This class obeys the</code></div><div class="line number48 index47 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* same functional specification as {@link java.util.Hashtable}, and</code></div><div class="line number49 index48 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* includes versions of methods corresponding to each method of</code></div><div class="line number50 index49 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;Hashtable&lt;/tt&gt;. However, even though all operations are</code></div><div class="line number51 index50 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* thread-safe, retrieval operations do &lt;em&gt;not&lt;/em&gt; entail locking,</code></div><div class="line number52 index51 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* and there is &lt;em&gt;not&lt;/em&gt; any support for locking the entire table</code></div><div class="line number53 index52 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* in a way that prevents all access.&nbsp; This class is fully</code></div><div class="line number54 index53 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* interoperable with &lt;tt&gt;Hashtable&lt;/tt&gt; in programs that rely on its</code></div><div class="line number55 index54 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* thread safety but not on its synchronization details.</code></div><div class="line number56 index55 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number57 index56 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt; Retrieval operations (including &lt;tt&gt;get&lt;/tt&gt;) generally do not</code></div><div class="line number58 index57 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* block, so may overlap with update operations (including</code></div><div class="line number59 index58 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;put&lt;/tt&gt; and &lt;tt&gt;remove&lt;/tt&gt;). Retrievals reflect the results</code></div><div class="line number60 index59 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* of the most recently &lt;em&gt;completed&lt;/em&gt; update operations holding</code></div><div class="line number61 index60 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* upon their onset.&nbsp; For aggregate operations such as &lt;tt&gt;putAll&lt;/tt&gt;</code></div><div class="line number62 index61 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* and &lt;tt&gt;clear&lt;/tt&gt;, concurrent retrievals may reflect insertion or</code></div><div class="line number63 index62 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* removal of only some entries.&nbsp; Similarly, Iterators and</code></div><div class="line number64 index63 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Enumerations return elements reflecting the state of the hash table</code></div><div class="line number65 index64 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* at some point at or since the creation of the iterator/enumeration.</code></div><div class="line number66 index65 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* They do &lt;em&gt;not&lt;/em&gt; throw {@link ConcurrentModificationException}.</code></div><div class="line number67 index66 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* However, iterators are designed to be used by only one thread at a time.</code></div><div class="line number68 index67 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number69 index68 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt; The allowed concurrency among update operations is guided by</code></div><div class="line number70 index69 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* the optional &lt;tt&gt;concurrencyLevel&lt;/tt&gt; constructor argument</code></div><div class="line number71 index70 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* (default &lt;tt&gt;16&lt;/tt&gt;), which is used as a hint for internal sizing.&nbsp; The</code></div><div class="line number72 index71 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* table is internally partitioned to try to permit the indicated</code></div><div class="line number73 index72 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* number of concurrent updates without contention. Because placement</code></div><div class="line number74 index73 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* in hash tables is essentially random, the actual concurrency will</code></div><div class="line number75 index74 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* vary.&nbsp; Ideally, you should choose a value to accommodate as many</code></div><div class="line number76 index75 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* threads as will ever concurrently modify the table. Using a</code></div><div class="line number77 index76 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* significantly higher value than you need can waste space and time,</code></div><div class="line number78 index77 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* and a significantly lower value can lead to thread contention. But</code></div><div class="line number79 index78 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* overestimates and underestimates within an order of magnitude do</code></div><div class="line number80 index79 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* not usually have much noticeable impact. A value of one is</code></div><div class="line number81 index80 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* appropriate when it is known that only one thread will modify and</code></div><div class="line number82 index81 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* all others will only read. Also, resizing this or any other kind of</code></div><div class="line number83 index82 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* hash table is a relatively slow operation, so, when possible, it is</code></div><div class="line number84 index83 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* a good idea to provide estimates of expected table sizes in</code></div><div class="line number85 index84 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* constructors.</code></div><div class="line number86 index85 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number87 index86 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt;This class and its views and iterators implement all of the</code></div><div class="line number88 index87 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;em&gt;optional&lt;/em&gt; methods of the {@link Map} and {@link Iterator}</code></div><div class="line number89 index88 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* interfaces.</code></div><div class="line number90 index89 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number91 index90 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt; Like {@link Hashtable} but unlike {@link HashMap}, this class</code></div><div class="line number92 index91 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* does &lt;em&gt;not&lt;/em&gt; allow &lt;tt&gt;null&lt;/tt&gt; to be used as a key or value.</code></div><div class="line number93 index92 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number94 index93 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt;This class is a member of the</code></div><div class="line number95 index94 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;a href="{@docRoot}/../technotes/guides/collections/index.html"&gt;</code></div><div class="line number96 index95 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Java Collections Framework&lt;/a&gt;.</code></div><div class="line number97 index96 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number98 index97 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* @since 1.5</code></div><div class="line number99 index98 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* @author Doug Lea</code></div><div class="line number100 index99 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* @param &lt;K&gt; the type of keys maintained by this map</code></div><div class="line number101 index100 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* @param &lt;V&gt; the type of mapped values</code></div><div class="line number102 index101 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number103 index102 alt2"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">ConcurrentHashMap&lt;K, V&gt; </code><code class="java keyword">extends</code> <code class="java plain">AbstractMap&lt;K, V&gt;</code></div><div class="line number104 index103 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">implements</code> <code class="java plain">ConcurrentMap&lt;K, V&gt;, Serializable {</code></div><div class="line number105 index104 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">serialVersionUID = 7249069246763182397L;</code></div><div class="line number106 index105 alt1">&nbsp;</div><div class="line number107 index106 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/*</code></div><div class="line number108 index107 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* The basic strategy is to subdivide the table among Segments,</code></div><div class="line number109 index108 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* each of which itself is a concurrently readable hash table.&nbsp; To</code></div><div class="line number110 index109 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* reduce footprint, all but one segments are constructed only</code></div><div class="line number111 index110 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* when first needed (see ensureSegment). To maintain visibility</code></div><div class="line number112 index111 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* in the presence of lazy construction, accesses to segments as</code></div><div class="line number113 index112 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* well as elements of segment's table must use volatile access,</code></div><div class="line number114 index113 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* which is done via Unsafe within methods segmentAt etc</code></div><div class="line number115 index114 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* below. These provide the functionality of AtomicReferenceArrays</code></div><div class="line number116 index115 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* but reduce the levels of indirection. Additionally,</code></div><div class="line number117 index116 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* volatile-writes of table elements and entry "next" fields</code></div><div class="line number118 index117 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* within locked operations use the cheaper "lazySet" forms of</code></div><div class="line number119 index118 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* writes (via putOrderedObject) because these writes are always</code></div><div class="line number120 index119 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* followed by lock releases that maintain sequential consistency</code></div><div class="line number121 index120 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* of table updates.</code></div><div class="line number122 index121 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">*</code></div><div class="line number123 index122 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* Historical note: The previous version of this class relied</code></div><div class="line number124 index123 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* heavily on "final" fields, which avoided some volatile reads at</code></div><div class="line number125 index124 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* the expense of a large initial footprint.&nbsp; Some remnants of</code></div><div class="line number126 index125 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* that design (including forced construction of segment 0) exist</code></div><div class="line number127 index126 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* to ensure serialization compatibility.</code></div><div class="line number128 index127 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">*/</code></div><div class="line number129 index128 alt2">&nbsp;</div><div class="line number130 index129 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/* ---------------- Constants -------------- */</code></div><div class="line number131 index130 alt2">&nbsp;</div><div class="line number132 index131 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number133 index132 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The default initial capacity for this table,</code></div><div class="line number134 index133 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* used when not otherwise specified in a constructor.</code></div><div class="line number135 index134 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number136 index135 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">DEFAULT_INITIAL_CAPACITY = </code><code class="java value">16</code><code class="java plain">;</code></div><div class="line number137 index136 alt2">&nbsp;</div><div class="line number138 index137 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number139 index138 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The default load factor for this table, used when not</code></div><div class="line number140 index139 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* otherwise specified in a constructor.</code></div><div class="line number141 index140 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number142 index141 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">float</code> <code class="java plain">DEFAULT_LOAD_FACTOR = </code><code class="java value">0</code><code class="java plain">.75f;</code></div><div class="line number143 index142 alt2">&nbsp;</div><div class="line number144 index143 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number145 index144 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The default concurrency level for this table, used when not</code></div><div class="line number146 index145 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* otherwise specified in a constructor.</code></div><div class="line number147 index146 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number148 index147 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">DEFAULT_CONCURRENCY_LEVEL = </code><code class="java value">16</code><code class="java plain">;</code></div><div class="line number149 index148 alt2">&nbsp;</div><div class="line number150 index149 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number151 index150 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The maximum capacity, used if a higher value is implicitly</code></div><div class="line number152 index151 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* specified by either of the constructors with arguments.&nbsp; MUST</code></div><div class="line number153 index152 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* be a power of two &lt;= 1&lt;&lt;30 to ensure that entries are indexable</code></div><div class="line number154 index153 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* using ints.</code></div><div class="line number155 index154 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number156 index155 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">MAXIMUM_CAPACITY = </code><code class="java value">1</code> <code class="java plain">&lt;&lt; </code><code class="java value">30</code><code class="java plain">;</code></div><div class="line number157 index156 alt2">&nbsp;</div><div class="line number158 index157 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number159 index158 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The minimum capacity for per-segment tables.&nbsp; Must be a power</code></div><div class="line number160 index159 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* of two, at least two to avoid immediate resizing on next use</code></div><div class="line number161 index160 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* after lazy construction.</code></div><div class="line number162 index161 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number163 index162 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">MIN_SEGMENT_TABLE_CAPACITY = </code><code class="java value">2</code><code class="java plain">;</code></div><div class="line number164 index163 alt1">&nbsp;</div><div class="line number165 index164 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number166 index165 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The maximum number of segments to allow; used to bound</code></div><div class="line number167 index166 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* constructor arguments. Must be power of two less than 1 &lt;&lt; 24.</code></div><div class="line number168 index167 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number169 index168 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">MAX_SEGMENTS = </code><code class="java value">1</code> <code class="java plain">&lt;&lt; </code><code class="java value">16</code><code class="java plain">; </code><code class="java comments">// slightly conservative</code></div><div class="line number170 index169 alt1">&nbsp;</div><div class="line number171 index170 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number172 index171 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Number of unsynchronized retries in size and containsValue</code></div><div class="line number173 index172 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* methods before resorting to locking. This is used to avoid</code></div><div class="line number174 index173 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* unbounded retries if tables undergo continuous modification</code></div><div class="line number175 index174 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* which would make it impossible to obtain an accurate result.</code></div><div class="line number176 index175 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number177 index176 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">RETRIES_BEFORE_LOCK = </code><code class="java value">2</code><code class="java plain">;</code></div><div class="line number178 index177 alt1">&nbsp;</div><div class="line number179 index178 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/* ---------------- Fields -------------- */</code></div><div class="line number180 index179 alt1">&nbsp;</div><div class="line number181 index180 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number182 index181 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Mask value for indexing into segments. The upper bits of a</code></div><div class="line number183 index182 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* key's hash code are used to choose the segment.</code></div><div class="line number184 index183 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number185 index184 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">segmentMask;</code></div><div class="line number186 index185 alt1">&nbsp;</div><div class="line number187 index186 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number188 index187 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Shift value for indexing within segments.</code></div><div class="line number189 index188 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number190 index189 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">segmentShift;</code></div><div class="line number191 index190 alt2">&nbsp;</div><div class="line number192 index191 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number193 index192 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The segments, each of which is a specialized hash table.</code></div><div class="line number194 index193 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number195 index194 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] segments;</code></div><div class="line number196 index195 alt1">&nbsp;</div><div class="line number197 index196 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">transient</code> <code class="java plain">Set&lt;K&gt; keySet;</code></div><div class="line number198 index197 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">transient</code> <code class="java plain">Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;</code></div><div class="line number199 index198 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">transient</code> <code class="java plain">Collection&lt;V&gt; values;</code></div><div class="line number200 index199 alt1">&nbsp;</div><div class="line number201 index200 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number202 index201 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* ConcurrentHashMap list entry. Note that this is never exported</code></div><div class="line number203 index202 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* out as a user-visible Map.Entry.</code></div><div class="line number204 index203 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number205 index204 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">HashEntry&lt;K,V&gt; {</code></div><div class="line number206 index205 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">hash;</code></div><div class="line number207 index206 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">K key;</code></div><div class="line number208 index207 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">volatile</code> <code class="java plain">V value;</code></div><div class="line number209 index208 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">volatile</code> <code class="java plain">HashEntry&lt;K,V&gt; next;</code></div><div class="line number210 index209 alt1">&nbsp;</div><div class="line number211 index210 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry(</code><code class="java keyword">int</code> <code class="java plain">hash, K key, V value, HashEntry&lt;K,V&gt; next) {</code></div><div class="line number212 index211 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.hash = hash;</code></div><div class="line number213 index212 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.key = key;</code></div><div class="line number214 index213 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.value = value;</code></div><div class="line number215 index214 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.next = next;</code></div><div class="line number216 index215 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number217 index216 alt2">&nbsp;</div><div class="line number218 index217 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number219 index218 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Sets next field with volatile write semantics.&nbsp; (See above</code></div><div class="line number220 index219 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* about use of putOrderedObject.)</code></div><div class="line number221 index220 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number222 index221 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">void</code> <code class="java plain">setNext(HashEntry&lt;K,V&gt; n) {</code></div><div class="line number223 index222 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">UNSAFE.putOrderedObject(</code><code class="java keyword">this</code><code class="java plain">, nextOffset, n);</code></div><div class="line number224 index223 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number225 index224 alt2">&nbsp;</div><div class="line number226 index225 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Unsafe mechanics</code></div><div class="line number227 index226 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java plain">sun.misc.Unsafe UNSAFE;</code></div><div class="line number228 index227 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">nextOffset;</code></div><div class="line number229 index228 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java plain">{</code></div><div class="line number230 index229 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number231 index230 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">UNSAFE = sun.misc.Unsafe.getUnsafe();</code></div><div class="line number232 index231 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Class k = HashEntry.</code><code class="java keyword">class</code><code class="java plain">;</code></div><div class="line number233 index232 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextOffset = UNSAFE.objectFieldOffset</code></div><div class="line number234 index233 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(k.getDeclaredField(</code><code class="java string">"next"</code><code class="java plain">));</code></div><div class="line number235 index234 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">catch</code> <code class="java plain">(Exception e) {</code></div><div class="line number236 index235 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">Error(e);</code></div><div class="line number237 index236 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number238 index237 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number239 index238 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number240 index239 alt1">&nbsp;</div><div class="line number241 index240 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number242 index241 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Gets the ith element of given table (if nonnull) with volatile</code></div><div class="line number243 index242 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* read semantics.</code></div><div class="line number244 index243 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number245 index244 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@SuppressWarnings</code><code class="java plain">(</code><code class="java string">"unchecked"</code><code class="java plain">)</code></div><div class="line number246 index245 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java plain">&lt;K,V&gt; HashEntry&lt;K,V&gt; entryAt(HashEntry&lt;K,V&gt;[] tab, </code><code class="java keyword">int</code> <code class="java plain">i) {</code></div><div class="line number247 index246 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">(tab == </code><code class="java keyword">null</code><code class="java plain">) ? </code><code class="java keyword">null</code> <code class="java plain">:</code></div><div class="line number248 index247 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile</code></div><div class="line number249 index248 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(tab, ((</code><code class="java keyword">long</code><code class="java plain">)i &lt;&lt; TSHIFT) + TBASE);</code></div><div class="line number250 index249 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number251 index250 alt2">&nbsp;</div><div class="line number252 index251 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number253 index252 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Sets the ith element of given table, with volatile write</code></div><div class="line number254 index253 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* semantics. (See above about use of putOrderedObject.)</code></div><div class="line number255 index254 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number256 index255 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java plain">&lt;K,V&gt; </code><code class="java keyword">void</code> <code class="java plain">setEntryAt(HashEntry&lt;K,V&gt;[] tab, </code><code class="java keyword">int</code> <code class="java plain">i,</code></div><div class="line number257 index256 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e) {</code></div><div class="line number258 index257 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">UNSAFE.putOrderedObject(tab, ((</code><code class="java keyword">long</code><code class="java plain">)i &lt;&lt; TSHIFT) + TBASE, e);</code></div><div class="line number259 index258 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number260 index259 alt1">&nbsp;</div><div class="line number261 index260 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number262 index261 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Applies a supplemental hash function to a given hashCode, which</code></div><div class="line number263 index262 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* defends against poor quality hash functions.&nbsp; This is critical</code></div><div class="line number264 index263 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* because ConcurrentHashMap uses power-of-two length hash tables,</code></div><div class="line number265 index264 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* that otherwise encounter collisions for hashCodes that do not</code></div><div class="line number266 index265 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* differ in lower or upper bits.</code></div><div class="line number267 index266 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number268 index267 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">int</code> <code class="java plain">hash(</code><code class="java keyword">int</code> <code class="java plain">h) {</code></div><div class="line number269 index268 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Spread bits to regularize both segment and index locations,</code></div><div class="line number270 index269 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// using variant of single-word Wang/Jenkins hash.</code></div><div class="line number271 index270 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">h += (h &lt;&lt;&nbsp; </code><code class="java value">15</code><code class="java plain">) ^ </code><code class="java value">0xffffcd7d</code><code class="java plain">;</code></div><div class="line number272 index271 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">h ^= (h &gt;&gt;&gt; </code><code class="java value">10</code><code class="java plain">);</code></div><div class="line number273 index272 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">h += (h &lt;&lt;&nbsp;&nbsp; </code><code class="java value">3</code><code class="java plain">);</code></div><div class="line number274 index273 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">h ^= (h &gt;&gt;&gt;&nbsp; </code><code class="java value">6</code><code class="java plain">);</code></div><div class="line number275 index274 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">h += (h &lt;&lt;&nbsp;&nbsp; </code><code class="java value">2</code><code class="java plain">) + (h &lt;&lt; </code><code class="java value">14</code><code class="java plain">);</code></div><div class="line number276 index275 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">h ^ (h &gt;&gt;&gt; </code><code class="java value">16</code><code class="java plain">);</code></div><div class="line number277 index276 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number278 index277 alt1">&nbsp;</div><div class="line number279 index278 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number280 index279 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Segments are specialized versions of hash tables.&nbsp; This</code></div><div class="line number281 index280 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* subclasses from ReentrantLock opportunistically, just to</code></div><div class="line number282 index281 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* simplify some locking and avoid separate construction.</code></div><div class="line number283 index282 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number284 index283 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">Segment&lt;K,V&gt; </code><code class="java keyword">extends</code> <code class="java plain">ReentrantLock </code><code class="java keyword">implements</code> <code class="java plain">Serializable {</code></div><div class="line number285 index284 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/*</code></div><div class="line number286 index285 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* Segments maintain a table of entry lists that are always</code></div><div class="line number287 index286 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* kept in a consistent state, so can be read (via volatile</code></div><div class="line number288 index287 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* reads of segments and tables) without locking.&nbsp; This</code></div><div class="line number289 index288 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* requires replicating nodes when necessary during table</code></div><div class="line number290 index289 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* resizing, so the old lists can be traversed by readers</code></div><div class="line number291 index290 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* still using old version of table.</code></div><div class="line number292 index291 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">*</code></div><div class="line number293 index292 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* This class defines only mutative methods requiring locking.</code></div><div class="line number294 index293 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* Except as noted, the methods of this class perform the</code></div><div class="line number295 index294 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* per-segment versions of ConcurrentHashMap methods.&nbsp; (Other</code></div><div class="line number296 index295 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* methods are integrated directly into ConcurrentHashMap</code></div><div class="line number297 index296 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* methods.) These mutative methods use a form of controlled</code></div><div class="line number298 index297 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* spinning on contention via methods scanAndLock and</code></div><div class="line number299 index298 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* scanAndLockForPut. These intersperse tryLocks with</code></div><div class="line number300 index299 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* traversals to locate nodes.&nbsp; The main benefit is to absorb</code></div><div class="line number301 index300 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* cache misses (which are very common for hash tables) while</code></div><div class="line number302 index301 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* obtaining locks so that traversal is faster once</code></div><div class="line number303 index302 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* acquired. We do not actually use the found nodes since they</code></div><div class="line number304 index303 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* must be re-acquired under lock anyway to ensure sequential</code></div><div class="line number305 index304 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* consistency of updates (and in any case may be undetectably</code></div><div class="line number306 index305 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* stale), but they will normally be much faster to re-locate.</code></div><div class="line number307 index306 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* Also, scanAndLockForPut speculatively creates a fresh node</code></div><div class="line number308 index307 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* to use in put if no node is found.</code></div><div class="line number309 index308 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">*/</code></div><div class="line number310 index309 alt1">&nbsp;</div><div class="line number311 index310 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">serialVersionUID = 2249069246763182397L;</code></div><div class="line number312 index311 alt1">&nbsp;</div><div class="line number313 index312 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number314 index313 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The maximum number of times to tryLock in a prescan before</code></div><div class="line number315 index314 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* possibly blocking on acquire in preparation for a locked</code></div><div class="line number316 index315 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* segment operation. On multiprocessors, using a bounded</code></div><div class="line number317 index316 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* number of retries maintains cache acquired while locating</code></div><div class="line number318 index317 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* nodes.</code></div><div class="line number319 index318 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number320 index319 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">MAX_SCAN_RETRIES =</code></div><div class="line number321 index320 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Runtime.getRuntime().availableProcessors() &gt; </code><code class="java value">1</code> <code class="java plain">? </code><code class="java value">64</code> <code class="java plain">: </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number322 index321 alt1">&nbsp;</div><div class="line number323 index322 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number324 index323 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The per-segment table. Elements are accessed via</code></div><div class="line number325 index324 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* entryAt/setEntryAt providing volatile semantics.</code></div><div class="line number326 index325 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number327 index326 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">transient</code> <code class="java keyword">volatile</code> <code class="java plain">HashEntry&lt;K,V&gt;[] table;</code></div><div class="line number328 index327 alt1">&nbsp;</div><div class="line number329 index328 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number330 index329 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The number of elements. Accessed only either within locks</code></div><div class="line number331 index330 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* or among other volatile reads that maintain visibility.</code></div><div class="line number332 index331 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number333 index332 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">transient</code> <code class="java keyword">int</code> <code class="java plain">count;</code></div><div class="line number334 index333 alt1">&nbsp;</div><div class="line number335 index334 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number336 index335 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The total number of mutative operations in this segment.</code></div><div class="line number337 index336 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Even though this may overflows 32 bits, it provides</code></div><div class="line number338 index337 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* sufficient accuracy for stability checks in CHM isEmpty()</code></div><div class="line number339 index338 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and size() methods.&nbsp; Accessed only either within locks or</code></div><div class="line number340 index339 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* among other volatile reads that maintain visibility.</code></div><div class="line number341 index340 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number342 index341 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">transient</code> <code class="java keyword">int</code> <code class="java plain">modCount;</code></div><div class="line number343 index342 alt2">&nbsp;</div><div class="line number344 index343 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number345 index344 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The table is rehashed when its size exceeds this threshold.</code></div><div class="line number346 index345 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* (The value of this field is always &lt;tt&gt;(int)(capacity *</code></div><div class="line number347 index346 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* loadFactor)&lt;/tt&gt;.)</code></div><div class="line number348 index347 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number349 index348 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">transient</code> <code class="java keyword">int</code> <code class="java plain">threshold;</code></div><div class="line number350 index349 alt1">&nbsp;</div><div class="line number351 index350 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number352 index351 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The load factor for the hash table.&nbsp; Even though this value</code></div><div class="line number353 index352 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* is same for all segments, it is replicated to avoid needing</code></div><div class="line number354 index353 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* links to outer object.</code></div><div class="line number355 index354 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @serial</code></div><div class="line number356 index355 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number357 index356 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">float</code> <code class="java plain">loadFactor;</code></div><div class="line number358 index357 alt1">&nbsp;</div><div class="line number359 index358 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment(</code><code class="java keyword">float</code> <code class="java plain">lf, </code><code class="java keyword">int</code> <code class="java plain">threshold, HashEntry&lt;K,V&gt;[] tab) {</code></div><div class="line number360 index359 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.loadFactor = lf;</code></div><div class="line number361 index360 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.threshold = threshold;</code></div><div class="line number362 index361 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.table = tab;</code></div><div class="line number363 index362 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number364 index363 alt1">&nbsp;</div><div class="line number365 index364 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">V put(K key, </code><code class="java keyword">int</code> <code class="java plain">hash, V value, </code><code class="java keyword">boolean</code> <code class="java plain">onlyIfAbsent) {</code></div><div class="line number366 index365 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; node = tryLock() ? </code><code class="java keyword">null</code> <code class="java plain">:</code></div><div class="line number367 index366 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">scanAndLockForPut(key, hash, value);</code></div><div class="line number368 index367 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V oldValue;</code></div><div class="line number369 index368 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number370 index369 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] tab = table;</code></div><div class="line number371 index370 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">index = (tab.length - </code><code class="java value">1</code><code class="java plain">) &amp; hash;</code></div><div class="line number372 index371 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; first = entryAt(tab, index);</code></div><div class="line number373 index372 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(HashEntry&lt;K,V&gt; e = first;;) {</code></div><div class="line number374 index373 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(e != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number375 index374 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">K k;</code></div><div class="line number376 index375 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((k = e.key) == key ||</code></div><div class="line number377 index376 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(e.hash == hash &amp;&amp; key.equals(k))) {</code></div><div class="line number378 index377 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">oldValue = e.value;</code></div><div class="line number379 index378 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(!onlyIfAbsent) {</code></div><div class="line number380 index379 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e.value = value;</code></div><div class="line number381 index380 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++modCount;</code></div><div class="line number382 index381 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number383 index382 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number384 index383 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number385 index384 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e = e.next;</code></div><div class="line number386 index385 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number387 index386 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java plain">{</code></div><div class="line number388 index387 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(node != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number389 index388 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">node.setNext(first);</code></div><div class="line number390 index389 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number391 index390 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">node = </code><code class="java keyword">new</code> <code class="java plain">HashEntry&lt;K,V&gt;(hash, key, value, first);</code></div><div class="line number392 index391 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">c = count + </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number393 index392 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(c &gt; threshold &amp;&amp; first != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp;</code></div><div class="line number394 index393 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">tab.length &lt; MAXIMUM_CAPACITY)</code></div><div class="line number395 index394 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">rehash(node);</code></div><div class="line number396 index395 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number397 index396 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">setEntryAt(tab, index, node);</code></div><div class="line number398 index397 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++modCount;</code></div><div class="line number399 index398 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">count = c;</code></div><div class="line number400 index399 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">oldValue = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number401 index400 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number402 index401 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number403 index402 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number404 index403 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">finally</code> <code class="java plain">{</code></div><div class="line number405 index404 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">unlock();</code></div><div class="line number406 index405 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number407 index406 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">oldValue;</code></div><div class="line number408 index407 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number409 index408 alt2">&nbsp;</div><div class="line number410 index409 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number411 index410 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Doubles size of table and repacks entries, also adding the</code></div><div class="line number412 index411 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* given node to new table</code></div><div class="line number413 index412 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number414 index413 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@SuppressWarnings</code><code class="java plain">(</code><code class="java string">"unchecked"</code><code class="java plain">)</code></div><div class="line number415 index414 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">void</code> <code class="java plain">rehash(HashEntry&lt;K,V&gt; node) {</code></div><div class="line number416 index415 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/*</code></div><div class="line number417 index416 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* Reclassify nodes in each list to new table.&nbsp; Because we</code></div><div class="line number418 index417 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* are using power-of-two expansion, the elements from</code></div><div class="line number419 index418 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* each bin must either stay at same index, or move with a</code></div><div class="line number420 index419 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* power of two offset. We eliminate unnecessary node</code></div><div class="line number421 index420 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* creation by catching cases where old nodes can be</code></div><div class="line number422 index421 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* reused because their next fields won't change.</code></div><div class="line number423 index422 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* Statistically, at the default threshold, only about</code></div><div class="line number424 index423 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* one-sixth of them need cloning when a table</code></div><div class="line number425 index424 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* doubles. The nodes they replace will be garbage</code></div><div class="line number426 index425 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* collectable as soon as they are no longer referenced by</code></div><div class="line number427 index426 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* any reader thread that may be in the midst of</code></div><div class="line number428 index427 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* concurrently traversing table. Entry accesses use plain</code></div><div class="line number429 index428 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* array indexing because they are followed by volatile</code></div><div class="line number430 index429 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* table write.</code></div><div class="line number431 index430 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">*/</code></div><div class="line number432 index431 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] oldTable = table;</code></div><div class="line number433 index432 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">oldCapacity = oldTable.length;</code></div><div class="line number434 index433 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">newCapacity = oldCapacity &lt;&lt; </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number435 index434 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">threshold = (</code><code class="java keyword">int</code><code class="java plain">)(newCapacity * loadFactor);</code></div><div class="line number436 index435 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] newTable =</code></div><div class="line number437 index436 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(HashEntry&lt;K,V&gt;[]) </code><code class="java keyword">new</code> <code class="java plain">HashEntry[newCapacity];</code></div><div class="line number438 index437 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">sizeMask = newCapacity - </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number439 index438 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">i = </code><code class="java value">0</code><code class="java plain">; i &lt; oldCapacity ; i++) {</code></div><div class="line number440 index439 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e = oldTable[i];</code></div><div class="line number441 index440 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(e != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number442 index441 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; next = e.next;</code></div><div class="line number443 index442 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">idx = e.hash &amp; sizeMask;</code></div><div class="line number444 index443 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(next == </code><code class="java keyword">null</code><code class="java plain">)&nbsp;&nbsp; </code><code class="java comments">//&nbsp; Single node on list</code></div><div class="line number445 index444 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">newTable[idx] = e;</code></div><div class="line number446 index445 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java plain">{ </code><code class="java comments">// Reuse consecutive sequence at same slot</code></div><div class="line number447 index446 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; lastRun = e;</code></div><div class="line number448 index447 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">lastIdx = idx;</code></div><div class="line number449 index448 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(HashEntry&lt;K,V&gt; last = next;</code></div><div class="line number450 index449 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">last != </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number451 index450 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">last = last.next) {</code></div><div class="line number452 index451 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">k = last.hash &amp; sizeMask;</code></div><div class="line number453 index452 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(k != lastIdx) {</code></div><div class="line number454 index453 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lastIdx = k;</code></div><div class="line number455 index454 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lastRun = last;</code></div><div class="line number456 index455 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number457 index456 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number458 index457 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">newTable[lastIdx] = lastRun;</code></div><div class="line number459 index458 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Clone remaining nodes</code></div><div class="line number460 index459 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) {</code></div><div class="line number461 index460 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V v = p.value;</code></div><div class="line number462 index461 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">h = p.hash;</code></div><div class="line number463 index462 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">k = h &amp; sizeMask;</code></div><div class="line number464 index463 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; n = newTable[k];</code></div><div class="line number465 index464 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">newTable[k] = </code><code class="java keyword">new</code> <code class="java plain">HashEntry&lt;K,V&gt;(h, p.key, v, n);</code></div><div class="line number466 index465 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number467 index466 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number468 index467 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number469 index468 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number470 index469 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">nodeIndex = node.hash &amp; sizeMask; </code><code class="java comments">// add the new node</code></div><div class="line number471 index470 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">node.setNext(newTable[nodeIndex]);</code></div><div class="line number472 index471 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">newTable[nodeIndex] = node;</code></div><div class="line number473 index472 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">table = newTable;</code></div><div class="line number474 index473 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number475 index474 alt2">&nbsp;</div><div class="line number476 index475 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number477 index476 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Scans for a node containing given key while trying to</code></div><div class="line number478 index477 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* acquire lock, creating and returning one if not found. Upon</code></div><div class="line number479 index478 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* return, guarantees that lock is held. UNlike in most</code></div><div class="line number480 index479 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* methods, calls to method equals are not screened: Since</code></div><div class="line number481 index480 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* traversal speed doesn't matter, we might as well help warm</code></div><div class="line number482 index481 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* up the associated code and accesses as well.</code></div><div class="line number483 index482 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number484 index483 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return a new node if key not found, else null</code></div><div class="line number485 index484 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number486 index485 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">HashEntry&lt;K,V&gt; scanAndLockForPut(K key, </code><code class="java keyword">int</code> <code class="java plain">hash, V value) {</code></div><div class="line number487 index486 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; first = entryForHash(</code><code class="java keyword">this</code><code class="java plain">, hash);</code></div><div class="line number488 index487 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e = first;</code></div><div class="line number489 index488 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; node = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number490 index489 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">retries = -</code><code class="java value">1</code><code class="java plain">; </code><code class="java comments">// negative while locating node</code></div><div class="line number491 index490 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(!tryLock()) {</code></div><div class="line number492 index491 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; f; </code><code class="java comments">// to recheck first below</code></div><div class="line number493 index492 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(retries &lt; </code><code class="java value">0</code><code class="java plain">) {</code></div><div class="line number494 index493 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(e == </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number495 index494 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(node == </code><code class="java keyword">null</code><code class="java plain">) </code><code class="java comments">// speculatively create node</code></div><div class="line number496 index495 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">node = </code><code class="java keyword">new</code> <code class="java plain">HashEntry&lt;K,V&gt;(hash, key, value, </code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number497 index496 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">retries = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number498 index497 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number499 index498 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java keyword">if</code> <code class="java plain">(key.equals(e.key))</code></div><div class="line number500 index499 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">retries = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number501 index500 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number502 index501 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e = e.next;</code></div><div class="line number503 index502 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number504 index503 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java keyword">if</code> <code class="java plain">(++retries &gt; MAX_SCAN_RETRIES) {</code></div><div class="line number505 index504 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lock();</code></div><div class="line number506 index505 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number507 index506 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number508 index507 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java keyword">if</code> <code class="java plain">((retries &amp; </code><code class="java value">1</code><code class="java plain">) == </code><code class="java value">0</code> <code class="java plain">&amp;&amp;</code></div><div class="line number509 index508 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(f = entryForHash(</code><code class="java keyword">this</code><code class="java plain">, hash)) != first) {</code></div><div class="line number510 index509 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e = first = f; </code><code class="java comments">// re-traverse if entry changed</code></div><div class="line number511 index510 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">retries = -</code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number512 index511 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number513 index512 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number514 index513 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">node;</code></div><div class="line number515 index514 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number516 index515 alt1">&nbsp;</div><div class="line number517 index516 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number518 index517 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Scans for a node containing the given key while trying to</code></div><div class="line number519 index518 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* acquire lock for a remove or replace operation. Upon</code></div><div class="line number520 index519 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* return, guarantees that lock is held.&nbsp; Note that we must</code></div><div class="line number521 index520 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* lock even if the key is not found, to ensure sequential</code></div><div class="line number522 index521 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* consistency of updates.</code></div><div class="line number523 index522 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number524 index523 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">void</code> <code class="java plain">scanAndLock(Object key, </code><code class="java keyword">int</code> <code class="java plain">hash) {</code></div><div class="line number525 index524 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// similar to but simpler than scanAndLockForPut</code></div><div class="line number526 index525 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; first = entryForHash(</code><code class="java keyword">this</code><code class="java plain">, hash);</code></div><div class="line number527 index526 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e = first;</code></div><div class="line number528 index527 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">retries = -</code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number529 index528 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(!tryLock()) {</code></div><div class="line number530 index529 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; f;</code></div><div class="line number531 index530 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(retries &lt; </code><code class="java value">0</code><code class="java plain">) {</code></div><div class="line number532 index531 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(e == </code><code class="java keyword">null</code> <code class="java plain">|| key.equals(e.key))</code></div><div class="line number533 index532 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">retries = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number534 index533 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number535 index534 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e = e.next;</code></div><div class="line number536 index535 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number537 index536 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java keyword">if</code> <code class="java plain">(++retries &gt; MAX_SCAN_RETRIES) {</code></div><div class="line number538 index537 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lock();</code></div><div class="line number539 index538 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number540 index539 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number541 index540 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java keyword">if</code> <code class="java plain">((retries &amp; </code><code class="java value">1</code><code class="java plain">) == </code><code class="java value">0</code> <code class="java plain">&amp;&amp;</code></div><div class="line number542 index541 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(f = entryForHash(</code><code class="java keyword">this</code><code class="java plain">, hash)) != first) {</code></div><div class="line number543 index542 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e = first = f;</code></div><div class="line number544 index543 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">retries = -</code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number545 index544 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number546 index545 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number547 index546 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number548 index547 alt1">&nbsp;</div><div class="line number549 index548 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number550 index549 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Remove; match on key only if value null, else match both.</code></div><div class="line number551 index550 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number552 index551 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">V remove(Object key, </code><code class="java keyword">int</code> <code class="java plain">hash, Object value) {</code></div><div class="line number553 index552 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(!tryLock())</code></div><div class="line number554 index553 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">scanAndLock(key, hash);</code></div><div class="line number555 index554 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V oldValue = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number556 index555 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number557 index556 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] tab = table;</code></div><div class="line number558 index557 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">index = (tab.length - </code><code class="java value">1</code><code class="java plain">) &amp; hash;</code></div><div class="line number559 index558 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e = entryAt(tab, index);</code></div><div class="line number560 index559 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; pred = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number561 index560 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(e != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number562 index561 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">K k;</code></div><div class="line number563 index562 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; next = e.next;</code></div><div class="line number564 index563 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((k = e.key) == key ||</code></div><div class="line number565 index564 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(e.hash == hash &amp;&amp; key.equals(k))) {</code></div><div class="line number566 index565 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V v = e.value;</code></div><div class="line number567 index566 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(value == </code><code class="java keyword">null</code> <code class="java plain">|| value == v || value.equals(v)) {</code></div><div class="line number568 index567 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(pred == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number569 index568 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">setEntryAt(tab, index, next);</code></div><div class="line number570 index569 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number571 index570 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">pred.setNext(next);</code></div><div class="line number572 index571 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++modCount;</code></div><div class="line number573 index572 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">--count;</code></div><div class="line number574 index573 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">oldValue = v;</code></div><div class="line number575 index574 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number576 index575 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number577 index576 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number578 index577 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">pred = e;</code></div><div class="line number579 index578 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e = next;</code></div><div class="line number580 index579 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number581 index580 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">finally</code> <code class="java plain">{</code></div><div class="line number582 index581 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">unlock();</code></div><div class="line number583 index582 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number584 index583 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">oldValue;</code></div><div class="line number585 index584 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number586 index585 alt1">&nbsp;</div><div class="line number587 index586 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">boolean</code> <code class="java plain">replace(K key, </code><code class="java keyword">int</code> <code class="java plain">hash, V oldValue, V newValue) {</code></div><div class="line number588 index587 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(!tryLock())</code></div><div class="line number589 index588 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">scanAndLock(key, hash);</code></div><div class="line number590 index589 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">boolean</code> <code class="java plain">replaced = </code><code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number591 index590 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number592 index591 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e;</code></div><div class="line number593 index592 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(e = entryForHash(</code><code class="java keyword">this</code><code class="java plain">, hash); e != </code><code class="java keyword">null</code><code class="java plain">; e = e.next) {</code></div><div class="line number594 index593 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">K k;</code></div><div class="line number595 index594 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((k = e.key) == key ||</code></div><div class="line number596 index595 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(e.hash == hash &amp;&amp; key.equals(k))) {</code></div><div class="line number597 index596 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(oldValue.equals(e.value)) {</code></div><div class="line number598 index597 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e.value = newValue;</code></div><div class="line number599 index598 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++modCount;</code></div><div class="line number600 index599 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">replaced = </code><code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number601 index600 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number602 index601 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number603 index602 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number604 index603 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number605 index604 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">finally</code> <code class="java plain">{</code></div><div class="line number606 index605 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">unlock();</code></div><div class="line number607 index606 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number608 index607 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">replaced;</code></div><div class="line number609 index608 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number610 index609 alt1">&nbsp;</div><div class="line number611 index610 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">V replace(K key, </code><code class="java keyword">int</code> <code class="java plain">hash, V value) {</code></div><div class="line number612 index611 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(!tryLock())</code></div><div class="line number613 index612 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">scanAndLock(key, hash);</code></div><div class="line number614 index613 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V oldValue = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number615 index614 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number616 index615 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e;</code></div><div class="line number617 index616 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(e = entryForHash(</code><code class="java keyword">this</code><code class="java plain">, hash); e != </code><code class="java keyword">null</code><code class="java plain">; e = e.next) {</code></div><div class="line number618 index617 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">K k;</code></div><div class="line number619 index618 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((k = e.key) == key ||</code></div><div class="line number620 index619 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(e.hash == hash &amp;&amp; key.equals(k))) {</code></div><div class="line number621 index620 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">oldValue = e.value;</code></div><div class="line number622 index621 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e.value = value;</code></div><div class="line number623 index622 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++modCount;</code></div><div class="line number624 index623 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number625 index624 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number626 index625 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number627 index626 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">finally</code> <code class="java plain">{</code></div><div class="line number628 index627 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">unlock();</code></div><div class="line number629 index628 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number630 index629 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">oldValue;</code></div><div class="line number631 index630 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number632 index631 alt1">&nbsp;</div><div class="line number633 index632 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">void</code> <code class="java plain">clear() {</code></div><div class="line number634 index633 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lock();</code></div><div class="line number635 index634 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number636 index635 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] tab = table;</code></div><div class="line number637 index636 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">i = </code><code class="java value">0</code><code class="java plain">; i &lt; tab.length ; i++)</code></div><div class="line number638 index637 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">setEntryAt(tab, i, </code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number639 index638 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++modCount;</code></div><div class="line number640 index639 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">count = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number641 index640 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">finally</code> <code class="java plain">{</code></div><div class="line number642 index641 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">unlock();</code></div><div class="line number643 index642 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number644 index643 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number645 index644 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number646 index645 alt1">&nbsp;</div><div class="line number647 index646 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Accessing segments</code></div><div class="line number648 index647 alt1">&nbsp;</div><div class="line number649 index648 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number650 index649 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Gets the jth element of given segment array (if nonnull) with</code></div><div class="line number651 index650 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* volatile element access semantics via Unsafe.</code></div><div class="line number652 index651 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number653 index652 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@SuppressWarnings</code><code class="java plain">(</code><code class="java string">"unchecked"</code><code class="java plain">)</code></div><div class="line number654 index653 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java plain">&lt;K,V&gt; Segment&lt;K,V&gt; segmentAt(Segment&lt;K,V&gt;[] ss, </code><code class="java keyword">int</code> <code class="java plain">j) {</code></div><div class="line number655 index654 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">u = (j &lt;&lt; SSHIFT) + SBASE;</code></div><div class="line number656 index655 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ss == </code><code class="java keyword">null</code> <code class="java plain">? </code><code class="java keyword">null</code> <code class="java plain">:</code></div><div class="line number657 index656 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(Segment&lt;K,V&gt;) UNSAFE.getObjectVolatile(ss, u);</code></div><div class="line number658 index657 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number659 index658 alt2">&nbsp;</div><div class="line number660 index659 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number661 index660 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns the segment for the given index, creating it and</code></div><div class="line number662 index661 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* recording in segment table (via CAS) if not already present.</code></div><div class="line number663 index662 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number664 index663 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param k the index</code></div><div class="line number665 index664 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return the segment</code></div><div class="line number666 index665 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number667 index666 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@SuppressWarnings</code><code class="java plain">(</code><code class="java string">"unchecked"</code><code class="java plain">)</code></div><div class="line number668 index667 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">Segment&lt;K,V&gt; ensureSegment(</code><code class="java keyword">int</code> <code class="java plain">k) {</code></div><div class="line number669 index668 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] ss = </code><code class="java keyword">this</code><code class="java plain">.segments;</code></div><div class="line number670 index669 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">u = (k &lt;&lt; SSHIFT) + SBASE; </code><code class="java comments">// raw offset</code></div><div class="line number671 index670 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; seg;</code></div><div class="line number672 index671 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number673 index672 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; proto = ss[</code><code class="java value">0</code><code class="java plain">]; </code><code class="java comments">// use segment 0 as prototype</code></div><div class="line number674 index673 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">cap = proto.table.length;</code></div><div class="line number675 index674 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">float</code> <code class="java plain">lf = proto.loadFactor;</code></div><div class="line number676 index675 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">threshold = (</code><code class="java keyword">int</code><code class="java plain">)(cap * lf);</code></div><div class="line number677 index676 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] tab = (HashEntry&lt;K,V&gt;[])</code><code class="java keyword">new</code> <code class="java plain">HashEntry[cap];</code></div><div class="line number678 index677 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</code></div><div class="line number679 index678 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">== </code><code class="java keyword">null</code><code class="java plain">) { </code><code class="java comments">// recheck</code></div><div class="line number680 index679 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s = </code><code class="java keyword">new</code> <code class="java plain">Segment&lt;K,V&gt;(lf, threshold, tab);</code></div><div class="line number681 index680 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</code></div><div class="line number682 index681 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">== </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number683 index682 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(UNSAFE.compareAndSwapObject(ss, u, </code><code class="java keyword">null</code><code class="java plain">, seg = s))</code></div><div class="line number684 index683 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number685 index684 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number686 index685 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number687 index686 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number688 index687 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">seg;</code></div><div class="line number689 index688 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number690 index689 alt1">&nbsp;</div><div class="line number691 index690 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Hash-based segment and entry accesses</code></div><div class="line number692 index691 alt1">&nbsp;</div><div class="line number693 index692 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number694 index693 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Get the segment for the given hash</code></div><div class="line number695 index694 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number696 index695 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@SuppressWarnings</code><code class="java plain">(</code><code class="java string">"unchecked"</code><code class="java plain">)</code></div><div class="line number697 index696 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">Segment&lt;K,V&gt; segmentForHash(</code><code class="java keyword">int</code> <code class="java plain">h) {</code></div><div class="line number698 index697 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">u = (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;</code></div><div class="line number699 index698 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">(Segment&lt;K,V&gt;) UNSAFE.getObjectVolatile(segments, u);</code></div><div class="line number700 index699 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number701 index700 alt2">&nbsp;</div><div class="line number702 index701 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number703 index702 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Gets the table entry for the given segment and hash</code></div><div class="line number704 index703 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number705 index704 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@SuppressWarnings</code><code class="java plain">(</code><code class="java string">"unchecked"</code><code class="java plain">)</code></div><div class="line number706 index705 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java plain">&lt;K,V&gt; HashEntry&lt;K,V&gt; entryForHash(Segment&lt;K,V&gt; seg, </code><code class="java keyword">int</code> <code class="java plain">h) {</code></div><div class="line number707 index706 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] tab;</code></div><div class="line number708 index707 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">(seg == </code><code class="java keyword">null</code> <code class="java plain">|| (tab = seg.table) == </code><code class="java keyword">null</code><code class="java plain">) ? </code><code class="java keyword">null</code> <code class="java plain">:</code></div><div class="line number709 index708 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile</code></div><div class="line number710 index709 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(tab, ((</code><code class="java keyword">long</code><code class="java plain">)(((tab.length - </code><code class="java value">1</code><code class="java plain">) &amp; h)) &lt;&lt; TSHIFT) + TBASE);</code></div><div class="line number711 index710 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number712 index711 alt1">&nbsp;</div><div class="line number713 index712 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/* ---------------- Public operations -------------- */</code></div><div class="line number714 index713 alt1">&nbsp;</div><div class="line number715 index714 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number716 index715 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Creates a new, empty map with the specified initial</code></div><div class="line number717 index716 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* capacity, load factor and concurrency level.</code></div><div class="line number718 index717 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number719 index718 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param initialCapacity the initial capacity. The implementation</code></div><div class="line number720 index719 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* performs internal sizing to accommodate this many elements.</code></div><div class="line number721 index720 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param loadFactor&nbsp; the load factor threshold, used to control resizing.</code></div><div class="line number722 index721 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Resizing may be performed when the average number of elements per</code></div><div class="line number723 index722 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* bin exceeds this threshold.</code></div><div class="line number724 index723 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param concurrencyLevel the estimated number of concurrently</code></div><div class="line number725 index724 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* updating threads. The implementation performs internal sizing</code></div><div class="line number726 index725 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* to try to accommodate this many threads.</code></div><div class="line number727 index726 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws IllegalArgumentException if the initial capacity is</code></div><div class="line number728 index727 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* negative or the load factor or concurrencyLevel are</code></div><div class="line number729 index728 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* nonpositive.</code></div><div class="line number730 index729 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number731 index730 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@SuppressWarnings</code><code class="java plain">(</code><code class="java string">"unchecked"</code><code class="java plain">)</code></div><div class="line number732 index731 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">ConcurrentHashMap(</code><code class="java keyword">int</code> <code class="java plain">initialCapacity,</code></div><div class="line number733 index732 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">float</code> <code class="java plain">loadFactor, </code><code class="java keyword">int</code> <code class="java plain">concurrencyLevel) {</code></div><div class="line number734 index733 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(!(loadFactor &gt; </code><code class="java value">0</code><code class="java plain">) || initialCapacity &lt; </code><code class="java value">0</code> <code class="java plain">|| concurrencyLevel &lt;= </code><code class="java value">0</code><code class="java plain">)</code></div><div class="line number735 index734 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">IllegalArgumentException();</code></div><div class="line number736 index735 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(concurrencyLevel &gt; MAX_SEGMENTS)</code></div><div class="line number737 index736 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">concurrencyLevel = MAX_SEGMENTS;</code></div><div class="line number738 index737 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Find power-of-two sizes best matching arguments</code></div><div class="line number739 index738 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">sshift = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number740 index739 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">ssize = </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number741 index740 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(ssize &lt; concurrencyLevel) {</code></div><div class="line number742 index741 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++sshift;</code></div><div class="line number743 index742 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ssize &lt;&lt;= </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number744 index743 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number745 index744 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.segmentShift = </code><code class="java value">32</code> <code class="java plain">- sshift;</code></div><div class="line number746 index745 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.segmentMask = ssize - </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number747 index746 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(initialCapacity &gt; MAXIMUM_CAPACITY)</code></div><div class="line number748 index747 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">initialCapacity = MAXIMUM_CAPACITY;</code></div><div class="line number749 index748 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">c = initialCapacity / ssize;</code></div><div class="line number750 index749 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(c * ssize &lt; initialCapacity)</code></div><div class="line number751 index750 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++c;</code></div><div class="line number752 index751 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">cap = MIN_SEGMENT_TABLE_CAPACITY;</code></div><div class="line number753 index752 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(cap &lt; c)</code></div><div class="line number754 index753 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">cap &lt;&lt;= </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number755 index754 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// create segments and segments[0]</code></div><div class="line number756 index755 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s0 =</code></div><div class="line number757 index756 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">new</code> <code class="java plain">Segment&lt;K,V&gt;(loadFactor, (</code><code class="java keyword">int</code><code class="java plain">)(cap * loadFactor),</code></div><div class="line number758 index757 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(HashEntry&lt;K,V&gt;[])</code><code class="java keyword">new</code> <code class="java plain">HashEntry[cap]);</code></div><div class="line number759 index758 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])</code><code class="java keyword">new</code> <code class="java plain">Segment[ssize];</code></div><div class="line number760 index759 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">UNSAFE.putOrderedObject(ss, SBASE, s0); </code><code class="java comments">// ordered write of segments[0]</code></div><div class="line number761 index760 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">.segments = ss;</code></div><div class="line number762 index761 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number763 index762 alt2">&nbsp;</div><div class="line number764 index763 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number765 index764 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Creates a new, empty map with the specified initial capacity</code></div><div class="line number766 index765 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and load factor and with the default concurrencyLevel (16).</code></div><div class="line number767 index766 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number768 index767 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param initialCapacity The implementation performs internal</code></div><div class="line number769 index768 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* sizing to accommodate this many elements.</code></div><div class="line number770 index769 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param loadFactor&nbsp; the load factor threshold, used to control resizing.</code></div><div class="line number771 index770 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Resizing may be performed when the average number of elements per</code></div><div class="line number772 index771 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* bin exceeds this threshold.</code></div><div class="line number773 index772 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws IllegalArgumentException if the initial capacity of</code></div><div class="line number774 index773 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* elements is negative or the load factor is nonpositive</code></div><div class="line number775 index774 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number776 index775 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @since 1.6</code></div><div class="line number777 index776 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number778 index777 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">ConcurrentHashMap(</code><code class="java keyword">int</code> <code class="java plain">initialCapacity, </code><code class="java keyword">float</code> <code class="java plain">loadFactor) {</code></div><div class="line number779 index778 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">(initialCapacity, loadFactor, DEFAULT_CONCURRENCY_LEVEL);</code></div><div class="line number780 index779 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number781 index780 alt2">&nbsp;</div><div class="line number782 index781 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number783 index782 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Creates a new, empty map with the specified initial capacity,</code></div><div class="line number784 index783 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and with default load factor (0.75) and concurrencyLevel (16).</code></div><div class="line number785 index784 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number786 index785 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param initialCapacity the initial capacity. The implementation</code></div><div class="line number787 index786 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* performs internal sizing to accommodate this many elements.</code></div><div class="line number788 index787 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws IllegalArgumentException if the initial capacity of</code></div><div class="line number789 index788 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* elements is negative.</code></div><div class="line number790 index789 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number791 index790 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">ConcurrentHashMap(</code><code class="java keyword">int</code> <code class="java plain">initialCapacity) {</code></div><div class="line number792 index791 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">(initialCapacity, DEFAULT_LOAD_FACTOR, DEFAULT_CONCURRENCY_LEVEL);</code></div><div class="line number793 index792 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number794 index793 alt1">&nbsp;</div><div class="line number795 index794 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number796 index795 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Creates a new, empty map with a default initial capacity (16),</code></div><div class="line number797 index796 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* load factor (0.75) and concurrencyLevel (16).</code></div><div class="line number798 index797 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number799 index798 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">ConcurrentHashMap() {</code></div><div class="line number800 index799 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR, DEFAULT_CONCURRENCY_LEVEL);</code></div><div class="line number801 index800 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number802 index801 alt1">&nbsp;</div><div class="line number803 index802 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number804 index803 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Creates a new map with the same mappings as the given map.</code></div><div class="line number805 index804 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The map is created with a capacity of 1.5 times the number</code></div><div class="line number806 index805 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* of mappings in the given map or 16 (whichever is greater),</code></div><div class="line number807 index806 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and a default load factor (0.75) and concurrencyLevel (16).</code></div><div class="line number808 index807 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number809 index808 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param m the map</code></div><div class="line number810 index809 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number811 index810 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">ConcurrentHashMap(Map&lt;? </code><code class="java keyword">extends</code> <code class="java plain">K, ? </code><code class="java keyword">extends</code> <code class="java plain">V&gt; m) {</code></div><div class="line number812 index811 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">this</code><code class="java plain">(Math.max((</code><code class="java keyword">int</code><code class="java plain">) (m.size() / DEFAULT_LOAD_FACTOR) + </code><code class="java value">1</code><code class="java plain">,</code></div><div class="line number813 index812 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">DEFAULT_INITIAL_CAPACITY),</code></div><div class="line number814 index813 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">DEFAULT_LOAD_FACTOR, DEFAULT_CONCURRENCY_LEVEL);</code></div><div class="line number815 index814 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">putAll(m);</code></div><div class="line number816 index815 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number817 index816 alt2">&nbsp;</div><div class="line number818 index817 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number819 index818 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns &lt;tt&gt;true&lt;/tt&gt; if this map contains no key-value mappings.</code></div><div class="line number820 index819 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number821 index820 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; if this map contains no key-value mappings</code></div><div class="line number822 index821 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number823 index822 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">isEmpty() {</code></div><div class="line number824 index823 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/*</code></div><div class="line number825 index824 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* Sum per-segment modCounts to avoid mis-reporting when</code></div><div class="line number826 index825 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* elements are concurrently added and removed in one segment</code></div><div class="line number827 index826 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* while checking another, in which case the table was never</code></div><div class="line number828 index827 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* actually empty at any point. (The sum ensures accuracy up</code></div><div class="line number829 index828 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* through at least 1&lt;&lt;31 per-segment modifications before</code></div><div class="line number830 index829 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* recheck.)&nbsp; Methods size() and containsValue() use similar</code></div><div class="line number831 index830 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* constructions for stability checks.</code></div><div class="line number832 index831 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">*/</code></div><div class="line number833 index832 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">sum = 0L;</code></div><div class="line number834 index833 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] segments = </code><code class="java keyword">this</code><code class="java plain">.segments;</code></div><div class="line number835 index834 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j) {</code></div><div class="line number836 index835 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; seg = segmentAt(segments, j);</code></div><div class="line number837 index836 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(seg != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number838 index837 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(seg.count != </code><code class="java value">0</code><code class="java plain">)</code></div><div class="line number839 index838 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number840 index839 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sum += seg.modCount;</code></div><div class="line number841 index840 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number842 index841 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number843 index842 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(sum != 0L) { </code><code class="java comments">// recheck unless no modifications</code></div><div class="line number844 index843 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j) {</code></div><div class="line number845 index844 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; seg = segmentAt(segments, j);</code></div><div class="line number846 index845 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(seg != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number847 index846 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(seg.count != </code><code class="java value">0</code><code class="java plain">)</code></div><div class="line number848 index847 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number849 index848 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sum -= seg.modCount;</code></div><div class="line number850 index849 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number851 index850 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number852 index851 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(sum != 0L)</code></div><div class="line number853 index852 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number854 index853 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number855 index854 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number856 index855 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number857 index856 alt2">&nbsp;</div><div class="line number858 index857 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number859 index858 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns the number of key-value mappings in this map.&nbsp; If the</code></div><div class="line number860 index859 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* map contains more than &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt; elements, returns</code></div><div class="line number861 index860 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt;.</code></div><div class="line number862 index861 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number863 index862 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return the number of key-value mappings in this map</code></div><div class="line number864 index863 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number865 index864 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">int</code> <code class="java plain">size() {</code></div><div class="line number866 index865 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Try a few times to get accurate count. On failure due to</code></div><div class="line number867 index866 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// continuous async changes in table, resort to locking.</code></div><div class="line number868 index867 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] segments = </code><code class="java keyword">this</code><code class="java plain">.segments;</code></div><div class="line number869 index868 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">size;</code></div><div class="line number870 index869 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">boolean</code> <code class="java plain">overflow; </code><code class="java comments">// true if size overflows 32 bits</code></div><div class="line number871 index870 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="java comments">// sum of modCounts</code></div><div class="line number872 index871 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">last = 0L;&nbsp;&nbsp; </code><code class="java comments">// previous sum</code></div><div class="line number873 index872 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">retries = -</code><code class="java value">1</code><code class="java plain">; </code><code class="java comments">// first iteration isn't retry</code></div><div class="line number874 index873 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number875 index874 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number876 index875 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(retries++ == RETRIES_BEFORE_LOCK) {</code></div><div class="line number877 index876 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j)</code></div><div class="line number878 index877 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ensureSegment(j).lock(); </code><code class="java comments">// force creation</code></div><div class="line number879 index878 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number880 index879 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sum = 0L;</code></div><div class="line number881 index880 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">size = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number882 index881 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">overflow = </code><code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number883 index882 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j) {</code></div><div class="line number884 index883 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; seg = segmentAt(segments, j);</code></div><div class="line number885 index884 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(seg != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number886 index885 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sum += seg.modCount;</code></div><div class="line number887 index886 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">c = seg.count;</code></div><div class="line number888 index887 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(c &lt; </code><code class="java value">0</code> <code class="java plain">|| (size += c) &lt; </code><code class="java value">0</code><code class="java plain">)</code></div><div class="line number889 index888 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">overflow = </code><code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number890 index889 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number891 index890 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number892 index891 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(sum == last)</code></div><div class="line number893 index892 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number894 index893 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">last = sum;</code></div><div class="line number895 index894 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number896 index895 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">finally</code> <code class="java plain">{</code></div><div class="line number897 index896 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(retries &gt; RETRIES_BEFORE_LOCK) {</code></div><div class="line number898 index897 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j)</code></div><div class="line number899 index898 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">segmentAt(segments, j).unlock();</code></div><div class="line number900 index899 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number901 index900 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number902 index901 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">overflow ? Integer.MAX_VALUE : size;</code></div><div class="line number903 index902 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number904 index903 alt1">&nbsp;</div><div class="line number905 index904 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number906 index905 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns the value to which the specified key is mapped,</code></div><div class="line number907 index906 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* or {@code null} if this map contains no mapping for the key.</code></div><div class="line number908 index907 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number909 index908 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;More formally, if this map contains a mapping from a key</code></div><div class="line number910 index909 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* {@code k} to a value {@code v} such that {@code key.equals(k)},</code></div><div class="line number911 index910 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* then this method returns {@code v}; otherwise it returns</code></div><div class="line number912 index911 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* {@code null}.&nbsp; (There can be at most one such mapping.)</code></div><div class="line number913 index912 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number914 index913 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified key is null</code></div><div class="line number915 index914 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number916 index915 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">V get(Object key) {</code></div><div class="line number917 index916 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">hash = hash(key.hashCode());</code></div><div class="line number918 index917 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(HashEntry&lt;K,V&gt; e = entryForHash(segmentForHash(hash), hash);</code></div><div class="line number919 index918 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e != </code><code class="java keyword">null</code><code class="java plain">; e = e.next) {</code></div><div class="line number920 index919 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">K k;</code></div><div class="line number921 index920 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((k = e.key) == key || (e.hash == hash &amp;&amp; key.equals(k)))</code></div><div class="line number922 index921 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">e.value;</code></div><div class="line number923 index922 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number924 index923 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number925 index924 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number926 index925 alt1">&nbsp;</div><div class="line number927 index926 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number928 index927 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Tests if the specified object is a key in this table.</code></div><div class="line number929 index928 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number930 index929 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param&nbsp; key&nbsp;&nbsp; possible key</code></div><div class="line number931 index930 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; if and only if the specified object</code></div><div class="line number932 index931 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is a key in this table, as determined by the</code></div><div class="line number933 index932 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tt&gt;equals&lt;/tt&gt; method; &lt;tt&gt;false&lt;/tt&gt; otherwise.</code></div><div class="line number934 index933 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified key is null</code></div><div class="line number935 index934 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number936 index935 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">containsKey(Object key) {</code></div><div class="line number937 index936 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">hash = hash(key.hashCode());</code></div><div class="line number938 index937 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(HashEntry&lt;K,V&gt; e = entryForHash(segmentForHash(hash), hash);</code></div><div class="line number939 index938 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e != </code><code class="java keyword">null</code><code class="java plain">; e = e.next) {</code></div><div class="line number940 index939 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">K k;</code></div><div class="line number941 index940 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((k = e.key) == key || (e.hash == hash &amp;&amp; key.equals(k)))</code></div><div class="line number942 index941 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number943 index942 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number944 index943 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number945 index944 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number946 index945 alt1">&nbsp;</div><div class="line number947 index946 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number948 index947 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns &lt;tt&gt;true&lt;/tt&gt; if this map maps one or more keys to the</code></div><div class="line number949 index948 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* specified value. Note: This method requires a full internal</code></div><div class="line number950 index949 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* traversal of the hash table, and so is much slower than</code></div><div class="line number951 index950 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* method &lt;tt&gt;containsKey&lt;/tt&gt;.</code></div><div class="line number952 index951 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number953 index952 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param value value whose presence in this map is to be tested</code></div><div class="line number954 index953 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; if this map maps one or more keys to the</code></div><div class="line number955 index954 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; specified value</code></div><div class="line number956 index955 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified value is null</code></div><div class="line number957 index956 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number958 index957 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">containsValue(Object value) {</code></div><div class="line number959 index958 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Same idea as size()</code></div><div class="line number960 index959 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(value == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number961 index960 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NullPointerException();</code></div><div class="line number962 index961 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] segments = </code><code class="java keyword">this</code><code class="java plain">.segments;</code></div><div class="line number963 index962 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">boolean</code> <code class="java plain">found = </code><code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number964 index963 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">last = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number965 index964 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">retries = -</code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number966 index965 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number967 index966 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">outer: </code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number968 index967 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(retries++ == RETRIES_BEFORE_LOCK) {</code></div><div class="line number969 index968 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j)</code></div><div class="line number970 index969 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ensureSegment(j).lock(); </code><code class="java comments">// force creation</code></div><div class="line number971 index970 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number972 index971 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">hashSum = 0L;</code></div><div class="line number973 index972 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">sum = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number974 index973 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j) {</code></div><div class="line number975 index974 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] tab;</code></div><div class="line number976 index975 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; seg = segmentAt(segments, j);</code></div><div class="line number977 index976 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(seg != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp; (tab = seg.table) != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number978 index977 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">i = </code><code class="java value">0</code> <code class="java plain">; i &lt; tab.length; i++) {</code></div><div class="line number979 index978 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e;</code></div><div class="line number980 index979 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(e = entryAt(tab, i); e != </code><code class="java keyword">null</code><code class="java plain">; e = e.next) {</code></div><div class="line number981 index980 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V v = e.value;</code></div><div class="line number982 index981 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(v != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp; value.equals(v)) {</code></div><div class="line number983 index982 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">found = </code><code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number984 index983 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code> <code class="java plain">outer;</code></div><div class="line number985 index984 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number986 index985 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number987 index986 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number988 index987 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sum += seg.modCount;</code></div><div class="line number989 index988 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number990 index989 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number991 index990 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(retries &gt; </code><code class="java value">0</code> <code class="java plain">&amp;&amp; sum == last)</code></div><div class="line number992 index991 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number993 index992 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">last = sum;</code></div><div class="line number994 index993 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number995 index994 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">finally</code> <code class="java plain">{</code></div><div class="line number996 index995 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(retries &gt; RETRIES_BEFORE_LOCK) {</code></div><div class="line number997 index996 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j)</code></div><div class="line number998 index997 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">segmentAt(segments, j).unlock();</code></div><div class="line number999 index998 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1000 index999 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1001 index1000 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">found;</code></div><div class="line number1002 index1001 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1003 index1002 alt2">&nbsp;</div><div class="line number1004 index1003 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1005 index1004 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Legacy method testing if some key maps into the specified value</code></div><div class="line number1006 index1005 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* in this table.&nbsp; This method is identical in functionality to</code></div><div class="line number1007 index1006 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* {@link #containsValue}, and exists solely to ensure</code></div><div class="line number1008 index1007 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* full compatibility with class {@link java.util.Hashtable},</code></div><div class="line number1009 index1008 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* which supported this method prior to introduction of the</code></div><div class="line number1010 index1009 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Java Collections framework.</code></div><div class="line number1011 index1010 alt2">&nbsp;</div><div class="line number1012 index1011 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param&nbsp; value a value to search for</code></div><div class="line number1013 index1012 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; if and only if some key maps to the</code></div><div class="line number1014 index1013 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tt&gt;value&lt;/tt&gt; argument in this table as</code></div><div class="line number1015 index1014 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; determined by the &lt;tt&gt;equals&lt;/tt&gt; method;</code></div><div class="line number1016 index1015 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tt&gt;false&lt;/tt&gt; otherwise</code></div><div class="line number1017 index1016 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified value is null</code></div><div class="line number1018 index1017 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1019 index1018 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">contains(Object value) {</code></div><div class="line number1020 index1019 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">containsValue(value);</code></div><div class="line number1021 index1020 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1022 index1021 alt1">&nbsp;</div><div class="line number1023 index1022 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1024 index1023 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Maps the specified key to the specified value in this table.</code></div><div class="line number1025 index1024 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Neither the key nor the value can be null.</code></div><div class="line number1026 index1025 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1027 index1026 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt; The value can be retrieved by calling the &lt;tt&gt;get&lt;/tt&gt; method</code></div><div class="line number1028 index1027 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* with a key that is equal to the original key.</code></div><div class="line number1029 index1028 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1030 index1029 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param key key with which the specified value is to be associated</code></div><div class="line number1031 index1030 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param value value to be associated with the specified key</code></div><div class="line number1032 index1031 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</code></div><div class="line number1033 index1032 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;</code></div><div class="line number1034 index1033 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified key or value is null</code></div><div class="line number1035 index1034 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1036 index1035 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">V put(K key, V value) {</code></div><div class="line number1037 index1036 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(value == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1038 index1037 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NullPointerException();</code></div><div class="line number1039 index1038 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">hash = hash(key.hashCode());</code></div><div class="line number1040 index1039 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</code></div><div class="line number1041 index1040 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s = segmentAt(segments, j);</code></div><div class="line number1042 index1041 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(s == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1043 index1042 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s = ensureSegment(j);</code></div><div class="line number1044 index1043 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">s.put(key, hash, value, </code><code class="java keyword">false</code><code class="java plain">);</code></div><div class="line number1045 index1044 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1046 index1045 alt1">&nbsp;</div><div class="line number1047 index1046 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1048 index1047 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* {@inheritDoc}</code></div><div class="line number1049 index1048 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1050 index1049 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return the previous value associated with the specified key,</code></div><div class="line number1051 index1050 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; or &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for the key</code></div><div class="line number1052 index1051 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified key or value is null</code></div><div class="line number1053 index1052 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1054 index1053 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">V putIfAbsent(K key, V value) {</code></div><div class="line number1055 index1054 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(value == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1056 index1055 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NullPointerException();</code></div><div class="line number1057 index1056 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">hash = hash(key.hashCode());</code></div><div class="line number1058 index1057 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</code></div><div class="line number1059 index1058 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s = segmentAt(segments, j);</code></div><div class="line number1060 index1059 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(s == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1061 index1060 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s = ensureSegment(j);</code></div><div class="line number1062 index1061 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">s.put(key, hash, value, </code><code class="java keyword">true</code><code class="java plain">);</code></div><div class="line number1063 index1062 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1064 index1063 alt1">&nbsp;</div><div class="line number1065 index1064 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1066 index1065 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Copies all of the mappings from the specified map to this one.</code></div><div class="line number1067 index1066 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* These mappings replace any mappings that this map had for any of the</code></div><div class="line number1068 index1067 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* keys currently in the specified map.</code></div><div class="line number1069 index1068 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1070 index1069 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param m mappings to be stored in this map</code></div><div class="line number1071 index1070 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1072 index1071 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">putAll(Map&lt;? </code><code class="java keyword">extends</code> <code class="java plain">K, ? </code><code class="java keyword">extends</code> <code class="java plain">V&gt; m) {</code></div><div class="line number1073 index1072 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(Map.Entry&lt;? </code><code class="java keyword">extends</code> <code class="java plain">K, ? </code><code class="java keyword">extends</code> <code class="java plain">V&gt; e : m.entrySet())</code></div><div class="line number1074 index1073 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">put(e.getKey(), e.getValue());</code></div><div class="line number1075 index1074 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1076 index1075 alt1">&nbsp;</div><div class="line number1077 index1076 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1078 index1077 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Removes the key (and its corresponding value) from this map.</code></div><div class="line number1079 index1078 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* This method does nothing if the key is not in the map.</code></div><div class="line number1080 index1079 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1081 index1080 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param&nbsp; key the key that needs to be removed</code></div><div class="line number1082 index1081 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</code></div><div class="line number1083 index1082 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;</code></div><div class="line number1084 index1083 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified key is null</code></div><div class="line number1085 index1084 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1086 index1085 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">V remove(Object key) {</code></div><div class="line number1087 index1086 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">hash = hash(key.hashCode());</code></div><div class="line number1088 index1087 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s = segmentForHash(hash);</code></div><div class="line number1089 index1088 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">s == </code><code class="java keyword">null</code> <code class="java plain">? </code><code class="java keyword">null</code> <code class="java plain">: s.remove(key, hash, </code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number1090 index1089 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1091 index1090 alt2">&nbsp;</div><div class="line number1092 index1091 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1093 index1092 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* {@inheritDoc}</code></div><div class="line number1094 index1093 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1095 index1094 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified key is null</code></div><div class="line number1096 index1095 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1097 index1096 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">remove(Object key, Object value) {</code></div><div class="line number1098 index1097 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">hash = hash(key.hashCode());</code></div><div class="line number1099 index1098 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s;</code></div><div class="line number1100 index1099 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">value != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp; (s = segmentForHash(hash)) != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp;</code></div><div class="line number1101 index1100 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.remove(key, hash, value) != </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number1102 index1101 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1103 index1102 alt2">&nbsp;</div><div class="line number1104 index1103 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1105 index1104 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* {@inheritDoc}</code></div><div class="line number1106 index1105 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1107 index1106 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if any of the arguments are null</code></div><div class="line number1108 index1107 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1109 index1108 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">replace(K key, V oldValue, V newValue) {</code></div><div class="line number1110 index1109 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">hash = hash(key.hashCode());</code></div><div class="line number1111 index1110 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(oldValue == </code><code class="java keyword">null</code> <code class="java plain">|| newValue == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1112 index1111 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NullPointerException();</code></div><div class="line number1113 index1112 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s = segmentForHash(hash);</code></div><div class="line number1114 index1113 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">s != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp; s.replace(key, hash, oldValue, newValue);</code></div><div class="line number1115 index1114 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1116 index1115 alt1">&nbsp;</div><div class="line number1117 index1116 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1118 index1117 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* {@inheritDoc}</code></div><div class="line number1119 index1118 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1120 index1119 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return the previous value associated with the specified key,</code></div><div class="line number1121 index1120 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; or &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for the key</code></div><div class="line number1122 index1121 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified key or value is null</code></div><div class="line number1123 index1122 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1124 index1123 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">V replace(K key, V value) {</code></div><div class="line number1125 index1124 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">hash = hash(key.hashCode());</code></div><div class="line number1126 index1125 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(value == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1127 index1126 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NullPointerException();</code></div><div class="line number1128 index1127 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s = segmentForHash(hash);</code></div><div class="line number1129 index1128 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">s == </code><code class="java keyword">null</code> <code class="java plain">? </code><code class="java keyword">null</code> <code class="java plain">: s.replace(key, hash, value);</code></div><div class="line number1130 index1129 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1131 index1130 alt2">&nbsp;</div><div class="line number1132 index1131 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1133 index1132 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Removes all of the mappings from this map.</code></div><div class="line number1134 index1133 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1135 index1134 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">clear() {</code></div><div class="line number1136 index1135 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] segments = </code><code class="java keyword">this</code><code class="java plain">.segments;</code></div><div class="line number1137 index1136 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">j = </code><code class="java value">0</code><code class="java plain">; j &lt; segments.length; ++j) {</code></div><div class="line number1138 index1137 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; s = segmentAt(segments, j);</code></div><div class="line number1139 index1138 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(s != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1140 index1139 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.clear();</code></div><div class="line number1141 index1140 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1142 index1141 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1143 index1142 alt2">&nbsp;</div><div class="line number1144 index1143 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1145 index1144 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns a {@link Set} view of the keys contained in this map.</code></div><div class="line number1146 index1145 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The set is backed by the map, so changes to the map are</code></div><div class="line number1147 index1146 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* reflected in the set, and vice-versa.&nbsp; The set supports element</code></div><div class="line number1148 index1147 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* removal, which removes the corresponding mapping from this map,</code></div><div class="line number1149 index1148 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* via the &lt;tt&gt;Iterator.remove&lt;/tt&gt;, &lt;tt&gt;Set.remove&lt;/tt&gt;,</code></div><div class="line number1150 index1149 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;removeAll&lt;/tt&gt;, &lt;tt&gt;retainAll&lt;/tt&gt;, and &lt;tt&gt;clear&lt;/tt&gt;</code></div><div class="line number1151 index1150 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* operations.&nbsp; It does not support the &lt;tt&gt;add&lt;/tt&gt; or</code></div><div class="line number1152 index1151 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;addAll&lt;/tt&gt; operations.</code></div><div class="line number1153 index1152 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1154 index1153 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;The view's &lt;tt&gt;iterator&lt;/tt&gt; is a "weakly consistent" iterator</code></div><div class="line number1155 index1154 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* that will never throw {@link ConcurrentModificationException},</code></div><div class="line number1156 index1155 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and guarantees to traverse elements as they existed upon</code></div><div class="line number1157 index1156 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* construction of the iterator, and may (but is not guaranteed to)</code></div><div class="line number1158 index1157 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* reflect any modifications subsequent to construction.</code></div><div class="line number1159 index1158 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1160 index1159 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Set&lt;K&gt; keySet() {</code></div><div class="line number1161 index1160 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Set&lt;K&gt; ks = keySet;</code></div><div class="line number1162 index1161 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">(ks != </code><code class="java keyword">null</code><code class="java plain">) ? ks : (keySet = </code><code class="java keyword">new</code> <code class="java plain">KeySet());</code></div><div class="line number1163 index1162 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1164 index1163 alt1">&nbsp;</div><div class="line number1165 index1164 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1166 index1165 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns a {@link Collection} view of the values contained in this map.</code></div><div class="line number1167 index1166 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The collection is backed by the map, so changes to the map are</code></div><div class="line number1168 index1167 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* reflected in the collection, and vice-versa.&nbsp; The collection</code></div><div class="line number1169 index1168 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* supports element removal, which removes the corresponding</code></div><div class="line number1170 index1169 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* mapping from this map, via the &lt;tt&gt;Iterator.remove&lt;/tt&gt;,</code></div><div class="line number1171 index1170 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;Collection.remove&lt;/tt&gt;, &lt;tt&gt;removeAll&lt;/tt&gt;,</code></div><div class="line number1172 index1171 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;retainAll&lt;/tt&gt;, and &lt;tt&gt;clear&lt;/tt&gt; operations.&nbsp; It does not</code></div><div class="line number1173 index1172 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* support the &lt;tt&gt;add&lt;/tt&gt; or &lt;tt&gt;addAll&lt;/tt&gt; operations.</code></div><div class="line number1174 index1173 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1175 index1174 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;The view's &lt;tt&gt;iterator&lt;/tt&gt; is a "weakly consistent" iterator</code></div><div class="line number1176 index1175 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* that will never throw {@link ConcurrentModificationException},</code></div><div class="line number1177 index1176 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and guarantees to traverse elements as they existed upon</code></div><div class="line number1178 index1177 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* construction of the iterator, and may (but is not guaranteed to)</code></div><div class="line number1179 index1178 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* reflect any modifications subsequent to construction.</code></div><div class="line number1180 index1179 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1181 index1180 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Collection&lt;V&gt; values() {</code></div><div class="line number1182 index1181 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Collection&lt;V&gt; vs = values;</code></div><div class="line number1183 index1182 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">(vs != </code><code class="java keyword">null</code><code class="java plain">) ? vs : (values = </code><code class="java keyword">new</code> <code class="java plain">Values());</code></div><div class="line number1184 index1183 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1185 index1184 alt2">&nbsp;</div><div class="line number1186 index1185 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1187 index1186 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns a {@link Set} view of the mappings contained in this map.</code></div><div class="line number1188 index1187 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The set is backed by the map, so changes to the map are</code></div><div class="line number1189 index1188 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* reflected in the set, and vice-versa.&nbsp; The set supports element</code></div><div class="line number1190 index1189 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* removal, which removes the corresponding mapping from the map,</code></div><div class="line number1191 index1190 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* via the &lt;tt&gt;Iterator.remove&lt;/tt&gt;, &lt;tt&gt;Set.remove&lt;/tt&gt;,</code></div><div class="line number1192 index1191 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;removeAll&lt;/tt&gt;, &lt;tt&gt;retainAll&lt;/tt&gt;, and &lt;tt&gt;clear&lt;/tt&gt;</code></div><div class="line number1193 index1192 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* operations.&nbsp; It does not support the &lt;tt&gt;add&lt;/tt&gt; or</code></div><div class="line number1194 index1193 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;addAll&lt;/tt&gt; operations.</code></div><div class="line number1195 index1194 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1196 index1195 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;The view's &lt;tt&gt;iterator&lt;/tt&gt; is a "weakly consistent" iterator</code></div><div class="line number1197 index1196 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* that will never throw {@link ConcurrentModificationException},</code></div><div class="line number1198 index1197 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and guarantees to traverse elements as they existed upon</code></div><div class="line number1199 index1198 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* construction of the iterator, and may (but is not guaranteed to)</code></div><div class="line number1200 index1199 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* reflect any modifications subsequent to construction.</code></div><div class="line number1201 index1200 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1202 index1201 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() {</code></div><div class="line number1203 index1202 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Set&lt;Map.Entry&lt;K,V&gt;&gt; es = entrySet;</code></div><div class="line number1204 index1203 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">(es != </code><code class="java keyword">null</code><code class="java plain">) ? es : (entrySet = </code><code class="java keyword">new</code> <code class="java plain">EntrySet());</code></div><div class="line number1205 index1204 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1206 index1205 alt1">&nbsp;</div><div class="line number1207 index1206 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1208 index1207 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns an enumeration of the keys in this table.</code></div><div class="line number1209 index1208 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1210 index1209 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return an enumeration of the keys in this table</code></div><div class="line number1211 index1210 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @see #keySet()</code></div><div class="line number1212 index1211 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1213 index1212 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Enumeration&lt;K&gt; keys() {</code></div><div class="line number1214 index1213 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">new</code> <code class="java plain">KeyIterator();</code></div><div class="line number1215 index1214 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1216 index1215 alt1">&nbsp;</div><div class="line number1217 index1216 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1218 index1217 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns an enumeration of the values in this table.</code></div><div class="line number1219 index1218 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number1220 index1219 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return an enumeration of the values in this table</code></div><div class="line number1221 index1220 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @see #values()</code></div><div class="line number1222 index1221 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1223 index1222 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Enumeration&lt;V&gt; elements() {</code></div><div class="line number1224 index1223 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">new</code> <code class="java plain">ValueIterator();</code></div><div class="line number1225 index1224 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1226 index1225 alt1">&nbsp;</div><div class="line number1227 index1226 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/* ---------------- Iterator Support -------------- */</code></div><div class="line number1228 index1227 alt1">&nbsp;</div><div class="line number1229 index1228 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">abstract</code> <code class="java keyword">class</code> <code class="java plain">HashIterator {</code></div><div class="line number1230 index1229 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">nextSegmentIndex;</code></div><div class="line number1231 index1230 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">nextTableIndex;</code></div><div class="line number1232 index1231 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] currentTable;</code></div><div class="line number1233 index1232 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K, V&gt; nextEntry;</code></div><div class="line number1234 index1233 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K, V&gt; lastReturned;</code></div><div class="line number1235 index1234 alt2">&nbsp;</div><div class="line number1236 index1235 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashIterator() {</code></div><div class="line number1237 index1236 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextSegmentIndex = segments.length - </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number1238 index1237 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextTableIndex = -</code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number1239 index1238 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">advance();</code></div><div class="line number1240 index1239 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1241 index1240 alt2">&nbsp;</div><div class="line number1242 index1241 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1243 index1242 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Set nextEntry to first node of next non-empty table</code></div><div class="line number1244 index1243 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* (in backwards order, to simplify checks).</code></div><div class="line number1245 index1244 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1246 index1245 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">void</code> <code class="java plain">advance() {</code></div><div class="line number1247 index1246 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number1248 index1247 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(nextTableIndex &gt;= </code><code class="java value">0</code><code class="java plain">) {</code></div><div class="line number1249 index1248 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((nextEntry = entryAt(currentTable,</code></div><div class="line number1250 index1249 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextTableIndex--)) != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1251 index1250 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number1252 index1251 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1253 index1252 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java keyword">if</code> <code class="java plain">(nextSegmentIndex &gt;= </code><code class="java value">0</code><code class="java plain">) {</code></div><div class="line number1254 index1253 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; seg = segmentAt(segments, nextSegmentIndex--);</code></div><div class="line number1255 index1254 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(seg != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp; (currentTable = seg.table) != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1256 index1255 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextTableIndex = currentTable.length - </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number1257 index1256 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1258 index1257 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number1259 index1258 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number1260 index1259 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1261 index1260 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1262 index1261 alt1">&nbsp;</div><div class="line number1263 index1262 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">HashEntry&lt;K,V&gt; nextEntry() {</code></div><div class="line number1264 index1263 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e = nextEntry;</code></div><div class="line number1265 index1264 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(e == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1266 index1265 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NoSuchElementException();</code></div><div class="line number1267 index1266 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lastReturned = e; </code><code class="java comments">// cannot assign until after null check</code></div><div class="line number1268 index1267 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((nextEntry = e.next) == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1269 index1268 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">advance();</code></div><div class="line number1270 index1269 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">e;</code></div><div class="line number1271 index1270 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1272 index1271 alt1">&nbsp;</div><div class="line number1273 index1272 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">boolean</code> <code class="java plain">hasNext() { </code><code class="java keyword">return</code> <code class="java plain">nextEntry != </code><code class="java keyword">null</code><code class="java plain">; }</code></div><div class="line number1274 index1273 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">boolean</code> <code class="java plain">hasMoreElements() { </code><code class="java keyword">return</code> <code class="java plain">nextEntry != </code><code class="java keyword">null</code><code class="java plain">; }</code></div><div class="line number1275 index1274 alt2">&nbsp;</div><div class="line number1276 index1275 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java keyword">void</code> <code class="java plain">remove() {</code></div><div class="line number1277 index1276 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(lastReturned == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1278 index1277 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">IllegalStateException();</code></div><div class="line number1279 index1278 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.remove(lastReturned.key);</code></div><div class="line number1280 index1279 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lastReturned = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number1281 index1280 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1282 index1281 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1283 index1282 alt2">&nbsp;</div><div class="line number1284 index1283 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">KeyIterator</code></div><div class="line number1285 index1284 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">extends</code> <code class="java plain">HashIterator</code></div><div class="line number1286 index1285 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">implements</code> <code class="java plain">Iterator&lt;K&gt;, Enumeration&lt;K&gt;</code></div><div class="line number1287 index1286 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number1288 index1287 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java plain">K next()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { </code><code class="java keyword">return</code> <code class="java keyword">super</code><code class="java plain">.nextEntry().key; }</code></div><div class="line number1289 index1288 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java plain">K nextElement() { </code><code class="java keyword">return</code> <code class="java keyword">super</code><code class="java plain">.nextEntry().key; }</code></div><div class="line number1290 index1289 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1291 index1290 alt2">&nbsp;</div><div class="line number1292 index1291 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">ValueIterator</code></div><div class="line number1293 index1292 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">extends</code> <code class="java plain">HashIterator</code></div><div class="line number1294 index1293 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">implements</code> <code class="java plain">Iterator&lt;V&gt;, Enumeration&lt;V&gt;</code></div><div class="line number1295 index1294 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number1296 index1295 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java plain">V next()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { </code><code class="java keyword">return</code> <code class="java keyword">super</code><code class="java plain">.nextEntry().value; }</code></div><div class="line number1297 index1296 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">final</code> <code class="java plain">V nextElement() { </code><code class="java keyword">return</code> <code class="java keyword">super</code><code class="java plain">.nextEntry().value; }</code></div><div class="line number1298 index1297 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1299 index1298 alt2">&nbsp;</div><div class="line number1300 index1299 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1301 index1300 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Custom Entry class used by EntryIterator.next(), that relays</code></div><div class="line number1302 index1301 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* setValue changes to the underlying map.</code></div><div class="line number1303 index1302 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1304 index1303 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">WriteThroughEntry</code></div><div class="line number1305 index1304 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">extends</code> <code class="java plain">AbstractMap.SimpleEntry&lt;K,V&gt;</code></div><div class="line number1306 index1305 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number1307 index1306 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">WriteThroughEntry(K k, V v) {</code></div><div class="line number1308 index1307 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">super</code><code class="java plain">(k,v);</code></div><div class="line number1309 index1308 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1310 index1309 alt1">&nbsp;</div><div class="line number1311 index1310 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1312 index1311 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Set our entry's value and write through to the map. The</code></div><div class="line number1313 index1312 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* value to return is somewhat arbitrary here. Since a</code></div><div class="line number1314 index1313 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* WriteThroughEntry does not necessarily track asynchronous</code></div><div class="line number1315 index1314 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* changes, the most recent "previous" value could be</code></div><div class="line number1316 index1315 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* different from what we return (or could even have been</code></div><div class="line number1317 index1316 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* removed in which case the put will re-establish). We do not</code></div><div class="line number1318 index1317 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and cannot guarantee more.</code></div><div class="line number1319 index1318 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1320 index1319 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">V setValue(V value) {</code></div><div class="line number1321 index1320 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(value == </code><code class="java keyword">null</code><code class="java plain">) </code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NullPointerException();</code></div><div class="line number1322 index1321 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V v = </code><code class="java keyword">super</code><code class="java plain">.setValue(value);</code></div><div class="line number1323 index1322 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.put(getKey(), value);</code></div><div class="line number1324 index1323 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">v;</code></div><div class="line number1325 index1324 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1326 index1325 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1327 index1326 alt2">&nbsp;</div><div class="line number1328 index1327 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">EntryIterator</code></div><div class="line number1329 index1328 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">extends</code> <code class="java plain">HashIterator</code></div><div class="line number1330 index1329 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">implements</code> <code class="java plain">Iterator&lt;Entry&lt;K,V&gt;&gt;</code></div><div class="line number1331 index1330 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number1332 index1331 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Map.Entry&lt;K,V&gt; next() {</code></div><div class="line number1333 index1332 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e = </code><code class="java keyword">super</code><code class="java plain">.nextEntry();</code></div><div class="line number1334 index1333 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">new</code> <code class="java plain">WriteThroughEntry(e.key, e.value);</code></div><div class="line number1335 index1334 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1336 index1335 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1337 index1336 alt2">&nbsp;</div><div class="line number1338 index1337 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">KeySet </code><code class="java keyword">extends</code> <code class="java plain">AbstractSet&lt;K&gt; {</code></div><div class="line number1339 index1338 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Iterator&lt;K&gt; iterator() {</code></div><div class="line number1340 index1339 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">new</code> <code class="java plain">KeyIterator();</code></div><div class="line number1341 index1340 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1342 index1341 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">int</code> <code class="java plain">size() {</code></div><div class="line number1343 index1342 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.size();</code></div><div class="line number1344 index1343 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1345 index1344 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">isEmpty() {</code></div><div class="line number1346 index1345 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.isEmpty();</code></div><div class="line number1347 index1346 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1348 index1347 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">contains(Object o) {</code></div><div class="line number1349 index1348 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.containsKey(o);</code></div><div class="line number1350 index1349 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1351 index1350 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">remove(Object o) {</code></div><div class="line number1352 index1351 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.remove(o) != </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number1353 index1352 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1354 index1353 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">clear() {</code></div><div class="line number1355 index1354 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.clear();</code></div><div class="line number1356 index1355 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1357 index1356 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1358 index1357 alt1">&nbsp;</div><div class="line number1359 index1358 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">Values </code><code class="java keyword">extends</code> <code class="java plain">AbstractCollection&lt;V&gt; {</code></div><div class="line number1360 index1359 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Iterator&lt;V&gt; iterator() {</code></div><div class="line number1361 index1360 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">new</code> <code class="java plain">ValueIterator();</code></div><div class="line number1362 index1361 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1363 index1362 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">int</code> <code class="java plain">size() {</code></div><div class="line number1364 index1363 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.size();</code></div><div class="line number1365 index1364 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1366 index1365 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">isEmpty() {</code></div><div class="line number1367 index1366 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.isEmpty();</code></div><div class="line number1368 index1367 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1369 index1368 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">contains(Object o) {</code></div><div class="line number1370 index1369 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.containsValue(o);</code></div><div class="line number1371 index1370 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1372 index1371 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">clear() {</code></div><div class="line number1373 index1372 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.clear();</code></div><div class="line number1374 index1373 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1375 index1374 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1376 index1375 alt1">&nbsp;</div><div class="line number1377 index1376 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">class</code> <code class="java plain">EntrySet </code><code class="java keyword">extends</code> <code class="java plain">AbstractSet&lt;Map.Entry&lt;K,V&gt;&gt; {</code></div><div class="line number1378 index1377 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() {</code></div><div class="line number1379 index1378 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">new</code> <code class="java plain">EntryIterator();</code></div><div class="line number1380 index1379 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1381 index1380 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">contains(Object o) {</code></div><div class="line number1382 index1381 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(!(o </code><code class="java keyword">instanceof</code> <code class="java plain">Map.Entry))</code></div><div class="line number1383 index1382 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number1384 index1383 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</code></div><div class="line number1385 index1384 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V v = ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.get(e.getKey());</code></div><div class="line number1386 index1385 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">v != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp; v.equals(e.getValue());</code></div><div class="line number1387 index1386 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1388 index1387 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">remove(Object o) {</code></div><div class="line number1389 index1388 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(!(o </code><code class="java keyword">instanceof</code> <code class="java plain">Map.Entry))</code></div><div class="line number1390 index1389 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number1391 index1390 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</code></div><div class="line number1392 index1391 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.remove(e.getKey(), e.getValue());</code></div><div class="line number1393 index1392 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1394 index1393 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">int</code> <code class="java plain">size() {</code></div><div class="line number1395 index1394 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.size();</code></div><div class="line number1396 index1395 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1397 index1396 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">isEmpty() {</code></div><div class="line number1398 index1397 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.isEmpty();</code></div><div class="line number1399 index1398 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1400 index1399 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">clear() {</code></div><div class="line number1401 index1400 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ConcurrentHashMap.</code><code class="java keyword">this</code><code class="java plain">.clear();</code></div><div class="line number1402 index1401 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1403 index1402 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1404 index1403 alt1">&nbsp;</div><div class="line number1405 index1404 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/* ---------------- Serialization Support -------------- */</code></div><div class="line number1406 index1405 alt1">&nbsp;</div><div class="line number1407 index1406 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1408 index1407 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Save the state of the &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt; instance to a</code></div><div class="line number1409 index1408 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* stream (i.e., serialize it).</code></div><div class="line number1410 index1409 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param s the stream</code></div><div class="line number1411 index1410 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @serialData</code></div><div class="line number1412 index1411 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* the key (Object) and value (Object)</code></div><div class="line number1413 index1412 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* for each key-value mapping, followed by a null pair.</code></div><div class="line number1414 index1413 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The key-value mappings are emitted in no particular order.</code></div><div class="line number1415 index1414 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1416 index1415 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">void</code> <code class="java plain">writeObject(java.io.ObjectOutputStream s) </code><code class="java keyword">throws</code> <code class="java plain">IOException&nbsp; {</code></div><div class="line number1417 index1416 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// force all segments for serialization compatibility</code></div><div class="line number1418 index1417 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">k = </code><code class="java value">0</code><code class="java plain">; k &lt; segments.length; ++k)</code></div><div class="line number1419 index1418 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ensureSegment(k);</code></div><div class="line number1420 index1419 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.defaultWriteObject();</code></div><div class="line number1421 index1420 alt2">&nbsp;</div><div class="line number1422 index1421 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] segments = </code><code class="java keyword">this</code><code class="java plain">.segments;</code></div><div class="line number1423 index1422 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">k = </code><code class="java value">0</code><code class="java plain">; k &lt; segments.length; ++k) {</code></div><div class="line number1424 index1423 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; seg = segmentAt(segments, k);</code></div><div class="line number1425 index1424 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">seg.lock();</code></div><div class="line number1426 index1425 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number1427 index1426 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt;[] tab = seg.table;</code></div><div class="line number1428 index1427 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">i = </code><code class="java value">0</code><code class="java plain">; i &lt; tab.length; ++i) {</code></div><div class="line number1429 index1428 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">HashEntry&lt;K,V&gt; e;</code></div><div class="line number1430 index1429 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(e = entryAt(tab, i); e != </code><code class="java keyword">null</code><code class="java plain">; e = e.next) {</code></div><div class="line number1431 index1430 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.writeObject(e.key);</code></div><div class="line number1432 index1431 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.writeObject(e.value);</code></div><div class="line number1433 index1432 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1434 index1433 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1435 index1434 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">finally</code> <code class="java plain">{</code></div><div class="line number1436 index1435 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">seg.unlock();</code></div><div class="line number1437 index1436 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1438 index1437 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1439 index1438 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.writeObject(</code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number1440 index1439 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.writeObject(</code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number1441 index1440 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1442 index1441 alt1">&nbsp;</div><div class="line number1443 index1442 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number1444 index1443 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Reconstitute the &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt; instance from a</code></div><div class="line number1445 index1444 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* stream (i.e., deserialize it).</code></div><div class="line number1446 index1445 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param s the stream</code></div><div class="line number1447 index1446 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number1448 index1447 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@SuppressWarnings</code><code class="java plain">(</code><code class="java string">"unchecked"</code><code class="java plain">)</code></div><div class="line number1449 index1448 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">void</code> <code class="java plain">readObject(java.io.ObjectInputStream s)</code></div><div class="line number1450 index1449 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throws</code> <code class="java plain">IOException, ClassNotFoundException&nbsp; {</code></div><div class="line number1451 index1450 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Don't call defaultReadObject()</code></div><div class="line number1452 index1451 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ObjectInputStream.GetField oisFields = s.readFields();</code></div><div class="line number1453 index1452 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] oisSegments = (Segment&lt;K,V&gt;[])oisFields.get(</code><code class="java string">"segments"</code><code class="java plain">, </code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number1454 index1453 alt1">&nbsp;</div><div class="line number1455 index1454 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">ssize = oisSegments.length;</code></div><div class="line number1456 index1455 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(ssize &lt; </code><code class="java value">1</code> <code class="java plain">|| ssize &gt; MAX_SEGMENTS</code></div><div class="line number1457 index1456 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">|| (ssize &amp; (ssize-</code><code class="java value">1</code><code class="java plain">)) != </code><code class="java value">0</code> <code class="java plain">)&nbsp; </code><code class="java comments">// ssize not power of two</code></div><div class="line number1458 index1457 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">java.io.InvalidObjectException(</code><code class="java string">"Bad number of segments:"</code></div><div class="line number1459 index1458 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">+ ssize);</code></div><div class="line number1460 index1459 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">sshift = </code><code class="java value">0</code><code class="java plain">, ssizeTmp = ssize;</code></div><div class="line number1461 index1460 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(ssizeTmp &gt; </code><code class="java value">1</code><code class="java plain">) {</code></div><div class="line number1462 index1461 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">++sshift;</code></div><div class="line number1463 index1462 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ssizeTmp &gt;&gt;&gt;= </code><code class="java value">1</code><code class="java plain">;</code></div><div class="line number1464 index1463 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1465 index1464 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">UNSAFE.putIntVolatile(</code><code class="java keyword">this</code><code class="java plain">, SEGSHIFT_OFFSET, </code><code class="java value">32</code> <code class="java plain">- sshift);</code></div><div class="line number1466 index1465 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">UNSAFE.putIntVolatile(</code><code class="java keyword">this</code><code class="java plain">, SEGMASK_OFFSET, ssize - </code><code class="java value">1</code><code class="java plain">);</code></div><div class="line number1467 index1466 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">UNSAFE.putObjectVolatile(</code><code class="java keyword">this</code><code class="java plain">, SEGMENTS_OFFSET, oisSegments);</code></div><div class="line number1468 index1467 alt1">&nbsp;</div><div class="line number1469 index1468 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Re-initialize segments to be minimally sized, and let grow.</code></div><div class="line number1470 index1469 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">cap = MIN_SEGMENT_TABLE_CAPACITY;</code></div><div class="line number1471 index1470 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">final</code> <code class="java plain">Segment&lt;K,V&gt;[] segments = </code><code class="java keyword">this</code><code class="java plain">.segments;</code></div><div class="line number1472 index1471 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(</code><code class="java keyword">int</code> <code class="java plain">k = </code><code class="java value">0</code><code class="java plain">; k &lt; segments.length; ++k) {</code></div><div class="line number1473 index1472 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Segment&lt;K,V&gt; seg = segments[k];</code></div><div class="line number1474 index1473 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(seg != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number1475 index1474 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">seg.threshold = (</code><code class="java keyword">int</code><code class="java plain">)(cap * seg.loadFactor);</code></div><div class="line number1476 index1475 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">seg.table = (HashEntry&lt;K,V&gt;[]) </code><code class="java keyword">new</code> <code class="java plain">HashEntry[cap];</code></div><div class="line number1477 index1476 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1478 index1477 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1479 index1478 alt2">&nbsp;</div><div class="line number1480 index1479 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Read the keys and values, and put the mappings in the table</code></div><div class="line number1481 index1480 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number1482 index1481 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">K key = (K) s.readObject();</code></div><div class="line number1483 index1482 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">V value = (V) s.readObject();</code></div><div class="line number1484 index1483 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(key == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number1485 index1484 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number1486 index1485 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">put(key, value);</code></div><div class="line number1487 index1486 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1488 index1487 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1489 index1488 alt2">&nbsp;</div><div class="line number1490 index1489 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Unsafe mechanics</code></div><div class="line number1491 index1490 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java plain">sun.misc.Unsafe UNSAFE;</code></div><div class="line number1492 index1491 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">SBASE;</code></div><div class="line number1493 index1492 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">SSHIFT;</code></div><div class="line number1494 index1493 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">TBASE;</code></div><div class="line number1495 index1494 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">int</code> <code class="java plain">TSHIFT;</code></div><div class="line number1496 index1495 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">SEGSHIFT_OFFSET;</code></div><div class="line number1497 index1496 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">SEGMASK_OFFSET;</code></div><div class="line number1498 index1497 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">SEGMENTS_OFFSET;</code></div><div class="line number1499 index1498 alt2">&nbsp;</div><div class="line number1500 index1499 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">static</code> <code class="java plain">{</code></div><div class="line number1501 index1500 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">ss, ts;</code></div><div class="line number1502 index1501 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code> <code class="java plain">{</code></div><div class="line number1503 index1502 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">UNSAFE = sun.misc.Unsafe.getUnsafe();</code></div><div class="line number1504 index1503 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Class tc = HashEntry[].</code><code class="java keyword">class</code><code class="java plain">;</code></div><div class="line number1505 index1504 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Class sc = Segment[].</code><code class="java keyword">class</code><code class="java plain">;</code></div><div class="line number1506 index1505 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">TBASE = UNSAFE.arrayBaseOffset(tc);</code></div><div class="line number1507 index1506 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">SBASE = UNSAFE.arrayBaseOffset(sc);</code></div><div class="line number1508 index1507 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ts = UNSAFE.arrayIndexScale(tc);</code></div><div class="line number1509 index1508 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ss = UNSAFE.arrayIndexScale(sc);</code></div><div class="line number1510 index1509 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">SEGSHIFT_OFFSET = UNSAFE.objectFieldOffset(</code></div><div class="line number1511 index1510 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ConcurrentHashMap.</code><code class="java keyword">class</code><code class="java plain">.getDeclaredField(</code><code class="java string">"segmentShift"</code><code class="java plain">));</code></div><div class="line number1512 index1511 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">SEGMASK_OFFSET = UNSAFE.objectFieldOffset(</code></div><div class="line number1513 index1512 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ConcurrentHashMap.</code><code class="java keyword">class</code><code class="java plain">.getDeclaredField(</code><code class="java string">"segmentMask"</code><code class="java plain">));</code></div><div class="line number1514 index1513 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">SEGMENTS_OFFSET = UNSAFE.objectFieldOffset(</code></div><div class="line number1515 index1514 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ConcurrentHashMap.</code><code class="java keyword">class</code><code class="java plain">.getDeclaredField(</code><code class="java string">"segments"</code><code class="java plain">));</code></div><div class="line number1516 index1515 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">catch</code> <code class="java plain">(Exception e) {</code></div><div class="line number1517 index1516 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">Error(e);</code></div><div class="line number1518 index1517 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1519 index1518 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">((ss &amp; (ss-</code><code class="java value">1</code><code class="java plain">)) != </code><code class="java value">0</code> <code class="java plain">|| (ts &amp; (ts-</code><code class="java value">1</code><code class="java plain">)) != </code><code class="java value">0</code><code class="java plain">)</code></div><div class="line number1520 index1519 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">Error(</code><code class="java string">"data type scale not a power of two"</code><code class="java plain">);</code></div><div class="line number1521 index1520 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">SSHIFT = </code><code class="java value">31</code> <code class="java plain">- Integer.numberOfLeadingZeros(ss);</code></div><div class="line number1522 index1521 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">TSHIFT = </code><code class="java value">31</code> <code class="java plain">- Integer.numberOfLeadingZeros(ts);</code></div><div class="line number1523 index1522 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number1524 index1523 alt1">&nbsp;</div><div class="line number1525 index1524 alt2"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>
<h4>Java的ConcurrentLinkedQueue实现方法</h4>
<p><a href="http://docs.oracle.com/javase/1.5.0/docs/api/java/util/concurrent/ConcurrentLinkedQueue.html" target="_blank">ConcurrentLinkedQueue</a>也是同样使用了CAS指令，但其性能并不高因为<a href="http://www.infoq.com/articles/scalable-java-components/" target="_blank">太多CAS</a>操作。其源码如下：</p>
<div><div id="highlighter_974545" class="syntaxhighlighter collapsed  java"><div class="toolbar"><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_expandSource expandSource">+ View Code</a></span><span><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div><div class="line number166 index165 alt1">166</div><div class="line number167 index166 alt2">167</div><div class="line number168 index167 alt1">168</div><div class="line number169 index168 alt2">169</div><div class="line number170 index169 alt1">170</div><div class="line number171 index170 alt2">171</div><div class="line number172 index171 alt1">172</div><div class="line number173 index172 alt2">173</div><div class="line number174 index173 alt1">174</div><div class="line number175 index174 alt2">175</div><div class="line number176 index175 alt1">176</div><div class="line number177 index176 alt2">177</div><div class="line number178 index177 alt1">178</div><div class="line number179 index178 alt2">179</div><div class="line number180 index179 alt1">180</div><div class="line number181 index180 alt2">181</div><div class="line number182 index181 alt1">182</div><div class="line number183 index182 alt2">183</div><div class="line number184 index183 alt1">184</div><div class="line number185 index184 alt2">185</div><div class="line number186 index185 alt1">186</div><div class="line number187 index186 alt2">187</div><div class="line number188 index187 alt1">188</div><div class="line number189 index188 alt2">189</div><div class="line number190 index189 alt1">190</div><div class="line number191 index190 alt2">191</div><div class="line number192 index191 alt1">192</div><div class="line number193 index192 alt2">193</div><div class="line number194 index193 alt1">194</div><div class="line number195 index194 alt2">195</div><div class="line number196 index195 alt1">196</div><div class="line number197 index196 alt2">197</div><div class="line number198 index197 alt1">198</div><div class="line number199 index198 alt2">199</div><div class="line number200 index199 alt1">200</div><div class="line number201 index200 alt2">201</div><div class="line number202 index201 alt1">202</div><div class="line number203 index202 alt2">203</div><div class="line number204 index203 alt1">204</div><div class="line number205 index204 alt2">205</div><div class="line number206 index205 alt1">206</div><div class="line number207 index206 alt2">207</div><div class="line number208 index207 alt1">208</div><div class="line number209 index208 alt2">209</div><div class="line number210 index209 alt1">210</div><div class="line number211 index210 alt2">211</div><div class="line number212 index211 alt1">212</div><div class="line number213 index212 alt2">213</div><div class="line number214 index213 alt1">214</div><div class="line number215 index214 alt2">215</div><div class="line number216 index215 alt1">216</div><div class="line number217 index216 alt2">217</div><div class="line number218 index217 alt1">218</div><div class="line number219 index218 alt2">219</div><div class="line number220 index219 alt1">220</div><div class="line number221 index220 alt2">221</div><div class="line number222 index221 alt1">222</div><div class="line number223 index222 alt2">223</div><div class="line number224 index223 alt1">224</div><div class="line number225 index224 alt2">225</div><div class="line number226 index225 alt1">226</div><div class="line number227 index226 alt2">227</div><div class="line number228 index227 alt1">228</div><div class="line number229 index228 alt2">229</div><div class="line number230 index229 alt1">230</div><div class="line number231 index230 alt2">231</div><div class="line number232 index231 alt1">232</div><div class="line number233 index232 alt2">233</div><div class="line number234 index233 alt1">234</div><div class="line number235 index234 alt2">235</div><div class="line number236 index235 alt1">236</div><div class="line number237 index236 alt2">237</div><div class="line number238 index237 alt1">238</div><div class="line number239 index238 alt2">239</div><div class="line number240 index239 alt1">240</div><div class="line number241 index240 alt2">241</div><div class="line number242 index241 alt1">242</div><div class="line number243 index242 alt2">243</div><div class="line number244 index243 alt1">244</div><div class="line number245 index244 alt2">245</div><div class="line number246 index245 alt1">246</div><div class="line number247 index246 alt2">247</div><div class="line number248 index247 alt1">248</div><div class="line number249 index248 alt2">249</div><div class="line number250 index249 alt1">250</div><div class="line number251 index250 alt2">251</div><div class="line number252 index251 alt1">252</div><div class="line number253 index252 alt2">253</div><div class="line number254 index253 alt1">254</div><div class="line number255 index254 alt2">255</div><div class="line number256 index255 alt1">256</div><div class="line number257 index256 alt2">257</div><div class="line number258 index257 alt1">258</div><div class="line number259 index258 alt2">259</div><div class="line number260 index259 alt1">260</div><div class="line number261 index260 alt2">261</div><div class="line number262 index261 alt1">262</div><div class="line number263 index262 alt2">263</div><div class="line number264 index263 alt1">264</div><div class="line number265 index264 alt2">265</div><div class="line number266 index265 alt1">266</div><div class="line number267 index266 alt2">267</div><div class="line number268 index267 alt1">268</div><div class="line number269 index268 alt2">269</div><div class="line number270 index269 alt1">270</div><div class="line number271 index270 alt2">271</div><div class="line number272 index271 alt1">272</div><div class="line number273 index272 alt2">273</div><div class="line number274 index273 alt1">274</div><div class="line number275 index274 alt2">275</div><div class="line number276 index275 alt1">276</div><div class="line number277 index276 alt2">277</div><div class="line number278 index277 alt1">278</div><div class="line number279 index278 alt2">279</div><div class="line number280 index279 alt1">280</div><div class="line number281 index280 alt2">281</div><div class="line number282 index281 alt1">282</div><div class="line number283 index282 alt2">283</div><div class="line number284 index283 alt1">284</div><div class="line number285 index284 alt2">285</div><div class="line number286 index285 alt1">286</div><div class="line number287 index286 alt2">287</div><div class="line number288 index287 alt1">288</div><div class="line number289 index288 alt2">289</div><div class="line number290 index289 alt1">290</div><div class="line number291 index290 alt2">291</div><div class="line number292 index291 alt1">292</div><div class="line number293 index292 alt2">293</div><div class="line number294 index293 alt1">294</div><div class="line number295 index294 alt2">295</div><div class="line number296 index295 alt1">296</div><div class="line number297 index296 alt2">297</div><div class="line number298 index297 alt1">298</div><div class="line number299 index298 alt2">299</div><div class="line number300 index299 alt1">300</div><div class="line number301 index300 alt2">301</div><div class="line number302 index301 alt1">302</div><div class="line number303 index302 alt2">303</div><div class="line number304 index303 alt1">304</div><div class="line number305 index304 alt2">305</div><div class="line number306 index305 alt1">306</div><div class="line number307 index306 alt2">307</div><div class="line number308 index307 alt1">308</div><div class="line number309 index308 alt2">309</div><div class="line number310 index309 alt1">310</div><div class="line number311 index310 alt2">311</div><div class="line number312 index311 alt1">312</div><div class="line number313 index312 alt2">313</div><div class="line number314 index313 alt1">314</div><div class="line number315 index314 alt2">315</div><div class="line number316 index315 alt1">316</div><div class="line number317 index316 alt2">317</div><div class="line number318 index317 alt1">318</div><div class="line number319 index318 alt2">319</div><div class="line number320 index319 alt1">320</div><div class="line number321 index320 alt2">321</div><div class="line number322 index321 alt1">322</div><div class="line number323 index322 alt2">323</div><div class="line number324 index323 alt1">324</div><div class="line number325 index324 alt2">325</div><div class="line number326 index325 alt1">326</div><div class="line number327 index326 alt2">327</div><div class="line number328 index327 alt1">328</div><div class="line number329 index328 alt2">329</div><div class="line number330 index329 alt1">330</div><div class="line number331 index330 alt2">331</div><div class="line number332 index331 alt1">332</div><div class="line number333 index332 alt2">333</div><div class="line number334 index333 alt1">334</div><div class="line number335 index334 alt2">335</div><div class="line number336 index335 alt1">336</div><div class="line number337 index336 alt2">337</div><div class="line number338 index337 alt1">338</div><div class="line number339 index338 alt2">339</div><div class="line number340 index339 alt1">340</div><div class="line number341 index340 alt2">341</div><div class="line number342 index341 alt1">342</div><div class="line number343 index342 alt2">343</div><div class="line number344 index343 alt1">344</div><div class="line number345 index344 alt2">345</div><div class="line number346 index345 alt1">346</div><div class="line number347 index346 alt2">347</div><div class="line number348 index347 alt1">348</div><div class="line number349 index348 alt2">349</div><div class="line number350 index349 alt1">350</div><div class="line number351 index350 alt2">351</div><div class="line number352 index351 alt1">352</div><div class="line number353 index352 alt2">353</div><div class="line number354 index353 alt1">354</div><div class="line number355 index354 alt2">355</div><div class="line number356 index355 alt1">356</div><div class="line number357 index356 alt2">357</div><div class="line number358 index357 alt1">358</div><div class="line number359 index358 alt2">359</div><div class="line number360 index359 alt1">360</div><div class="line number361 index360 alt2">361</div><div class="line number362 index361 alt1">362</div><div class="line number363 index362 alt2">363</div><div class="line number364 index363 alt1">364</div><div class="line number365 index364 alt2">365</div><div class="line number366 index365 alt1">366</div><div class="line number367 index366 alt2">367</div><div class="line number368 index367 alt1">368</div><div class="line number369 index368 alt2">369</div><div class="line number370 index369 alt1">370</div><div class="line number371 index370 alt2">371</div><div class="line number372 index371 alt1">372</div><div class="line number373 index372 alt2">373</div><div class="line number374 index373 alt1">374</div><div class="line number375 index374 alt2">375</div><div class="line number376 index375 alt1">376</div><div class="line number377 index376 alt2">377</div><div class="line number378 index377 alt1">378</div><div class="line number379 index378 alt2">379</div><div class="line number380 index379 alt1">380</div><div class="line number381 index380 alt2">381</div><div class="line number382 index381 alt1">382</div><div class="line number383 index382 alt2">383</div><div class="line number384 index383 alt1">384</div><div class="line number385 index384 alt2">385</div><div class="line number386 index385 alt1">386</div><div class="line number387 index386 alt2">387</div><div class="line number388 index387 alt1">388</div><div class="line number389 index388 alt2">389</div><div class="line number390 index389 alt1">390</div><div class="line number391 index390 alt2">391</div><div class="line number392 index391 alt1">392</div><div class="line number393 index392 alt2">393</div><div class="line number394 index393 alt1">394</div><div class="line number395 index394 alt2">395</div><div class="line number396 index395 alt1">396</div><div class="line number397 index396 alt2">397</div><div class="line number398 index397 alt1">398</div><div class="line number399 index398 alt2">399</div><div class="line number400 index399 alt1">400</div><div class="line number401 index400 alt2">401</div><div class="line number402 index401 alt1">402</div><div class="line number403 index402 alt2">403</div><div class="line number404 index403 alt1">404</div><div class="line number405 index404 alt2">405</div><div class="line number406 index405 alt1">406</div><div class="line number407 index406 alt2">407</div><div class="line number408 index407 alt1">408</div><div class="line number409 index408 alt2">409</div><div class="line number410 index409 alt1">410</div><div class="line number411 index410 alt2">411</div><div class="line number412 index411 alt1">412</div><div class="line number413 index412 alt2">413</div><div class="line number414 index413 alt1">414</div><div class="line number415 index414 alt2">415</div><div class="line number416 index415 alt1">416</div><div class="line number417 index416 alt2">417</div><div class="line number418 index417 alt1">418</div><div class="line number419 index418 alt2">419</div><div class="line number420 index419 alt1">420</div><div class="line number421 index420 alt2">421</div><div class="line number422 index421 alt1">422</div><div class="line number423 index422 alt2">423</div><div class="line number424 index423 alt1">424</div><div class="line number425 index424 alt2">425</div><div class="line number426 index425 alt1">426</div><div class="line number427 index426 alt2">427</div><div class="line number428 index427 alt1">428</div><div class="line number429 index428 alt2">429</div><div class="line number430 index429 alt1">430</div><div class="line number431 index430 alt2">431</div><div class="line number432 index431 alt1">432</div><div class="line number433 index432 alt2">433</div><div class="line number434 index433 alt1">434</div><div class="line number435 index434 alt2">435</div><div class="line number436 index435 alt1">436</div><div class="line number437 index436 alt2">437</div><div class="line number438 index437 alt1">438</div><div class="line number439 index438 alt2">439</div><div class="line number440 index439 alt1">440</div><div class="line number441 index440 alt2">441</div><div class="line number442 index441 alt1">442</div><div class="line number443 index442 alt2">443</div><div class="line number444 index443 alt1">444</div><div class="line number445 index444 alt2">445</div><div class="line number446 index445 alt1">446</div><div class="line number447 index446 alt2">447</div><div class="line number448 index447 alt1">448</div><div class="line number449 index448 alt2">449</div><div class="line number450 index449 alt1">450</div><div class="line number451 index450 alt2">451</div><div class="line number452 index451 alt1">452</div><div class="line number453 index452 alt2">453</div><div class="line number454 index453 alt1">454</div><div class="line number455 index454 alt2">455</div><div class="line number456 index455 alt1">456</div><div class="line number457 index456 alt2">457</div><div class="line number458 index457 alt1">458</div><div class="line number459 index458 alt2">459</div><div class="line number460 index459 alt1">460</div><div class="line number461 index460 alt2">461</div><div class="line number462 index461 alt1">462</div><div class="line number463 index462 alt2">463</div><div class="line number464 index463 alt1">464</div><div class="line number465 index464 alt2">465</div><div class="line number466 index465 alt1">466</div><div class="line number467 index466 alt2">467</div><div class="line number468 index467 alt1">468</div><div class="line number469 index468 alt2">469</div><div class="line number470 index469 alt1">470</div><div class="line number471 index470 alt2">471</div><div class="line number472 index471 alt1">472</div><div class="line number473 index472 alt2">473</div><div class="line number474 index473 alt1">474</div><div class="line number475 index474 alt2">475</div><div class="line number476 index475 alt1">476</div><div class="line number477 index476 alt2">477</div><div class="line number478 index477 alt1">478</div><div class="line number479 index478 alt2">479</div><div class="line number480 index479 alt1">480</div><div class="line number481 index480 alt2">481</div><div class="line number482 index481 alt1">482</div><div class="line number483 index482 alt2">483</div><div class="line number484 index483 alt1">484</div><div class="line number485 index484 alt2">485</div><div class="line number486 index485 alt1">486</div><div class="line number487 index486 alt2">487</div><div class="line number488 index487 alt1">488</div><div class="line number489 index488 alt2">489</div><div class="line number490 index489 alt1">490</div><div class="line number491 index490 alt2">491</div><div class="line number492 index491 alt1">492</div><div class="line number493 index492 alt2">493</div><div class="line number494 index493 alt1">494</div><div class="line number495 index494 alt2">495</div><div class="line number496 index495 alt1">496</div><div class="line number497 index496 alt2">497</div><div class="line number498 index497 alt1">498</div><div class="line number499 index498 alt2">499</div><div class="line number500 index499 alt1">500</div><div class="line number501 index500 alt2">501</div><div class="line number502 index501 alt1">502</div><div class="line number503 index502 alt2">503</div><div class="line number504 index503 alt1">504</div><div class="line number505 index504 alt2">505</div><div class="line number506 index505 alt1">506</div><div class="line number507 index506 alt2">507</div><div class="line number508 index507 alt1">508</div><div class="line number509 index508 alt2">509</div><div class="line number510 index509 alt1">510</div><div class="line number511 index510 alt2">511</div><div class="line number512 index511 alt1">512</div><div class="line number513 index512 alt2">513</div><div class="line number514 index513 alt1">514</div><div class="line number515 index514 alt2">515</div><div class="line number516 index515 alt1">516</div><div class="line number517 index516 alt2">517</div><div class="line number518 index517 alt1">518</div><div class="line number519 index518 alt2">519</div><div class="line number520 index519 alt1">520</div><div class="line number521 index520 alt2">521</div><div class="line number522 index521 alt1">522</div><div class="line number523 index522 alt2">523</div><div class="line number524 index523 alt1">524</div><div class="line number525 index524 alt2">525</div><div class="line number526 index525 alt1">526</div><div class="line number527 index526 alt2">527</div><div class="line number528 index527 alt1">528</div><div class="line number529 index528 alt2">529</div><div class="line number530 index529 alt1">530</div><div class="line number531 index530 alt2">531</div><div class="line number532 index531 alt1">532</div><div class="line number533 index532 alt2">533</div><div class="line number534 index533 alt1">534</div><div class="line number535 index534 alt2">535</div><div class="line number536 index535 alt1">536</div><div class="line number537 index536 alt2">537</div><div class="line number538 index537 alt1">538</div><div class="line number539 index538 alt2">539</div><div class="line number540 index539 alt1">540</div><div class="line number541 index540 alt2">541</div><div class="line number542 index541 alt1">542</div><div class="line number543 index542 alt2">543</div><div class="line number544 index543 alt1">544</div><div class="line number545 index544 alt2">545</div><div class="line number546 index545 alt1">546</div><div class="line number547 index546 alt2">547</div><div class="line number548 index547 alt1">548</div><div class="line number549 index548 alt2">549</div><div class="line number550 index549 alt1">550</div><div class="line number551 index550 alt2">551</div><div class="line number552 index551 alt1">552</div><div class="line number553 index552 alt2">553</div><div class="line number554 index553 alt1">554</div><div class="line number555 index554 alt2">555</div><div class="line number556 index555 alt1">556</div><div class="line number557 index556 alt2">557</div><div class="line number558 index557 alt1">558</div><div class="line number559 index558 alt2">559</div><div class="line number560 index559 alt1">560</div><div class="line number561 index560 alt2">561</div><div class="line number562 index561 alt1">562</div><div class="line number563 index562 alt2">563</div><div class="line number564 index563 alt1">564</div><div class="line number565 index564 alt2">565</div><div class="line number566 index565 alt1">566</div><div class="line number567 index566 alt2">567</div><div class="line number568 index567 alt1">568</div><div class="line number569 index568 alt2">569</div><div class="line number570 index569 alt1">570</div><div class="line number571 index570 alt2">571</div><div class="line number572 index571 alt1">572</div><div class="line number573 index572 alt2">573</div><div class="line number574 index573 alt1">574</div><div class="line number575 index574 alt2">575</div><div class="line number576 index575 alt1">576</div><div class="line number577 index576 alt2">577</div><div class="line number578 index577 alt1">578</div><div class="line number579 index578 alt2">579</div><div class="line number580 index579 alt1">580</div><div class="line number581 index580 alt2">581</div><div class="line number582 index581 alt1">582</div><div class="line number583 index582 alt2">583</div><div class="line number584 index583 alt1">584</div><div class="line number585 index584 alt2">585</div><div class="line number586 index585 alt1">586</div><div class="line number587 index586 alt2">587</div><div class="line number588 index587 alt1">588</div><div class="line number589 index588 alt2">589</div><div class="line number590 index589 alt1">590</div><div class="line number591 index590 alt2">591</div><div class="line number592 index591 alt1">592</div><div class="line number593 index592 alt2">593</div><div class="line number594 index593 alt1">594</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java comments">/*</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* This code is free software; you can redistribute it and/or modify it</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* under the terms of the GNU General Public License version 2 only, as</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* published by the Free Software Foundation.&nbsp; Oracle designates this</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* particular file as subject to the "Classpath" exception as provided</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* by Oracle in the LICENSE file that accompanied this code.</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* This code is distributed in the hope that it will be useful, but WITHOUT</code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* FITNESS FOR A PARTICULAR PURPOSE.&nbsp; See the GNU General Public License</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* version 2 for more details (a copy is included in the LICENSE file that</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* accompanied this code).</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* You should have received a copy of the GNU General Public License version</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* 2 along with this work; if not, write to the Free Software Foundation,</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* or visit www.oracle.com if you need additional information or have any</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* questions.</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">*/</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="java comments">/*</code></div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* This file is available under and governed by the GNU General Public</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* License version 2 only, as published by the Free Software Foundation.</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* However, the following notice accompanied the original version of this</code></div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* file:</code></div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">*</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* Written by Doug Lea with assistance from members of JCP JSR-166</code></div><div class="line number32 index31 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">* Expert Group and released to the public domain, as explained at</code></div><div class="line number33 index32 alt2"><code class="java spaces">&nbsp;</code><code class="java comments">* <a href="http://creativecommons.org/licenses/publicdomain">http://creativecommons.org/licenses/publicdomain</a></code></div><div class="line number34 index33 alt1"><code class="java spaces">&nbsp;</code><code class="java comments">*/</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="java keyword">package</code> <code class="java plain">java.util.concurrent;</code></div><div class="line number37 index36 alt2"><code class="java keyword">import</code> <code class="java plain">java.util.*;</code></div><div class="line number38 index37 alt1"><code class="java keyword">import</code> <code class="java plain">java.util.concurrent.atomic.*;</code></div><div class="line number39 index38 alt2">&nbsp;</div><div class="line number40 index39 alt1">&nbsp;</div><div class="line number41 index40 alt2"><code class="java preprocessor">/**</code></div><div class="line number42 index41 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* An unbounded thread-safe {@linkplain Queue queue} based on linked nodes.</code></div><div class="line number43 index42 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* This queue orders elements FIFO (first-in-first-out).</code></div><div class="line number44 index43 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* The &lt;em&gt;head&lt;/em&gt; of the queue is that element that has been on the</code></div><div class="line number45 index44 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* queue the longest time.</code></div><div class="line number46 index45 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* The &lt;em&gt;tail&lt;/em&gt; of the queue is that element that has been on the</code></div><div class="line number47 index46 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* queue the shortest time. New elements</code></div><div class="line number48 index47 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* are inserted at the tail of the queue, and the queue retrieval</code></div><div class="line number49 index48 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* operations obtain elements at the head of the queue.</code></div><div class="line number50 index49 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* A &lt;tt&gt;ConcurrentLinkedQueue&lt;/tt&gt; is an appropriate choice when</code></div><div class="line number51 index50 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* many threads will share access to a common collection.</code></div><div class="line number52 index51 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* This queue does not permit &lt;tt&gt;null&lt;/tt&gt; elements.</code></div><div class="line number53 index52 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number54 index53 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt;This implementation employs an efficient &amp;quot;wait-free&amp;quot;</code></div><div class="line number55 index54 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* algorithm based on one described in &lt;a</code></div><div class="line number56 index55 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* href="<a href="http://www.cs.rochester.edu/u/michael/PODC96.html">http://www.cs.rochester.edu/u/michael/PODC96.html</a>"&gt; Simple,</code></div><div class="line number57 index56 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Fast, and Practical Non-Blocking and Blocking Concurrent Queue</code></div><div class="line number58 index57 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Algorithms&lt;/a&gt; by Maged M. Michael and Michael L. Scott.</code></div><div class="line number59 index58 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number60 index59 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt;Beware that, unlike in most collections, the &lt;tt&gt;size&lt;/tt&gt; method</code></div><div class="line number61 index60 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* is &lt;em&gt;NOT&lt;/em&gt; a constant-time operation. Because of the</code></div><div class="line number62 index61 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* asynchronous nature of these queues, determining the current number</code></div><div class="line number63 index62 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* of elements requires a traversal of the elements.</code></div><div class="line number64 index63 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number65 index64 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt;This class and its iterator implement all of the</code></div><div class="line number66 index65 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;em&gt;optional&lt;/em&gt; methods of the {@link Collection} and {@link</code></div><div class="line number67 index66 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Iterator} interfaces.</code></div><div class="line number68 index67 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number69 index68 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt;Memory consistency effects: As with other concurrent</code></div><div class="line number70 index69 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* collections, actions in a thread prior to placing an object into a</code></div><div class="line number71 index70 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* {@code ConcurrentLinkedQueue}</code></div><div class="line number72 index71 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;a href="package-summary.html#MemoryVisibility"&gt;&lt;i&gt;happen-before&lt;/i&gt;&lt;/a&gt;</code></div><div class="line number73 index72 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* actions subsequent to the access or removal of that element from</code></div><div class="line number74 index73 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* the {@code ConcurrentLinkedQueue} in another thread.</code></div><div class="line number75 index74 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number76 index75 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;p&gt;This class is a member of the</code></div><div class="line number77 index76 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* &lt;a href="{@docRoot}/../technotes/guides/collections/index.html"&gt;</code></div><div class="line number78 index77 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* Java Collections Framework&lt;/a&gt;.</code></div><div class="line number79 index78 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number80 index79 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* @since 1.5</code></div><div class="line number81 index80 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* @author Doug Lea</code></div><div class="line number82 index81 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">* @param &lt;E&gt; the type of elements held in this collection</code></div><div class="line number83 index82 alt2"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number84 index83 alt1"><code class="java spaces">&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number85 index84 alt2"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">ConcurrentLinkedQueue&lt;E&gt; </code><code class="java keyword">extends</code> <code class="java plain">AbstractQueue&lt;E&gt;</code></div><div class="line number86 index85 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">implements</code> <code class="java plain">Queue&lt;E&gt;, java.io.Serializable {</code></div><div class="line number87 index86 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code> <code class="java keyword">long</code> <code class="java plain">serialVersionUID = 196745693267521676L;</code></div><div class="line number88 index87 alt1">&nbsp;</div><div class="line number89 index88 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">/*</code></div><div class="line number90 index89 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* This is a straight adaptation of Michael &amp; Scott algorithm.</code></div><div class="line number91 index90 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* For explanation, read the paper.&nbsp; The only (minor) algorithmic</code></div><div class="line number92 index91 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* difference is that this version supports lazy deletion of</code></div><div class="line number93 index92 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* internal nodes (method remove(Object)) -- remove CAS'es item</code></div><div class="line number94 index93 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* fields to null. The normal queue operations unlink but then</code></div><div class="line number95 index94 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* pass over nodes with null item fields. Similarly, iteration</code></div><div class="line number96 index95 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* methods ignore those with nulls.</code></div><div class="line number97 index96 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">*</code></div><div class="line number98 index97 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* Also note that like most non-blocking algorithms in this</code></div><div class="line number99 index98 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* package, this implementation relies on the fact that in garbage</code></div><div class="line number100 index99 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* collected systems, there is no possibility of ABA problems due</code></div><div class="line number101 index100 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* to recycled nodes, so there is no need to use "counted</code></div><div class="line number102 index101 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* pointers" or related techniques seen in versions used in</code></div><div class="line number103 index102 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">* non-GC'ed settings.</code></div><div class="line number104 index103 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">*/</code></div><div class="line number105 index104 alt2">&nbsp;</div><div class="line number106 index105 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">class</code> <code class="java plain">Node&lt;E&gt; {</code></div><div class="line number107 index106 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">volatile</code> <code class="java plain">E item;</code></div><div class="line number108 index107 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">volatile</code> <code class="java plain">Node&lt;E&gt; next;</code></div><div class="line number109 index108 alt2">&nbsp;</div><div class="line number110 index109 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code></div><div class="line number111 index110 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReferenceFieldUpdater&lt;Node, Node&gt;</code></div><div class="line number112 index111 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextUpdater =</code></div><div class="line number113 index112 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReferenceFieldUpdater.newUpdater</code></div><div class="line number114 index113 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(Node.</code><code class="java keyword">class</code><code class="java plain">, Node.</code><code class="java keyword">class</code><code class="java plain">, </code><code class="java string">"next"</code><code class="java plain">);</code></div><div class="line number115 index114 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code></div><div class="line number116 index115 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReferenceFieldUpdater&lt;Node, Object&gt;</code></div><div class="line number117 index116 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">itemUpdater =</code></div><div class="line number118 index117 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReferenceFieldUpdater.newUpdater</code></div><div class="line number119 index118 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(Node.</code><code class="java keyword">class</code><code class="java plain">, Object.</code><code class="java keyword">class</code><code class="java plain">, </code><code class="java string">"item"</code><code class="java plain">);</code></div><div class="line number120 index119 alt1">&nbsp;</div><div class="line number121 index120 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node(E x) { item = x; }</code></div><div class="line number122 index121 alt1">&nbsp;</div><div class="line number123 index122 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node(E x, Node&lt;E&gt; n) { item = x; next = n; }</code></div><div class="line number124 index123 alt1">&nbsp;</div><div class="line number125 index124 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E getItem() {</code></div><div class="line number126 index125 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">item;</code></div><div class="line number127 index126 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number128 index127 alt1">&nbsp;</div><div class="line number129 index128 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">boolean</code> <code class="java plain">casItem(E cmp, E val) {</code></div><div class="line number130 index129 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">itemUpdater.compareAndSet(</code><code class="java keyword">this</code><code class="java plain">, cmp, val);</code></div><div class="line number131 index130 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number132 index131 alt1">&nbsp;</div><div class="line number133 index132 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">void</code> <code class="java plain">setItem(E val) {</code></div><div class="line number134 index133 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">itemUpdater.set(</code><code class="java keyword">this</code><code class="java plain">, val);</code></div><div class="line number135 index134 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number136 index135 alt1">&nbsp;</div><div class="line number137 index136 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; getNext() {</code></div><div class="line number138 index137 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">next;</code></div><div class="line number139 index138 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number140 index139 alt1">&nbsp;</div><div class="line number141 index140 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">boolean</code> <code class="java plain">casNext(Node&lt;E&gt; cmp, Node&lt;E&gt; val) {</code></div><div class="line number142 index141 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">nextUpdater.compareAndSet(</code><code class="java keyword">this</code><code class="java plain">, cmp, val);</code></div><div class="line number143 index142 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number144 index143 alt1">&nbsp;</div><div class="line number145 index144 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">void</code> <code class="java plain">setNext(Node&lt;E&gt; val) {</code></div><div class="line number146 index145 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextUpdater.set(</code><code class="java keyword">this</code><code class="java plain">, val);</code></div><div class="line number147 index146 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number148 index147 alt1">&nbsp;</div><div class="line number149 index148 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number150 index149 alt1">&nbsp;</div><div class="line number151 index150 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code></div><div class="line number152 index151 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReferenceFieldUpdater&lt;ConcurrentLinkedQueue, Node&gt;</code></div><div class="line number153 index152 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">tailUpdater =</code></div><div class="line number154 index153 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReferenceFieldUpdater.newUpdater</code></div><div class="line number155 index154 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(ConcurrentLinkedQueue.</code><code class="java keyword">class</code><code class="java plain">, Node.</code><code class="java keyword">class</code><code class="java plain">, </code><code class="java string">"tail"</code><code class="java plain">);</code></div><div class="line number156 index155 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java keyword">final</code></div><div class="line number157 index156 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReferenceFieldUpdater&lt;ConcurrentLinkedQueue, Node&gt;</code></div><div class="line number158 index157 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">headUpdater =</code></div><div class="line number159 index158 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">AtomicReferenceFieldUpdater.newUpdater</code></div><div class="line number160 index159 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">(ConcurrentLinkedQueue.</code><code class="java keyword">class</code><code class="java plain">,&nbsp; Node.</code><code class="java keyword">class</code><code class="java plain">, </code><code class="java string">"head"</code><code class="java plain">);</code></div><div class="line number161 index160 alt2">&nbsp;</div><div class="line number162 index161 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">boolean</code> <code class="java plain">casTail(Node&lt;E&gt; cmp, Node&lt;E&gt; val) {</code></div><div class="line number163 index162 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">tailUpdater.compareAndSet(</code><code class="java keyword">this</code><code class="java plain">, cmp, val);</code></div><div class="line number164 index163 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number165 index164 alt2">&nbsp;</div><div class="line number166 index165 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">boolean</code> <code class="java plain">casHead(Node&lt;E&gt; cmp, Node&lt;E&gt; val) {</code></div><div class="line number167 index166 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">headUpdater.compareAndSet(</code><code class="java keyword">this</code><code class="java plain">, cmp, val);</code></div><div class="line number168 index167 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number169 index168 alt2">&nbsp;</div><div class="line number170 index169 alt1">&nbsp;</div><div class="line number171 index170 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number172 index171 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Pointer to header node, initialized to a dummy node.&nbsp; The first</code></div><div class="line number173 index172 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* actual node is at head.getNext().</code></div><div class="line number174 index173 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number175 index174 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">transient</code> <code class="java keyword">volatile</code> <code class="java plain">Node&lt;E&gt; head = </code><code class="java keyword">new</code> <code class="java plain">Node&lt;E&gt;(</code><code class="java keyword">null</code><code class="java plain">, </code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number176 index175 alt1">&nbsp;</div><div class="line number177 index176 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/** Pointer to last node on list **/</code></div><div class="line number178 index177 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">transient</code> <code class="java keyword">volatile</code> <code class="java plain">Node&lt;E&gt; tail = head;</code></div><div class="line number179 index178 alt2">&nbsp;</div><div class="line number180 index179 alt1">&nbsp;</div><div class="line number181 index180 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number182 index181 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Creates a &lt;tt&gt;ConcurrentLinkedQueue&lt;/tt&gt; that is initially empty.</code></div><div class="line number183 index182 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number184 index183 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">ConcurrentLinkedQueue() {}</code></div><div class="line number185 index184 alt2">&nbsp;</div><div class="line number186 index185 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number187 index186 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Creates a &lt;tt&gt;ConcurrentLinkedQueue&lt;/tt&gt;</code></div><div class="line number188 index187 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* initially containing the elements of the given collection,</code></div><div class="line number189 index188 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* added in traversal order of the collection's iterator.</code></div><div class="line number190 index189 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param c the collection of elements to initially contain</code></div><div class="line number191 index190 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified collection or any</code></div><div class="line number192 index191 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; of its elements are null</code></div><div class="line number193 index192 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number194 index193 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">ConcurrentLinkedQueue(Collection&lt;? </code><code class="java keyword">extends</code> <code class="java plain">E&gt; c) {</code></div><div class="line number195 index194 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(Iterator&lt;? </code><code class="java keyword">extends</code> <code class="java plain">E&gt; it = c.iterator(); it.hasNext();)</code></div><div class="line number196 index195 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">add(it.next());</code></div><div class="line number197 index196 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number198 index197 alt1">&nbsp;</div><div class="line number199 index198 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Have to override just to update the javadoc</code></div><div class="line number200 index199 alt1">&nbsp;</div><div class="line number201 index200 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number202 index201 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Inserts the specified element at the tail of this queue.</code></div><div class="line number203 index202 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number204 index203 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; (as specified by {@link Collection#add})</code></div><div class="line number205 index204 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified element is null</code></div><div class="line number206 index205 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number207 index206 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">add(E e) {</code></div><div class="line number208 index207 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">offer(e);</code></div><div class="line number209 index208 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number210 index209 alt1">&nbsp;</div><div class="line number211 index210 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number212 index211 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Inserts the specified element at the tail of this queue.</code></div><div class="line number213 index212 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number214 index213 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; (as specified by {@link Queue#offer})</code></div><div class="line number215 index214 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified element is null</code></div><div class="line number216 index215 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number217 index216 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">offer(E e) {</code></div><div class="line number218 index217 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(e == </code><code class="java keyword">null</code><code class="java plain">) </code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NullPointerException();</code></div><div class="line number219 index218 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; n = </code><code class="java keyword">new</code> <code class="java plain">Node&lt;E&gt;(e, </code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number220 index219 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number221 index220 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; t = tail;</code></div><div class="line number222 index221 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; s = t.getNext();</code></div><div class="line number223 index222 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(t == tail) {</code></div><div class="line number224 index223 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(s == </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number225 index224 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(t.casNext(s, n)) {</code></div><div class="line number226 index225 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">casTail(t, n);</code></div><div class="line number227 index226 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number228 index227 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number229 index228 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">else</code> <code class="java plain">{</code></div><div class="line number230 index229 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">casTail(t, s);</code></div><div class="line number231 index230 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number232 index231 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number233 index232 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number234 index233 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number235 index234 alt2">&nbsp;</div><div class="line number236 index235 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">E poll() {</code></div><div class="line number237 index236 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number238 index237 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; h = head;</code></div><div class="line number239 index238 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; t = tail;</code></div><div class="line number240 index239 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; first = h.getNext();</code></div><div class="line number241 index240 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(h == head) {</code></div><div class="line number242 index241 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(h == t) {</code></div><div class="line number243 index242 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(first == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number244 index243 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number245 index244 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number246 index245 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">casTail(t, first);</code></div><div class="line number247 index246 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">else</code> <code class="java keyword">if</code> <code class="java plain">(casHead(h, first)) {</code></div><div class="line number248 index247 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = first.getItem();</code></div><div class="line number249 index248 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number250 index249 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">first.setItem(</code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number251 index250 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">item;</code></div><div class="line number252 index251 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number253 index252 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// else skip over deleted item, continue loop,</code></div><div class="line number254 index253 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number255 index254 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number256 index255 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number257 index256 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number258 index257 alt1">&nbsp;</div><div class="line number259 index258 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">E peek() { </code><code class="java comments">// same as poll except don't remove item</code></div><div class="line number260 index259 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number261 index260 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; h = head;</code></div><div class="line number262 index261 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; t = tail;</code></div><div class="line number263 index262 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; first = h.getNext();</code></div><div class="line number264 index263 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(h == head) {</code></div><div class="line number265 index264 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(h == t) {</code></div><div class="line number266 index265 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(first == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number267 index266 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number268 index267 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number269 index268 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">casTail(t, first);</code></div><div class="line number270 index269 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">else</code> <code class="java plain">{</code></div><div class="line number271 index270 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = first.getItem();</code></div><div class="line number272 index271 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number273 index272 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">item;</code></div><div class="line number274 index273 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java comments">// remove deleted node and continue</code></div><div class="line number275 index274 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">casHead(h, first);</code></div><div class="line number276 index275 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number277 index276 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number278 index277 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number279 index278 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number280 index279 alt1">&nbsp;</div><div class="line number281 index280 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number282 index281 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns the first actual (non-header) node on list.&nbsp; This is yet</code></div><div class="line number283 index282 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* another variant of poll/peek; here returning out the first</code></div><div class="line number284 index283 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* node, not element (so we cannot collapse with peek() without</code></div><div class="line number285 index284 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* introducing race.)</code></div><div class="line number286 index285 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number287 index286 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; first() {</code></div><div class="line number288 index287 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number289 index288 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; h = head;</code></div><div class="line number290 index289 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; t = tail;</code></div><div class="line number291 index290 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; first = h.getNext();</code></div><div class="line number292 index291 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(h == head) {</code></div><div class="line number293 index292 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(h == t) {</code></div><div class="line number294 index293 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(first == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number295 index294 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number296 index295 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number297 index296 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">casTail(t, first);</code></div><div class="line number298 index297 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">else</code> <code class="java plain">{</code></div><div class="line number299 index298 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(first.getItem() != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number300 index299 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">first;</code></div><div class="line number301 index300 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code> <code class="java comments">// remove deleted node and continue</code></div><div class="line number302 index301 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">casHead(h, first);</code></div><div class="line number303 index302 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number304 index303 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number305 index304 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number306 index305 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number307 index306 alt2">&nbsp;</div><div class="line number308 index307 alt1">&nbsp;</div><div class="line number309 index308 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number310 index309 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns &lt;tt&gt;true&lt;/tt&gt; if this queue contains no elements.</code></div><div class="line number311 index310 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number312 index311 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; if this queue contains no elements</code></div><div class="line number313 index312 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number314 index313 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">isEmpty() {</code></div><div class="line number315 index314 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">first() == </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number316 index315 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number317 index316 alt2">&nbsp;</div><div class="line number318 index317 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number319 index318 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns the number of elements in this queue.&nbsp; If this queue</code></div><div class="line number320 index319 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* contains more than &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt; elements, returns</code></div><div class="line number321 index320 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt;.</code></div><div class="line number322 index321 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number323 index322 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;Beware that, unlike in most collections, this method is</code></div><div class="line number324 index323 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;em&gt;NOT&lt;/em&gt; a constant-time operation. Because of the</code></div><div class="line number325 index324 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* asynchronous nature of these queues, determining the current</code></div><div class="line number326 index325 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* number of elements requires an O(n) traversal.</code></div><div class="line number327 index326 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number328 index327 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return the number of elements in this queue</code></div><div class="line number329 index328 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number330 index329 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">int</code> <code class="java plain">size() {</code></div><div class="line number331 index330 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">count = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number332 index331 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(Node&lt;E&gt; p = first(); p != </code><code class="java keyword">null</code><code class="java plain">; p = p.getNext()) {</code></div><div class="line number333 index332 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(p.getItem() != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number334 index333 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Collections.size() spec says to max out</code></div><div class="line number335 index334 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(++count == Integer.MAX_VALUE)</code></div><div class="line number336 index335 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number337 index336 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number338 index337 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number339 index338 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">count;</code></div><div class="line number340 index339 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number341 index340 alt2">&nbsp;</div><div class="line number342 index341 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number343 index342 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns &lt;tt&gt;true&lt;/tt&gt; if this queue contains the specified element.</code></div><div class="line number344 index343 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* More formally, returns &lt;tt&gt;true&lt;/tt&gt; if and only if this queue contains</code></div><div class="line number345 index344 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* at least one element &lt;tt&gt;e&lt;/tt&gt; such that &lt;tt&gt;o.equals(e)&lt;/tt&gt;.</code></div><div class="line number346 index345 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number347 index346 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param o object to be checked for containment in this queue</code></div><div class="line number348 index347 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; if this queue contains the specified element</code></div><div class="line number349 index348 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number350 index349 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">contains(Object o) {</code></div><div class="line number351 index350 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(o == </code><code class="java keyword">null</code><code class="java plain">) </code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number352 index351 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(Node&lt;E&gt; p = first(); p != </code><code class="java keyword">null</code><code class="java plain">; p = p.getNext()) {</code></div><div class="line number353 index352 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = p.getItem();</code></div><div class="line number354 index353 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp;</code></div><div class="line number355 index354 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">o.equals(item))</code></div><div class="line number356 index355 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number357 index356 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number358 index357 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number359 index358 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number360 index359 alt1">&nbsp;</div><div class="line number361 index360 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number362 index361 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Removes a single instance of the specified element from this queue,</code></div><div class="line number363 index362 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* if it is present.&nbsp; More formally, removes an element &lt;tt&gt;e&lt;/tt&gt; such</code></div><div class="line number364 index363 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* that &lt;tt&gt;o.equals(e)&lt;/tt&gt;, if this queue contains one or more such</code></div><div class="line number365 index364 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* elements.</code></div><div class="line number366 index365 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns &lt;tt&gt;true&lt;/tt&gt; if this queue contained the specified element</code></div><div class="line number367 index366 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* (or equivalently, if this queue changed as a result of the call).</code></div><div class="line number368 index367 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number369 index368 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param o element to be removed from this queue, if present</code></div><div class="line number370 index369 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return &lt;tt&gt;true&lt;/tt&gt; if this queue changed as a result of the call</code></div><div class="line number371 index370 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number372 index371 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">remove(Object o) {</code></div><div class="line number373 index372 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(o == </code><code class="java keyword">null</code><code class="java plain">) </code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number374 index373 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(Node&lt;E&gt; p = first(); p != </code><code class="java keyword">null</code><code class="java plain">; p = p.getNext()) {</code></div><div class="line number375 index374 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = p.getItem();</code></div><div class="line number376 index375 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp;</code></div><div class="line number377 index376 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">o.equals(item) &amp;&amp;</code></div><div class="line number378 index377 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">p.casItem(item, </code><code class="java keyword">null</code><code class="java plain">))</code></div><div class="line number379 index378 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">true</code><code class="java plain">;</code></div><div class="line number380 index379 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number381 index380 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">false</code><code class="java plain">;</code></div><div class="line number382 index381 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number383 index382 alt2">&nbsp;</div><div class="line number384 index383 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number385 index384 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns an array containing all of the elements in this queue, in</code></div><div class="line number386 index385 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* proper sequence.</code></div><div class="line number387 index386 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number388 index387 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;The returned array will be "safe" in that no references to it are</code></div><div class="line number389 index388 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* maintained by this queue.&nbsp; (In other words, this method must allocate</code></div><div class="line number390 index389 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* a new array).&nbsp; The caller is thus free to modify the returned array.</code></div><div class="line number391 index390 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number392 index391 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;This method acts as bridge between array-based and collection-based</code></div><div class="line number393 index392 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* APIs.</code></div><div class="line number394 index393 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number395 index394 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return an array containing all of the elements in this queue</code></div><div class="line number396 index395 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number397 index396 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Object[] toArray() {</code></div><div class="line number398 index397 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Use ArrayList to deal with resizing.</code></div><div class="line number399 index398 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ArrayList&lt;E&gt; al = </code><code class="java keyword">new</code> <code class="java plain">ArrayList&lt;E&gt;();</code></div><div class="line number400 index399 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(Node&lt;E&gt; p = first(); p != </code><code class="java keyword">null</code><code class="java plain">; p = p.getNext()) {</code></div><div class="line number401 index400 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = p.getItem();</code></div><div class="line number402 index401 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number403 index402 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">al.add(item);</code></div><div class="line number404 index403 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number405 index404 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">al.toArray();</code></div><div class="line number406 index405 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number407 index406 alt2">&nbsp;</div><div class="line number408 index407 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number409 index408 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns an array containing all of the elements in this queue, in</code></div><div class="line number410 index409 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* proper sequence; the runtime type of the returned array is that of</code></div><div class="line number411 index410 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* the specified array.&nbsp; If the queue fits in the specified array, it</code></div><div class="line number412 index411 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* is returned therein.&nbsp; Otherwise, a new array is allocated with the</code></div><div class="line number413 index412 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* runtime type of the specified array and the size of this queue.</code></div><div class="line number414 index413 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number415 index414 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;If this queue fits in the specified array with room to spare</code></div><div class="line number416 index415 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* (i.e., the array has more elements than this queue), the element in</code></div><div class="line number417 index416 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* the array immediately following the end of the queue is set to</code></div><div class="line number418 index417 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;null&lt;/tt&gt;.</code></div><div class="line number419 index418 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number420 index419 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;Like the {@link #toArray()} method, this method acts as bridge between</code></div><div class="line number421 index420 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* array-based and collection-based APIs.&nbsp; Further, this method allows</code></div><div class="line number422 index421 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* precise control over the runtime type of the output array, and may,</code></div><div class="line number423 index422 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* under certain circumstances, be used to save allocation costs.</code></div><div class="line number424 index423 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number425 index424 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;Suppose &lt;tt&gt;x&lt;/tt&gt; is a queue known to contain only strings.</code></div><div class="line number426 index425 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The following code can be used to dump the queue into a newly</code></div><div class="line number427 index426 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* allocated array of &lt;tt&gt;String&lt;/tt&gt;:</code></div><div class="line number428 index427 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number429 index428 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;pre&gt;</code></div><div class="line number430 index429 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp; String[] y = x.toArray(new String[0]);&lt;/pre&gt;</code></div><div class="line number431 index430 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number432 index431 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Note that &lt;tt&gt;toArray(new Object[0])&lt;/tt&gt; is identical in function to</code></div><div class="line number433 index432 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;toArray()&lt;/tt&gt;.</code></div><div class="line number434 index433 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number435 index434 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param a the array into which the elements of the queue are to</code></div><div class="line number436 index435 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; be stored, if it is big enough; otherwise, a new array of the</code></div><div class="line number437 index436 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; same runtime type is allocated for this purpose</code></div><div class="line number438 index437 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return an array containing all of the elements in this queue</code></div><div class="line number439 index438 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws ArrayStoreException if the runtime type of the specified array</code></div><div class="line number440 index439 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is not a supertype of the runtime type of every element in</code></div><div class="line number441 index440 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this queue</code></div><div class="line number442 index441 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @throws NullPointerException if the specified array is null</code></div><div class="line number443 index442 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number444 index443 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">&lt;T&gt; T[] toArray(T[] a) {</code></div><div class="line number445 index444 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// try to use sent-in array</code></div><div class="line number446 index445 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">int</code> <code class="java plain">k = </code><code class="java value">0</code><code class="java plain">;</code></div><div class="line number447 index446 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; p;</code></div><div class="line number448 index447 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(p = first(); p != </code><code class="java keyword">null</code> <code class="java plain">&amp;&amp; k &lt; a.length; p = p.getNext()) {</code></div><div class="line number449 index448 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = p.getItem();</code></div><div class="line number450 index449 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number451 index450 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">a[k++] = (T)item;</code></div><div class="line number452 index451 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number453 index452 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(p == </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number454 index453 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(k &lt; a.length)</code></div><div class="line number455 index454 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">a[k] = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number456 index455 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">a;</code></div><div class="line number457 index456 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number458 index457 alt1">&nbsp;</div><div class="line number459 index458 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// If won't fit, use ArrayList version</code></div><div class="line number460 index459 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ArrayList&lt;E&gt; al = </code><code class="java keyword">new</code> <code class="java plain">ArrayList&lt;E&gt;();</code></div><div class="line number461 index460 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(Node&lt;E&gt; q = first(); q != </code><code class="java keyword">null</code><code class="java plain">; q = q.getNext()) {</code></div><div class="line number462 index461 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = q.getItem();</code></div><div class="line number463 index462 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number464 index463 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">al.add(item);</code></div><div class="line number465 index464 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number466 index465 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">al.toArray(a);</code></div><div class="line number467 index466 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number468 index467 alt1">&nbsp;</div><div class="line number469 index468 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number470 index469 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns an iterator over the elements in this queue in proper sequence.</code></div><div class="line number471 index470 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The returned iterator is a "weakly consistent" iterator that</code></div><div class="line number472 index471 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* will never throw {@link ConcurrentModificationException},</code></div><div class="line number473 index472 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* and guarantees to traverse elements as they existed upon</code></div><div class="line number474 index473 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* construction of the iterator, and may (but is not guaranteed to)</code></div><div class="line number475 index474 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* reflect any modifications subsequent to construction.</code></div><div class="line number476 index475 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number477 index476 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return an iterator over the elements in this queue in proper sequence</code></div><div class="line number478 index477 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number479 index478 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">Iterator&lt;E&gt; iterator() {</code></div><div class="line number480 index479 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java keyword">new</code> <code class="java plain">Itr();</code></div><div class="line number481 index480 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number482 index481 alt1">&nbsp;</div><div class="line number483 index482 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">class</code> <code class="java plain">Itr </code><code class="java keyword">implements</code> <code class="java plain">Iterator&lt;E&gt; {</code></div><div class="line number484 index483 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number485 index484 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Next node to return item for.</code></div><div class="line number486 index485 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number487 index486 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">Node&lt;E&gt; nextNode;</code></div><div class="line number488 index487 alt1">&nbsp;</div><div class="line number489 index488 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number490 index489 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* nextItem holds on to item fields because once we claim</code></div><div class="line number491 index490 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* that an element exists in hasNext(), we must return it in</code></div><div class="line number492 index491 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* the following next() call even if it was in the process of</code></div><div class="line number493 index492 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* being removed when hasNext() was called.</code></div><div class="line number494 index493 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number495 index494 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">E nextItem;</code></div><div class="line number496 index495 alt1">&nbsp;</div><div class="line number497 index496 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number498 index497 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Node of the last returned item, to support remove.</code></div><div class="line number499 index498 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number500 index499 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">Node&lt;E&gt; lastRet;</code></div><div class="line number501 index500 alt2">&nbsp;</div><div class="line number502 index501 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Itr() {</code></div><div class="line number503 index502 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">advance();</code></div><div class="line number504 index503 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number505 index504 alt2">&nbsp;</div><div class="line number506 index505 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number507 index506 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Moves to next valid node and returns item to return for</code></div><div class="line number508 index507 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* next(), or null if no such.</code></div><div class="line number509 index508 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number510 index509 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java plain">E advance() {</code></div><div class="line number511 index510 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lastRet = nextNode;</code></div><div class="line number512 index511 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E x = nextItem;</code></div><div class="line number513 index512 alt2">&nbsp;</div><div class="line number514 index513 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; p = (nextNode == </code><code class="java keyword">null</code><code class="java plain">)? first() : nextNode.getNext();</code></div><div class="line number515 index514 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number516 index515 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(p == </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number517 index516 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextNode = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number518 index517 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextItem = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number519 index518 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">x;</code></div><div class="line number520 index519 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number521 index520 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = p.getItem();</code></div><div class="line number522 index521 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code><code class="java plain">) {</code></div><div class="line number523 index522 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextNode = p;</code></div><div class="line number524 index523 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">nextItem = item;</code></div><div class="line number525 index524 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">x;</code></div><div class="line number526 index525 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">else</code> <code class="java comments">// skip over nulls</code></div><div class="line number527 index526 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">p = p.getNext();</code></div><div class="line number528 index527 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number529 index528 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number530 index529 alt1">&nbsp;</div><div class="line number531 index530 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">boolean</code> <code class="java plain">hasNext() {</code></div><div class="line number532 index531 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">nextNode != </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number533 index532 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number534 index533 alt1">&nbsp;</div><div class="line number535 index534 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java plain">E next() {</code></div><div class="line number536 index535 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(nextNode == </code><code class="java keyword">null</code><code class="java plain">) </code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">NoSuchElementException();</code></div><div class="line number537 index536 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">return</code> <code class="java plain">advance();</code></div><div class="line number538 index537 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number539 index538 alt2">&nbsp;</div><div class="line number540 index539 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">remove() {</code></div><div class="line number541 index540 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Node&lt;E&gt; l = lastRet;</code></div><div class="line number542 index541 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(l == </code><code class="java keyword">null</code><code class="java plain">) </code><code class="java keyword">throw</code> <code class="java keyword">new</code> <code class="java plain">IllegalStateException();</code></div><div class="line number543 index542 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// rely on a future traversal to relink.</code></div><div class="line number544 index543 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">l.setItem(</code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number545 index544 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lastRet = </code><code class="java keyword">null</code><code class="java plain">;</code></div><div class="line number546 index545 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number547 index546 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number548 index547 alt1">&nbsp;</div><div class="line number549 index548 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number550 index549 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Save the state to a stream (that is, serialize it).</code></div><div class="line number551 index550 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number552 index551 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @serialData All of the elements (each an &lt;tt&gt;E&lt;/tt&gt;) in</code></div><div class="line number553 index552 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* the proper order, followed by a null</code></div><div class="line number554 index553 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param s the stream</code></div><div class="line number555 index554 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number556 index555 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">void</code> <code class="java plain">writeObject(java.io.ObjectOutputStream s)</code></div><div class="line number557 index556 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throws</code> <code class="java plain">java.io.IOException {</code></div><div class="line number558 index557 alt1">&nbsp;</div><div class="line number559 index558 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Write out any hidden stuff</code></div><div class="line number560 index559 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.defaultWriteObject();</code></div><div class="line number561 index560 alt2">&nbsp;</div><div class="line number562 index561 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Write out all elements in the proper order.</code></div><div class="line number563 index562 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(Node&lt;E&gt; p = first(); p != </code><code class="java keyword">null</code><code class="java plain">; p = p.getNext()) {</code></div><div class="line number564 index563 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Object item = p.getItem();</code></div><div class="line number565 index564 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item != </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number566 index565 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.writeObject(item);</code></div><div class="line number567 index566 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number568 index567 alt1">&nbsp;</div><div class="line number569 index568 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Use trailing null as sentinel</code></div><div class="line number570 index569 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.writeObject(</code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number571 index570 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number572 index571 alt1">&nbsp;</div><div class="line number573 index572 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number574 index573 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Reconstitute the Queue instance from a stream (that is,</code></div><div class="line number575 index574 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* deserialize it).</code></div><div class="line number576 index575 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @param s the stream</code></div><div class="line number577 index576 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number578 index577 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">void</code> <code class="java plain">readObject(java.io.ObjectInputStream s)</code></div><div class="line number579 index578 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">throws</code> <code class="java plain">java.io.IOException, ClassNotFoundException {</code></div><div class="line number580 index579 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Read in capacity, and any hidden stuff</code></div><div class="line number581 index580 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">s.defaultReadObject();</code></div><div class="line number582 index581 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">head = </code><code class="java keyword">new</code> <code class="java plain">Node&lt;E&gt;(</code><code class="java keyword">null</code><code class="java plain">, </code><code class="java keyword">null</code><code class="java plain">);</code></div><div class="line number583 index582 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">tail = head;</code></div><div class="line number584 index583 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Read in all elements and place in queue</code></div><div class="line number585 index584 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">for</code> <code class="java plain">(;;) {</code></div><div class="line number586 index585 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">E item = (E)s.readObject();</code></div><div class="line number587 index586 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(item == </code><code class="java keyword">null</code><code class="java plain">)</code></div><div class="line number588 index587 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number589 index588 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">else</code></div><div class="line number590 index589 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">offer(item);</code></div><div class="line number591 index590 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number592 index591 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number593 index592 alt2">&nbsp;</div><div class="line number594 index593 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>
<h4>高并发环境下优化锁或无锁（lock-free）的设计思路</h4>
<p>服务端编程的3大性能杀手：1、大量线程导致的线程切换开销。2、锁。3、非必要的内存拷贝。在高并发下,对于纯内存操作来说,单线程是要比多线程快的, 可以比较一下多线程程序在压力测试下cpu的sy和ni百分比。高并发环境下要实现高吞吐量和线程安全，两个思路：一个是用优化的锁实现，一个是lock-free的无锁结构。但非阻塞算法要比基于锁的算法复杂得多。开发非阻塞算法是相当专业的训练，而且要证明算法的正确也极为困难，不仅和具体的目标机器平台和编译器相关，而且需要复杂的技巧和严格的测试。虽然Lock-Free编程非常困难，但是它通常可以带来比基于锁编程更高的吞吐量。所以Lock-Free编程是大有前途的技术。它在线程中止、优先级倒置以及信号安全等方面都有着良好的表现。</p>
<ul>
<li><strong>优化锁实现的例子</strong>：Java中的<a href="http://www.docjar.com/html/api/java/util/concurrent/ConcurrentHashMap.java.html" target="_blank">ConcurrentHashMap</a>，设计巧妙，用桶粒度的锁和锁分离机制，避免了put和get中对整个map的锁定，尤其在get中，只对一个HashEntry做锁定操作，性能提升是显而易见的（详细分析见《<a href="http://www.ibm.com/developerworks/cn/java/java-lo-concurrenthashmap/" target="_blank">探索 ConcurrentHashMap 高并发性的实现机制</a>》）。</li>
<li><strong>Lock-free无锁的例子</strong>：CAS（CPU的Compare-And-Swap指令）的利用和LMAX的<a href="http://lmax-exchange.github.io/disruptor/" target="_blank">disruptor</a>无锁消息队列数据结构等。有兴趣了解LMAX的<a href="http://lmax-exchange.github.io/disruptor/" target="_blank">disruptor</a>无锁消息队列数据结构的可以移步<a href="http://www.slideshare.net/guynir/the-edge-2012-disruptor-guy-raz-nir-published" target="_blank">slideshare</a>。</li>
</ul>
<p><a href="http://lmax-exchange.github.io/disruptor/" target="_blank">disruptor</a>无锁消息队列数据结构的类图和<a href="http://disruptor.googlecode.com/files/Disruptor-1.0.pdf" target="_blank">技术文档下载</a></p>
<p><a href="https://images0.cnblogs.com/blog/28306/201402/121727220603460.png"><img style="display: inline; border-width: 0px;" title="2014-02-12_16h55_36" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/121727239741075.png" alt="2014-02-12_16h55_36" width="640" height="463" border="0"></a></p>
<p>另外，在设计思路上除了尽量减少资源争用以外，还可以借鉴<a href="http://javasogo.iteye.com/blog/1060114" target="_blank">nginx/node.js</a>等单线程大循环的机制，用单线程或CPU数相同的线程开辟大的队列，并发的时候任务压入队列，线程轮询然后一个个顺序执行。由于每个都采用异步I/O，没有阻塞线程。这个大队列可以使用RabbitMQueue，或是JDK的同步队列（性能稍差），或是使用<a href="http://lmax-exchange.github.io/disruptor/" target="_blank">Disruptor无锁队列</a>(Java)。任务处理可以全部放在内存（多级缓存、读写分离、ConcurrentHashMap、甚至分布式缓存Redis）中进行增删改查。最后用Quarz维护定时把缓存数据同步到DB中。当然，这只是中小型系统的思路，如果是大型分布式系统会非常复杂，需要分而治理，用SOA的思路，参考<a href="http://www.iteye.com/topic/1128561" target="_blank">这篇文章的图</a>。（注：Redis是单线程的纯内存数据库，单线程无需锁，而Memcache是多线程的带CAS算法，两者都使用epoll，no-blocking io）</p>
<p><a href="https://images0.cnblogs.com/blog/28306/201402/121727267405520.png"><img style="display: inline; border-width: 0px;" title="png;base643f17317a5d7e7fe9" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/121727294975265.png" alt="png;base643f17317a5d7e7fe9" width="640" height="479" border="0"></a></p>
<h4>深入JVM的OS的无锁非阻塞算法</h4>
<p>如果深入 JVM 和操作系统，会发现非阻塞算法无处不在。<strong>垃圾收集器</strong>使用非阻塞算法加快并发和平行的垃圾搜集；<strong>调度器</strong>使用非阻塞算法有效地调度线程和进程，实现内在锁。在 Mustang（Java 6.0）中，基于锁的 <code>SynchronousQueue</code> 算法被新的非阻塞版本代替。很少有开发人员会直接使用 <code>SynchronousQueue</code>，但是通过 <code>Executors.newCachedThreadPool()</code> 工厂构建的线程池用它作为工作队列。比较缓存线程池性能的对比测试显示，<strong>新的非阻塞同步队列</strong>实现提供了几乎是当前实现 3 倍的速度。在 Mustang 的后续版本（代码名称为 Dolphin）中，已经规划了进一步的改进。</p>
<h4>参考文献</h4>
<p><a href="http://www.ibm.com/developerworks/library/j-jtp11234/" target="_blank">IBM developerworks: Java theory and practice: Going atomic</a></p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory">分类: <a href="https://www.cnblogs.com/Mainz/category/131983.html" target="_blank">算法</a>,<a href="https://www.cnblogs.com/Mainz/category/371899.html" target="_blank">Java</a></div>
<div id="EntryTag">标签: <a href="https://www.cnblogs.com/Mainz/tag/%E6%80%A7%E8%83%BD/">性能</a>, <a href="https://www.cnblogs.com/Mainz/tag/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%8F%91/">多线程并发</a>, <a href="https://www.cnblogs.com/Mainz/tag/Java/">Java</a></div>
<div id="blog_post_info"><div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(3546347,cb_blogId,1);green_channel_success(this,&#39;谢谢推荐！&#39;);">好文要顶</a>
            <a id="green_channel_follow" onclick="follow(&#39;76883d0b-63cf-dd11-9e4d-001cf0cd104b&#39;);" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/Mainz/" target="_blank"><img src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/20140511162658.png" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/Mainz/">Mainz</a><br>
            <a href="http://home.cnblogs.com/u/Mainz/followees">关注 - 19</a><br>
            <a href="http://home.cnblogs.com/u/Mainz/followers">粉丝 - 1050</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor">荣誉：<a href="http://www.cnblogs.com/expert/" target="_blank">推荐博客</a></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow(&#39;76883d0b-63cf-dd11-9e4d-001cf0cd104b&#39;);return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(3546347,&#39;Digg&#39;)">
        <span class="diggnum" id="digg_count">20</span>
    </div>
    <div class="buryit" onclick="votePost(3546347,&#39;Bury&#39;)">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>
<script type="text/javascript">
    currentDiggType = 0;
</script></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="https://www.cnblogs.com/Mainz/p/3544824.html" class="p_n_p_prefix">« </a> 上一篇：<a href="https://www.cnblogs.com/Mainz/p/3544824.html" title="发布于2014-02-11 17:37">常见数据结构的Java实现</a><br><a href="https://www.cnblogs.com/Mainz/p/3548396.html" class="p_n_p_prefix">» </a> 下一篇：<a href="https://www.cnblogs.com/Mainz/p/3548396.html" title="发布于2014-02-13 17:00">OSGI动态加载删除Service bundle</a><br></div>
</div>

</div>
		<p class="postfoot">
			posted on <span id="post-date">2014-02-12 17:27</span> <a href="https://www.cnblogs.com/Mainz/">Mainz</a> 阅读(<span id="post_view_count">39072</span>) 评论(<span id="post_comment_count">10</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=3546347" rel="nofollow">编辑</a> <a href="https://www.cnblogs.com/Mainz/p/3546347.html#" onclick="AddToWz(3546347);return false;">收藏</a>
		</p>
	</div>
	<script type="text/javascript">var allowComments=true,cb_blogId=31859,cb_entryId=3546347,cb_blogApp=currentBlogApp,cb_blogUserGuid='76883d0b-63cf-dd11-9e4d-001cf0cd104b',cb_entryCreatedDate='2014/2/12 17:27:00';loadViewCount(cb_entryId);var cb_postType=1;var isMarkdown=false;</script>
	
	</div><a name="!comments"></a><div id="blog-comments-placeholder"><div id="comments_pager_top"></div>
<a name="评论"></a>
<div id="comments">
<h3>评论</h3>
	
	
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#3370078" class="layer">#1楼</a><a name="3370078" id="comment_anchor_3370078"></a>
					<span>
						 <span class="comment_date">2016-03-02 10:53</span>
					</span>
				<a id="a_comment_author_3370078" href="https://www.cnblogs.com/lewh/" target="_blank">SupremeHover</a> <a href="http://msg.cnblogs.com/send/SupremeHover" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_3370078" class="blog_comment_body">CAS无锁算法那部分讲得还行。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3370078,&#39;Digg&#39;,this)">支持(1)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3370078,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_3370078_avatar" style="display:none;">http://pic.cnblogs.com/face/133463/20160411221724.png</span>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#3594181" class="layer">#2楼</a><a name="3594181" id="comment_anchor_3594181"></a>
					<span>
						 <span class="comment_date">2017-01-01 20:50</span>
					</span>
				<a id="a_comment_author_3594181" href="http://home.cnblogs.com/u/901024/" target="_blank">zhaoch93</a> <a href="http://msg.cnblogs.com/send/zhaoch93" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_3594181" class="blog_comment_body">受教了，感谢博主</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3594181,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3594181,&#39;Bury&#39;,this)">反对(0)</a></div>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#3691273" class="layer">#3楼</a><a name="3691273" id="comment_anchor_3691273"></a>
					<span>
						 <span class="comment_date">2017-05-13 11:18</span>
					</span>
				<a id="a_comment_author_3691273" href="http://home.cnblogs.com/u/1151932/" target="_blank">石弦</a> <a href="http://msg.cnblogs.com/send/%E7%9F%B3%E5%BC%A6" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_3691273" class="blog_comment_body">受教了，感谢博主，登上来就为博主点个赞</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3691273,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3691273,&#39;Bury&#39;,this)">反对(0)</a></div>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#3735882" class="layer">#4楼</a><a name="3735882" id="comment_anchor_3735882"></a>
					<span>
						 <span class="comment_date">2017-07-15 17:14</span>
					</span>
				<a id="a_comment_author_3735882" href="https://www.cnblogs.com/gaorong/" target="_blank">gaorong404</a> <a href="http://msg.cnblogs.com/send/gaorong404" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_3735882" class="blog_comment_body">深度和广度都有！ 赞！</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3735882,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3735882,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_3735882_avatar" style="display:none;">http://pic.cnblogs.com/face/1111516/20170222212901.png</span>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#3865352" class="layer">#5楼</a><a name="3865352" id="comment_anchor_3865352"></a>
					<span>
						 <span class="comment_date">2017-12-13 22:54</span>
					</span>
				<a id="a_comment_author_3865352" href="https://www.cnblogs.com/pengkunfan/" target="_blank">midu</a> <a href="http://msg.cnblogs.com/send/midu" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_3865352" class="blog_comment_body">纳秒级别，都是硬件深度了，不错！</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3865352,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3865352,&#39;Bury&#39;,this)">反对(0)</a></div>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#3880667" class="layer">#6楼</a><a name="3880667" id="comment_anchor_3880667"></a>
					<span>
						 <span class="comment_date">2018-01-03 17:14</span>
					</span>
				<a id="a_comment_author_3880667" href="https://www.cnblogs.com/stevenlii/" target="_blank">stevenlii</a> <a href="http://msg.cnblogs.com/send/stevenlii" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_3880667" class="blog_comment_body">可以说写到心里了</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3880667,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3880667,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_3880667_avatar" style="display:none;">http://pic.cnblogs.com/face/676090/20140925170353.png</span>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#3955045" class="layer">#7楼</a><a name="3955045" id="comment_anchor_3955045"></a>
					<span>
						 <span class="comment_date">2018-04-18 21:10</span>
					</span>
				<a id="a_comment_author_3955045" href="http://home.cnblogs.com/u/517291/" target="_blank">fpwang</a> <a href="http://msg.cnblogs.com/send/fpwang" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_3955045" class="blog_comment_body">Hi 博主。感谢分享。你在这篇文章提到给long类型加volatile就会线程安全，“因为volatile内部已经做了synchronized.”。不过你在另一篇文章“为什么volatile不能保证原子性而Atomic可以”中却用代码举例说明“voaltile的自增没有原子性”。这有点矛盾吧？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3955045,&#39;Digg&#39;,this)">支持(2)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3955045,&#39;Bury&#39;,this)">反对(0)</a></div>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#4016709" class="layer">#8楼</a><a name="4016709" id="comment_anchor_4016709"></a>
					<span>
						 <span class="comment_date">2018-07-10 09:40</span>
					</span>
				<a id="a_comment_author_4016709" href="https://www.cnblogs.com/jilinwula/" target="_blank">吉林乌拉</a> <a href="http://msg.cnblogs.com/send/%E5%90%89%E6%9E%97%E4%B9%8C%E6%8B%89" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_4016709" class="blog_comment_body">顶楼主，确实很有深度，想不请教一下楼主，这些知识是在哪块了解的呢？是哪本书吗</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4016709,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(4016709,&#39;Bury&#39;,this)">反对(0)</a></div>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#4063073" class="layer">#9楼</a><a name="4063073" id="comment_anchor_4063073"></a>
					<span>
						 <span class="comment_date">2018-09-10 19:26</span>
					</span>
				<a id="a_comment_author_4063073" href="https://www.cnblogs.com/hruipeng61/" target="_blank">胡六一</a> <a href="http://msg.cnblogs.com/send/%E8%83%A1%E5%85%AD%E4%B8%80" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_4063073" class="blog_comment_body">条理清楚,逻辑明白,赞一个!<br>楼主辛苦</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4063073,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(4063073,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_4063073_avatar" style="display:none;">http://pic.cnblogs.com/face/1453746/20180730162707.png</span>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
			<h4>
				<a href="https://www.cnblogs.com/Mainz/p/3546347.html#4103187" class="layer">#10楼</a><a name="4103187" id="comment_anchor_4103187"></a><span id="comment-maxId" style="display:none;">4103187</span><span id="comment-maxDate" style="display:none;">2018/10/31 22:42:02</span>
					<span>
						 <span class="comment_date">2018-10-31 22:42</span>
					</span>
				<a id="a_comment_author_4103187" href="http://home.cnblogs.com/u/1164703/" target="_blank">大金镯子</a> <a href="http://msg.cnblogs.com/send/%E5%A4%A7%E9%87%91%E9%95%AF%E5%AD%90" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</h4>
			<p>
				</p><div id="comment_body_4103187" class="blog_comment_body">操作long类型加了volatile就线程安全了？前面说了volatile不能保证原子性，后面就说long类型的赋值分两步，加了volatile就成了synchronized了，矛盾啊</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(4103187,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(4103187,&#39;Bury&#39;,this)">反对(0)</a></div>
				&nbsp;&nbsp;<span class="comment_actions"></span>
			<p></p>
		
</div><div id="comments_pager_bottom"></div></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="https://www.cnblogs.com/Mainz/p/3546347.html#" onclick="return RefreshPage();">刷新页面</a><a href="https://www.cnblogs.com/Mainz/p/3546347.html#top">返回顶部</a></div>
<div id="comment_form_container"><div class="login_tips">注册用户登录后才能发表评论，请 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return login(&#39;commentform&#39;);">登录</a> 或 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return register();">注册</a>，<a href="http://www.cnblogs.com/">访问</a>网站首页。</div></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="ad_t2"><a href="http://www.ucancode.com/index.htm" target="_blank" onclick="ga(&#39;send&#39;, &#39;event&#39;, &#39;Link&#39;, &#39;click&#39;, &#39;T2-工控&#39;)">【推荐】超50万VC++源码: 大型组态工控、电力仿真CAD与GIS源码库！</a><br></div>
<div id="opt_under_post"></div>
<script async="async" src="./非阻塞同步算法与CAS(Compare and Swap)无锁算法 - Mainz - 博客园_files/gpt.js.下载"></script>
<script>
  var googletag = googletag || {};
  googletag.cmd = googletag.cmd || [];
</script>
<script>
  googletag.cmd.push(function() {
        googletag.defineSlot('/1090369/C1', [300, 250], 'div-gpt-ad-1546353474406-0').addService(googletag.pubads());
        googletag.defineSlot('/1090369/C2', [468, 60], 'div-gpt-ad-1539008685004-0').addService(googletag.pubads());
        googletag.pubads().enableSingleRequest();
        googletag.enableServices();
  });
</script>
<div id="cnblogs_c1" class="c_ad_block">
    <div id="div-gpt-ad-1546353474406-0" style="height:250px; width:300px;"></div>
</div>
<div id="under_post_news"><div class="itnews c_ad_block"><b>相关博文：</b><br>·  <a href="https://www.cnblogs.com/wangzhongqiu/p/6542710.html" target="_blank" onclick="clickRecomItmem(6542710,&#39;gCEM8pRp+D6uqxPv4eze47Z05fccLzOSBDcIAX0c2tHOkvWA2AbbSGOK+SC1zT86M4ZemtC3GFo8b1t+GH24Jo6Evq7ZBnorDf1kLRMhhDWa+IjTNI5KCjliO1mrhqiNh2Z3zaoCE61JCjZbKs8=&#39;)">【Java并发编程】9、非阻塞同步算法与CAS(Compare and Swap)无锁算法</a><br>·  <a href="https://www.cnblogs.com/ktgu/p/3529145.html" target="_blank" onclick="clickRecomItmem(3529145,&#39;4cyUJsIAa7ml1OfiWFBb3/QxIxmcEPxMmlE+9aM+DEwBl/QLf40N8f2Ph4ESGji28bT0Dwu1B4VaX1N2LvqLK0mGrY5VU80nGFLohnPmXrAgPt3RiuoQeL8dEOiVMls5OYJJiUWBWJLGlHsAVOM=&#39;)">基于CAS操作的非阻塞算法</a><br>·  <a href="https://www.cnblogs.com/zengxianxi/p/3517185.html" target="_blank" onclick="clickRecomItmem(3517185,&#39;gWLa8e8Mh8MyGt4wQ96Zhi9LmIsZq9uUMWXQaonCahrqNqOq1h8EvU7NbUrSuZMwiVeO/sW6xw3ZumPrjBS2aohxz2GKE3WFQ3TIlo4PB7KOwluH78PpwF0oGEPhxnFaoC4D7dvT3AjiRFoOMls=&#39;)">非阻塞的同步、无锁（CAS算法）</a><br>·  <a href="https://www.cnblogs.com/keeplearnning/p/7004609.html" target="_blank" onclick="clickRecomItmem(7004609,&#39;lTwYXKURVq1/PuIOk9Cgm2wuZBtF83ikvfAiMBWNgt3d0ZyJUtRfZ4lEmQ+Dk+jG8wwsHwRa8qDisTBl25d1jv6zqOeFJDvwwdJgvhWb2BgiS6vfq4w6h6GjUZ9crzN3ZzAoOzRjETSFLnL5lGQ=&#39;)">Compare and Swap [CAS] 算法</a><br>·  <a href="https://www.cnblogs.com/trytocatch/p/no-blocking-do-1.html" target="_blank" onclick="clickRecomItmem(3323171,&#39;o+q5wuBZfFQdp7hu0ZGRnTRdRM0cJKo1IuJZRy0YH6lmEz9uKrIn9W8fiqQcoJx5R5/hIRrN8k098wJvXevHQopz4quwkbxaUOgtGNXczZOkeddagTA0Oi0ltkUIs9nahvaChWIu7TEVp+S+I3I=&#39;)">非阻塞同步算法实战（一）</a><br></div></div>
<div id="cnblogs_c2" class="c_ad_block">
    <div id="div-gpt-ad-1539008685004-0" style="height:60px; width:468px;"></div>
</div>
<div id="under_post_kb"><div class="itnews c_ad_block"><b>最新新闻</b>：<br> ·  <a href="https://news.cnblogs.com/n/617915/" target="_blank">搜狗ai合成主播，它将会改变了些什么？</a><br> ·  <a href="https://news.cnblogs.com/n/617914/" target="_blank">知乎短视频应用「即影」截图曝光，不做知识分享做社交</a><br> ·  <a href="https://news.cnblogs.com/n/617909/" target="_blank">剑桥大学研发大脑训练游戏Decoder 声称可提升注意力和专注力</a><br> ·  <a href="https://news.cnblogs.com/n/617911/" target="_blank">乐视网空空如也</a><br> ·  <a href="https://news.cnblogs.com/n/617910/" target="_blank">蔚来地图王凡语：接连遭遇贾跃亭、罗永浩，但我依然是个幸运的人</a><br>» <a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">更多新闻...</a></div></div>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
 if(enablePostBottom()) {
    codeHighlight();
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverT2();
    deliverC1();
    deliverC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);  
}
</script>
</div>

    
</div>
<div id="rightmenu">
	
		


		

<div class="newsItem">
	<div id="blog-news"><div class="box">
   <div id="about_body" style="overflow:hidden;" class="tag cloud">
  </div></div>
<div class="box" id="hidarea" style="width:100%;overflow:hidden;">
  <div class="box" id="hidtags" style="overflow:hidden;">
     <h3 style="font-size:11px;">标签云</h3> 
     <div class="tagcloud">
    <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/WCF/">WCF</a>
   <a style="font-size: 16.4pt;" href="http://www.cnblogs.com/mainz/tag/%E6%9E%B6%E6%9E%84/">架构</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/%E5%93%B2%E7%90%86/">哲理</a>
<a style="font-size: 20pt;" href="http://www.cnblogs.com/Mainz/tag/Java/">Java</a>
 <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/%E7%BD%91%E9%A1%B5%E8%AE%BE%E8%AE%A1/">网页设计</a>
   <a style="font-size: 11.6pt;" href="http://www.cnblogs.com/mainz/tag/UNIX/">Unix</a>  
   <a style="font-size: 13pt;" href="http://www.cnblogs.com/mainz/tag/%E8%AE%BE%E8%AE%A1/">设计</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/uml/">UML</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/Ria/">Ria</a>
   <a style="font-size: 16.4pt;" href="http://www.cnblogs.com/mainz/tag/JavaScript/">JavaScript  </a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/logging/">Logging</a>
<a style="font-size: 14pt;" href="http://www.cnblogs.com/Mainz/tag/csharp/">C#</a>
   <a style="font-size: 13pt;" href="http://www.cnblogs.com/mainz/tag/ExtJS/">ExtJS</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/SNS/">SNS</a>
   <a style="font-size: 16.4pt;" href="http://www.cnblogs.com/mainz/tag/%E6%80%A7%E8%83%BD/">性能 </a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/%E7%BD%91%E7%AB%99/">网站</a>
   <a style="font-size: 14pt;" href="http://www.cnblogs.com/mainz/tag/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/">管理</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/MVVM/">MVVM</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/xml/">XML</a>
<a style="font-size: 13pt;" href="http://www.cnblogs.com/Mainz/tag/%E4%BF%AE%E8%A1%8C/">修行</a>
   <a style="font-size: 9pt;" href="http://www.cnblogs.com/mainz/tag/Prism/">Prism</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/SQL/">SQL</a>
<a style="font-size: 16.4pt;" href="http://www.cnblogs.com/mainz/tag/Spring/">Spring</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/mainz/tag/%E5%88%9B%E4%B8%9A/">创业  </a>
   <a style="font-size: 12pt;" href="http://www.cnblogs.com/mainz/tag/ASP.NET/">ASP.NET </a>
    <a style="font-size: 8pt;" href="http://www.cnblogs.com/Mainz/tag/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/">内存泄露</a>
   <a style="font-size: 12pt;" href="http://www.cnblogs.com/Mainz/tag/jQuery/">jQuery</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/Mainz/tag/%E6%B2%9F%E9%80%9A/">沟通</a>
   <a style="font-size: 13pt;" href="http://www.cnblogs.com/Mainz/tag/LINQ/">linq</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/Mainz/tag/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a>
   <a style="font-size: 8pt;" href="http://www.cnblogs.com/Mainz/tag/SSRS/">SSRS</a>
</div>
</div>

<div class="box" id="zhaopingle" style="margin-bottom:60px">
  <h3 style="font-size:18px;color:red">招聘.NET/Java开发/技术经理/架构（互联网行业）</h3>
  <h4 style="font-size:14px;color:orange">（工作地点：上海长宁 , 本招聘信息长期有效）</h4>
  <a href="mailto:mikerchen@msn.com?subject=%E6%8B%9B%E8%81%98">联系方式</a>
</div>
<div class="box" id="hidtheme" style="overflow:hidden;display:none">
     <h3 style="font-size:13px;">切换皮肤</h3>
     <ul id="styles"> 
        <li title="Black" id="black"></li> 
	<li title="Red" id="red"></li> 
        <li title="Gray" id="gray"></li> 
        <li title="Dark blue" id="dark_blue"></li> 
	<li title="Light blue" id="light_blue"></li> 
	<li title="Dark green" id="dark_green"></li> 
	<li title="Grass green" id="grass_green"></li> 
        <li title="Default" id="default"></li> 
   </ul> 
  </div>

</div><div id="profile_block">昵称：<a href="https://home.cnblogs.com/u/Mainz/">Mainz</a><br>园龄：<a href="https://home.cnblogs.com/u/Mainz/" title="入园时间：2007-12-14">11年1个月</a><br>荣誉：<a href="https://www.cnblogs.com/expert/">推荐博客</a><br>粉丝：<a href="https://home.cnblogs.com/u/Mainz/followers/">1050</a><br>关注：<a href="https://home.cnblogs.com/u/Mainz/followees/">19</a><div id="p_b_follow"><a href="javascript:void(0);" onclick="follow(&#39;76883d0b-63cf-dd11-9e4d-001cf0cd104b&#39;)">+加关注</a></div><script>getFollowStatus('76883d0b-63cf-dd11-9e4d-001cf0cd104b')</script></div></div><script type="text/javascript">loadBlogNews();</script>
</div>					
		<div id="blog-calendar" style="display:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script>
		
		<div id="blog-sidecolumn"><div id="sidebar_search" class="sidebar-block">
<div id="sidebar_search" class="mySearch">
<h3 class="catListTitle">搜索</h3>
<div id="sidebar_search_box">
<div id="widget_my_zzk" class="div_my_zzk"><input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk"></div>
<div id="widget_my_google" class="div_my_zzk"><input type="text" name="google_q" id="google_q" onkeydown="return google_go_enter(event)" class="input_my_zzk">&nbsp;<input onclick="google_go()" type="button" value="谷歌搜索" class="btn_my_zzk"></div>
</div>
</div>

</div><div id="sidebar_recentposts" class="sidebar-block">
<h3 class="catListTitle">最新随笔</h3>
<div class="RecentComment" id="RecentPosts">
<ul style="word-break:break-all">
<li><a href="https://www.cnblogs.com/Mainz/p/5188143.html">1. ShadowSocks搭建</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4842133.html">2. Top 20 Java Libries Used by Github's Most Popular Java Projects</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4821498.html">3. Why Apache Spark is a Crossover Hit for Data Scientists [FWD]</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4605761.html">4. Clojure的并行与并发</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4497104.html">5. Clojure上手</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4497093.html">6. 抽象之虚拟层</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4337163.html">7. 《微管理》读书笔记</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4337056.html">8. 如何设计优秀的API（转）</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4227416.html">9. Java开源框架推荐（全）</a></li><li><a href="https://www.cnblogs.com/Mainz/p/4098884.html">10. Java性能提示（全）</a></li>
</ul>
</div>
</div><div id="sidebar_categories">
		<h3>随笔分类<span style="font-size:11px;font-weight:normal">(304)</span></h3>
		
				<ul>
			
				<li><a id="CatList_LinkList_0_Link_0" href="https://www.cnblogs.com/Mainz/category/129681.html">C#(53)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_1" href="https://www.cnblogs.com/Mainz/category/147906.html">Database / SQL(14)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_2" href="https://www.cnblogs.com/Mainz/category/334264.html">Html5(3)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_3" href="https://www.cnblogs.com/Mainz/category/371899.html">Java(28)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_4" href="https://www.cnblogs.com/Mainz/category/283772.html">SilverLight(3)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_5" href="https://www.cnblogs.com/Mainz/category/125746.html">SOA / WCF(5)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_6" href="https://www.cnblogs.com/Mainz/category/116082.html">XML(1)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_7" href="https://www.cnblogs.com/Mainz/category/556882.html">工作笔记(3)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_8" href="https://www.cnblogs.com/Mainz/category/116158.html">架构与设计模式(31)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_9" href="https://www.cnblogs.com/Mainz/category/126444.html">其它(86)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_10" href="https://www.cnblogs.com/Mainz/category/131305.html">商业/技术不是全部(18)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_11" href="https://www.cnblogs.com/Mainz/category/131983.html">算法(5)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_12" href="https://www.cnblogs.com/Mainz/category/116083.html">项目管理与流程改进(32)</a> </li>
			
				<li><a id="CatList_LinkList_0_Link_13" href="https://www.cnblogs.com/Mainz/category/122569.html">职场(22)</a> </li>
			
				</ul>
			
	</div><div id="sidebar_scorerank" class="sidebar-block">
<h3>积分与排名</h3>
<ul>
	<li>
		积分 -
		529661
	</li><li>
		排名 -
		290
	</li>
</ul>
</div><div id="sidebar_recentcomments" class="sidebar-block"><div id="recent_comments_wrap">
<h3 class="catListTitle">最新评论</h3>
<div class="RecentComment" id="RecentComments">
	<div id="RecentCommentsBlock"><ul>
        <li class="recent_comment_title"><a href="https://www.cnblogs.com/Mainz/p/3546347.html#4103187">1. Re:非阻塞同步算法与CAS(Compare and Swap)无锁算法</a></li>
        <li class="recent_comment_body">操作long类型加了volatile就线程安全了？前面说了volatile不能保证原子性，后面就说long类型的赋值分两步，加了volatile就成了synchronized了，矛盾啊</li>
        <li class="recent_comment_author">--大金镯子</li>
        <li class="recent_comment_title"><a href="https://www.cnblogs.com/Mainz/p/3546347.html#4063073">2. Re:非阻塞同步算法与CAS(Compare and Swap)无锁算法</a></li>
        <li class="recent_comment_body">条理清楚,逻辑明白,赞一个!<br>楼主辛苦</li>
        <li class="recent_comment_author">--胡六一</li>
        <li class="recent_comment_title"><a href="https://www.cnblogs.com/Mainz/archive/2012/08/04/2622935.html#4017982">3. Re:不用Log4net用并发队列ConcurrentQueue自己实现写日志的组件(C#)</a></li>
        <li class="recent_comment_body">比较麻烦的 还得去监听</li>
        <li class="recent_comment_author">--_York</li>
        <li class="recent_comment_title"><a href="https://www.cnblogs.com/Mainz/p/3546347.html#4016709">4. Re:非阻塞同步算法与CAS(Compare and Swap)无锁算法</a></li>
        <li class="recent_comment_body">顶楼主，确实很有深度，想不请教一下楼主，这些知识是在哪块了解的呢？是哪本书吗</li>
        <li class="recent_comment_author">--吉林乌拉</li>
        <li class="recent_comment_title"><a href="https://www.cnblogs.com/Mainz/p/3546347.html#3955045">5. Re:非阻塞同步算法与CAS(Compare and Swap)无锁算法</a></li>
        <li class="recent_comment_body">Hi 博主。感谢分享。你在这篇文章提到给long类型加volatile就会线程安全，“因为volatile内部已经做了synchronized.”。不过你在另一篇文章“为什么volatile不能保证原......</li>
        <li class="recent_comment_author">--fpwang</li>
</ul>
</div>
</div>
</div></div><div id="sidebar_topviewedposts" class="sidebar-block"><div id="topview_posts_wrap">
<h3 class="catListTitle">阅读排行榜</h3>
<div class="RecentComment" id="TopViewPosts"> 
	<div id="TopViewPostsBlock"><ul><li><a href="https://www.cnblogs.com/Mainz/archive/2009/03/14/1411359.html">1. 实用正则表达式匹配和替换(98584)</a></li><li><a href="https://www.cnblogs.com/Mainz/archive/2009/04/28/Large_Website_Architecture.html">2. 大型网站系统架构分析(76099)</a></li><li><a href="https://www.cnblogs.com/Mainz/archive/2012/11/01/2749874.html">3. Spring MVC防御CSRF、XSS和SQL注入攻击(47997)</a></li><li><a href="https://www.cnblogs.com/Mainz/p/3546347.html">4. 非阻塞同步算法与CAS(Compare and Swap)无锁算法(39070)</a></li><li><a href="https://www.cnblogs.com/Mainz/p/3506956.html">5. jQuery ajax请求错误返回status 0和错误error的问题(21539)</a></li><li><a href="https://www.cnblogs.com/Mainz/archive/2009/06/28/CTO_Douban_Xiaonei_Renren_Website.html">6. CTO谈豆瓣网和校内网技术架构变迁(21344)</a></li><li><a href="https://www.cnblogs.com/Mainz/p/3556430.html">7. 为什么volatile不能保证原子性而Atomic可以？(20568)</a></li><li><a href="https://www.cnblogs.com/Mainz/archive/2012/08/04/2622858.html">8. Spring MVC+Freemarker+Javascript的多语言（国际化i18n/本地化）和主题（Theme）实现(16047)</a></li><li><a href="https://www.cnblogs.com/Mainz/archive/2007/12/15/996082.html">9. 架构设计之性能设计经验(15495)</a></li><li><a href="https://www.cnblogs.com/Mainz/p/3230077.html">10. 关于Spring Security中无Session和无状态stateless(14816)</a></li></ul></div>
</div>
</div></div></div><script type="text/javascript">loadBlogSideColumn();</script>
		
<div id="footer">
	Powered by: 
	<br>
	<a id="Footer1_Hyperlink3" href="https://www.cnblogs.com/" style="font-family:Verdana;font-size:12px;">博客园</a>
	<br>
	Copyright © Mainz
</div>
	
</div>			
			
	


<!--PageEndHtml Block Begin-->
<script language="javascript">
$.fn.followTo = function ( pos ) {
    var $this = this,
        $window = $('window');

    $window.scroll(function(e){
        if ($window.scrollTop() > pos) {
            $this.css({
                position: 'absolute',
                top: pos
            });
        } else {
            $this.css({
                position: 'fixed',
                top: 0
            });
        }
    });
};
$(document).ready(function(){
$('#header').followTo(250);
$('#rightmenu h3:first').remove();
$('#rightmenu ul:first').remove();
$('#rightmenu h3:first').remove();
});
</script>
<!--<script type="text/javascript" src="https://files.cnblogs.com/lloydsheng/lighter.js"></script>
<script type="text/javascript">
$("#styles li").click(function(){ 
    var style = $(this).attr("id"); 
    if( style == "default")
	   $("#header h1").css("background-color","#6994B0");
	else if ( style == "gray")
	   $("#header h1").css("background-color","#545867 ");
	else if ( style == "dark_blue")
	  $("#header h1").css("background-color","#10577D");
	else if ( style == "light_blue")
	  $("#header h1").css("background-color","#578AA6");
	else if ( style == "black")
	  $("#header h1").css("background-color","#030303");
	else if ( style == "red")
	  $("#header h1").css("background-color","#B02121");
	else if ( style == "dark_green")
	  $("#header h1").css("background-color","#6A946C");
	else if ( style == "grass_green")
	  $("#header h1").css("background-color","#81922A");
	else
	  $("#header h1").css("background-color","#6994B0");
    setCookie('m_cur_theme',style);
}); 
dp.SyntaxHighlighter.HighlightAll('code');
</script>
<script language="javascript">
$(document).ready(function(){
   /* $("body").prepend($("#div_digg").css({
        "position" : "fixed", "right" : "40px", "bottom" : "10px", "z-index" : "10", "background-color" : "transparent", "margin" : "10px", "padding" : "10px", "border" : "1px dashed silver"}));*/
   addSilverlightTag();
});
</script>
<script type="text/javascript" src="https://files.cnblogs.com/Mainz/jquery.lazyload.js"></script>-->
<!--PageEndHtml Block End-->


<script type="text/javascript">
var ifr = '<ifra';
ifr += 'me width="300" height="800" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=300&height=800&fansRow=5&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1681108882&verifier=03e36e47"></ifr';
ifr += 'ame>';
var th = document.getElementById('s_weibo');
if(th) th.innerHTML = ifr;
</script><script type="text/javascript">
function checkModile(){
  return $("#header").width() < 1024;
}
function checkShowPanel(){
if(window.location.href.toLowerCase()=="http://mainz.cnblogs.com/" || window.location.href.toLowerCase()=="http://www.cnblogs.com/mainz/" || window.location.href.toLowerCase().indexOf("/tag/")>0){
  return true;}else{return false;}
}
function scrolltop(){
$("#Form1").append("<div id='gototop' ><a href='#' class='scrollTTop' title='回到顶部'><img style='border:0 none;cursor:pointer;width:25px;height:25px;' src='https://images.cnblogs.com/cnblogs_com/Mainz/299977/o_ui.totop.png' alt='回到顶部' /></a></div>");
  $('a.scrollTTop').click(function(){
    $('html, body').animate({scrollTop:0}, 'slow');
    return false;
 });
  $('#gototop a img').hover(
    function() {$(this).fadeTo("fast", 0.5);},
    function() {$(this).fadeTo("fast", 1);
 });
}
function fixTagPage(){
if(window.location.href.toLowerCase().indexOf("/tag/")>0){$("#myposts .PostList .postTitl2 span").remove();$(".PostList").css("font-size","14px");$(".PostList").css("font-weight","normal");$(".PostList").css("margin-top","20px");$(".PostList").css("border","0 none");}
}
function scrolltocmt(){
$("#Form1").append("<div id='gotocomments' ><a href='javascript:void(0)' onclick='document.getElementById(\"commentform_title\").scrollIntoView();' title='发表评论'><img style='border:0 none;cursor:pointer;' src='https://images.cnblogs.com/cnblogs_com/Mainz/299977/o_edi2t.png' alt='发表评论' /></a></div>");
  $('#gotocomments a img').hover(
    function() {$(this).fadeTo("fast", 0.5);},
    function() {$(this).fadeTo("fast", 1);
 });}
function scrolltosearch(){
$("#Form1").append("<div id='gotosearch' ><a href='http://zzk.cnblogs.com/so.aspx?w=blog%3AMainz+memory&t=' title='搜索Mainz的博客'><img style='border:0 none;cursor:pointer;width:25px;height:25px;' src='https://images.cnblogs.com/cnblogs_com/Mainz/299977/o_search%20%282%29.png' alt='搜索Mainz的博客' /></a></div>");
  $('#gotosearch a img').hover(
    function() {$(this).fadeTo("fast", 0.5);},
    function() {$(this).fadeTo("fast", 1);
 });}
function addSilverlightTag(){
if($("#EntryTag a:first").html()=="Silverlight"){
 $("#Form1").append("<div id='moretag' style='display:none'><a href='http://www.cnblogs.com/mainz/tag/Silverlight/' title='Silverlight系列更多文章....'><img style='border:0 none;cursor:pointer;' src='https://images.cnblogs.com/cnblogs_com/Mainz/299977/o_2011-07-02-10h59_44.png' alt='Silverlight系列更多文章....' /></a></div>");
 $("body").prepend($("#moretag").css({"position" : "fixed", "left" : "0px", "top" : "300px", "z-index" : "10"}));
   $('#moretag').fadeTo("slow", 0.3);
   $('#moretag a img').hover(
    function() {$(this).fadeTo("fast", 0.5);},
    function() {$(this).fadeTo("fast", 1);
 });
}}
function hideAd(){
$("#commentform_title .ad_commentbox_up").remove();
$(".c_ad_block").remove();
$("#kb_block").remove();
$("#clear_reader_link").remove();
}
function changeCommentUI(){
$("#commentform_title").html("说几句:");
$("#ctl04_tbCommentAuthor").parents("p").remove();
$("#ctl04_tbCommentAuthorUrl").parents("p").remove();
$("a[id^=Comments1_CommentList_NameLink_]").css("font-size","12px");
$("a[id^=Comments1_CommentList_NameLink_]").css("color","#08c");
}
function slide(){
  $("#hidarea").slideDown("slow",function(){
      $("#hidtags").slideDown("slow",function(){$("#about_body").slideDown("slow",function(){$(".box embed").css("height","500px");});});
  });
}
function noslide(){
$("#hidarea").show("fast");
$("#hidtags").show("fast");
$("#about_body").show("fast");
}
function expd(){
  $("#main").css("right","330px");
  $("#rightmenu").show("slow");
  $("#cbtn").fadeOut("slow");
  scroll(0,0);
  slide();
}

function setCookie ( name, value )
{
expires = new Date();
expires.setTime(expires.getTime() + (1000 * 86400 * 365));
document.cookie = name + "=" + escape(value) + "; expires=" + expires.toGMTString() + "; path=/";
} 
function getCookie ( name )
{
cookie_name = name + "=";
cookie_length = document.cookie.length;
cookie_begin = 0;
while (cookie_begin < cookie_length)
{
value_begin = cookie_begin + cookie_name.length;
if (document.cookie.substring(cookie_begin, value_begin) == cookie_name)
{
var value_end = document.cookie.indexOf ( ";", value_begin);
if (value_end == -1)
{
value_end = cookie_length;
}
return unescape(document.cookie.substring(value_begin, value_end));
}
cookie_begin = document.cookie.indexOf ( " ", cookie_begin) + 1;
if (cookie_begin == 0)
{
break;
}
}
return null;
} 
function setThemeByCookie(){
var style =getCookie('m_cur_theme');
if(style==null) return;
if ( style == "gray")
	   $("#header h1").css("background-color","#545867 ");
	else if ( style == "dark_blue")
	  $("#header h1").css("background-color","#10577D");
	else if ( style == "light_blue")
	  $("#header h1").css("background-color","#578AA6");
	else if ( style == "black")
	  $("#header h1").css("background-color","#030303");
	else if ( style == "red")
	  $("#header h1").css("background-color","#B02121");
	else if ( style == "dark_green")
	  $("#header h1").css("background-color","#6A946C");
	else if ( style == "grass_green")
	  $("#header h1").css("background-color","#81922A");
	else
	  $("#header h1").css("background-color","transparent");
}
function colla(){
  $("#main").css("right","10px");
  $("#rightmenu").hide("fast");
  $("#Form1").append("<div id='cbtn' style='display:none'><a href='javascript:void(0)' onclick='expd()' title='显示侧边栏'><img style='border:0 none;cursor:pointer;' src='https://images.cnblogs.com/cnblogs_com/Mainz/299977/o_1309588058_Arrow-Right.png' alt='显示侧边栏' /></a></div>");$("#cbtn").fadeIn("slow");
 $('#cbtn img').hover(
    function() {$(this).fadeTo("fast", 0.5);},
    function() {$(this).fadeTo("fast", 1);
 });
}

function adjustManagmentBar(){$("#rightmenu h3:contains('统计')").before($("#rightmenu h3:contains('导航'),#rightmenu h3:contains('导航') + ul") );$("#rightmenu h3:contains('公告')").replaceWith("<h3>关于博主</h3>"); }
 $(document).ready(function() {

$("#tagline").before('<ul id="custom_nav"><li><a href="http://www.cnblogs.com/Mainz/">list</a></li><li><a href="http://www.cnblogs.com/Mainz/archive/2008/02/21/1076178.html"> about</a></li><li><a href="http://space.cnblogs.com/msg/send/Mainz">contact</a></li></ul>').slideDown("slow");
  if(checkModile()){colla();}
  setThemeByCookie();
 fixTagPage();adjustManagmentBar();
 if ($.browser.msie) { if ($.browser.version == "6.0") {$("#main").html("<h1 style='font-size:16px;'>亲爱的骨灰级IE6用户：请安装最新版Chrome或Firefox浏览本博客，谢谢！ <br><br>珍惜生命，远离IE6.... 你应该懂的</h1>");$("#rightmenu").html("");return;} }
 
 $("#rightmenu ul:first li").css("float","left");
  $("#rightmenu ul:first li").css("margin-right","10px");
  $("#rightmenu h3:eq(1)").css("clear","left");
  $("#rightmenu h3:eq(1)").css("padding-top","20px");
 $('#lks a img').hover(
    function() {$(this).fadeTo("fast", 0.5);},
    function() {$(this).fadeTo("fast", 1);
 });
 scrolltop();scrolltosearch();
if($("#comments").length > 0){	
 //---replace comments count----			
var ct = $("p.postfoot a:contains('评论')").html();
var tct = null;
if (tct  = ct.match(/(\d+)[^\d]*$/))
    $("#comments a h3").html('<span style="font-size:28px;font-family:georgia,\'Helvetica Neue\',Arial,\'Liberation Sans\',FreeSans,sans-serif;">'+tct[1].toString()+"</span>"+" 条评论");
//---end of replace comments count----	
  /*Put datatime of comment item to float right*/
 $("#comments h4 span:has(span.comment_date)").css("float","right");	
 /*Handle comment item of action links*/
$("#comments a:contains('回复')").css("float","right");	
$("#comments a:contains('回复')").css("margin","0 5px");	
$("#comments a:contains('引用')").css("float","right");	
$("#comments a:contains('引用')").css("margin","0 5px");	
$("#comments a:contains('查看')").css("float","right");	
$("#comments a:contains('查看')").css("margin","0 5px");		
/*End of Handle comment item of action links*/
}
 if(checkShowPanel()==false){/*expd();colla();slide();*/noslide();hideAd();changeCommentUI();scrolltocmt();$("#hidtags h3").css("padding-top","0");}else{noslide();/*slide();*/} });

</script><script type="text/javascript">
eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('(5($){$.J.L=5(r){8 1={d:0,A:0,b:"h",v:"N",3:4};6(r){$.D(1,r)}8 m=9;6("h"==1.b){$(1.3).p("h",5(b){8 C=0;m.t(5(){6(!$.k(9,1)&&!$.l(9,1)){$(9).z("o")}j{6(C++>1.A){g B}}});8 w=$.M(m,5(f){g!f.e});m=$(w)})}g 9.t(5(){8 2=9;$(2).c("s",$(2).c("i"));6("h"!=1.b||$.k(2,1)||$.l(2,1)){6(1.u){$(2).c("i",1.u)}j{$(2).K("i")}2.e=B}j{2.e=x}$(2).T("o",5(){6(!9.e){$("<V ></V>").p("X",5(){$(2).Y().c("i",$(2).c("s"))[1.v](1.Z);2.e=x}).c("i",$(2).c("s"))}});6("h"!=1.b){$(2).p(1.b,5(b){6(!2.e){$(2).z("o")}})}})};$.k=5(f,1){6(1.3===E||1.3===4){8 7=$(4).F()+$(4).O()}j{8 7=$(1.3).n().G+$(1.3).F()}g 7<=$(f).n().G-1.d};$.l=5(f,1){6(1.3===E||1.3===4){8 7=$(4).I()+$(4).U()}j{8 7=$(1.3).n().q+$(1.3).I()}g 7<=$(f).n().q-1.d};$.D($.P[\':\'],{"Q-H-7":"$.k(a, {d : 0, 3: 4})","R-H-7":"!$.k(a, {d : 0, 3: 4})","S-y-7":"$.l(a, {d : 0, 3: 4})","q-y-7":"!$.l(a, {d : 0, 3: 4})"})})(W);',62,62,'|settings|self|container|window|function|if|fold|var|this||event|attr|threshold|loaded|element|return|scroll|src|else|belowthefold|rightoffold|elements|offset|appear|bind|left|options|original|each|placeholder|effect|temp|true|of|trigger|failurelimit|false|counter|extend|undefined|height|top|the|width|fn|removeAttr|lazyload|grep|show|scrollTop|expr|below|above|right|one|scrollLeft|img|jQuery|load|hide|effectspeed'.split('|'),0,{}))

$(function() {
$("#waterfall img").lazyload({
   effect : "fadeIn",failurelimit:10,placeholder:"http://images.cnblogs.com/cnblogs_com/Mainz/125668/o_loading1.gif"
});
});
</script><div id="yhqhadin" style="display:none;"></div></body></html>